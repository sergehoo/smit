{% load static %}
{% load unicorn %}

<!DOCTYPE html>
<html lang="fr-FR" class="js" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="author" content="SMIT-CI">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description"
        content="Lyne, système de gestion des hôpitaux pour une gestion efficace des ressources hospitalières.">
  <meta name="keywords"
        content="Lyne, SIH, gestion des hôpitaux, santé, Afriq Consulting, hospital management, ressources hospitalières">
  <meta name="robots" content="index, follow">
  <meta name="theme-color" content="#0ea5e9">
  <meta property="og:title" content="Lyne - SIH | Systeme d'Information Hospitalier">
  <meta property="og:description"
        content="Système complet pour la gestion des ressources hospitalières, conçu pour simplifier les opérations de santé.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://sihci.com">
  <meta property="og:image" content="{% static 'images/lyne_hospital.png' %}">
  <meta property="og:locale" content="fr_FR">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Lyne - SIH | Hospital Resources Management">
  <meta name="twitter:description"
        content="Optimisez la gestion des ressources hospitalières avec Lyne, développé par Afriq Consulting.">
  <meta name="twitter:image" content="{% static 'images/lyne_hospital.png' %}">

  <link rel="shortcut icon" href="{% static 'images/favicon.png' %}">
  <title>SMIT | Lyne - Hospital Management System</title>

  <!-- Inter (premium rendering) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Styles de base -->
  <link href="{% static 'fontawesomefree/css/fontawesome.css' %}" rel="stylesheet">
  <link href="{% static 'fontawesomefree/css/brands.css' %}" rel="stylesheet">
  <link href="{% static 'fontawesomefree/css/solid.css' %}" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'assets/css/dashlite.css' %}">
  <link id="skin-default" rel="stylesheet" href="{% static 'assets/css/theme.css' %}">

  <!-- Bibliothèques JS -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" defer></script>
  <script src="{% static 'tinymce/tinymce.min.js' %}"></script>

  <!-- Alpine (si tu l’utilises ailleurs) -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <style>
    /* ===========================
       DESIGN SYSTEM (Premium)
    ============================ */
    :root{
      /* Brand medical palette (harmonisée) */
      --primary: #0ea5e9;            /* sky-500 */
      --primary-600: #0284c7;        /* sky-600 */
      --primary-700: #0369a1;        /* sky-700 */
      --teal: #14b8a6;               /* teal-500 */
      --success: #22c55e;            /* green-500 */
      --warning: #f59e0b;            /* amber-500 */
      --danger: #ef4444;             /* red-500 */
      --purple: #8b5cf6;             /* violet-500 */

      /* Light surfaces */
      --bg: #f6f8fc;
      --bg-2: #eef2f7;
      --surface: #ffffff;
      --surface-2: #f8fafc;
      --text: #0f172a;
      --text-2: #334155;
      --muted: #64748b;
      --border: rgba(15, 23, 42, .10);

      /* Effects */
      --ring: 0 0 0 4px rgba(14,165,233,.18);
      --shadow-soft: 0 10px 24px rgba(2,132,199,.12);
      --shadow-med: 0 16px 48px rgba(2,132,199,.18);
      --shadow-dark: 0 18px 60px rgba(0,0,0,.18);

      /* Layout */
      --sidebar-w: 280px;
      --header-h: 72px;

      /* Radius */
      --r12: 12px;
      --r16: 16px;
      --r18: 18px;

      /* Motion */
      --ease: cubic-bezier(.2,.8,.2,1);
      --t-fast: .18s;
      --t: .28s;
    }

    /* Dark theme overrides */
    html[data-theme="dark"]{
      --bg: #0b1220;
      --bg-2: #0f172a;
      --surface: #0f172a;
      --surface-2: #121a2b;
      --text: #e5e7eb;
      --text-2: #cbd5e1;
      --muted: #94a3b8;
      --border: rgba(148,163,184,.18);

      --shadow-soft: 0 10px 24px rgba(0,0,0,.30);
      --shadow-med: 0 18px 60px rgba(0,0,0,.38);
    }

    /* Respect accessibilité */
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; scroll-behavior: auto !important; }
    }

    /* Base */
    .nk-body{
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 12% 0%, rgba(14,165,233,.12), transparent 60%),
        linear-gradient(135deg, var(--bg) 0%, var(--bg-2) 100%);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    html[data-theme="dark"] .nk-body{
      background:
        radial-gradient(1100px 520px at 10% 0%, rgba(14,165,233,.14), transparent 60%),
        linear-gradient(135deg, var(--bg) 0%, var(--bg-2) 100%);
    }

    ::selection{ background: rgba(14,165,233,.22); }
    a, button{ -webkit-tap-highlight-color: transparent; }
    :focus-visible{ outline: none; box-shadow: var(--ring); border-radius: 10px; }

    /* Scrollbar */
    ::-webkit-scrollbar{ width: 8px; }
    ::-webkit-scrollbar-track{ background: rgba(148,163,184,.18); border-radius: 10px; }
    ::-webkit-scrollbar-thumb{
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-700) 100%);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover{
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
    }

    /* ===========================
       LOADER (Premium)
    ============================ */
    .app-loader{
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      transition: opacity .35s var(--ease), transform .35s var(--ease);
    }
    html[data-theme="dark"] .app-loader{
      background: rgba(9,14,25,.82);
    }
    .app-loader.is-hidden{
      opacity: 0;
      transform: translateY(-6px);
      pointer-events: none;
    }
    .app-loader__card{
      width: min(560px, 92vw);
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(2,132,199,.12);
      box-shadow: var(--shadow-med);
      border-radius: var(--r18);
      padding: 18px;
      display: flex;
      align-items: center;
      gap: 14px;
    }
    html[data-theme="dark"] .app-loader__card{
      background: rgba(15,23,42,.65);
      border: 1px solid rgba(148,163,184,.16);
    }
    .app-loader__spinner{
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: 4px solid rgba(14,165,233,.18);
      border-top-color: rgba(14,165,233,1);
      animation: spin .9s linear infinite;
    }
    .app-loader__title{
      font-weight: 900;
      letter-spacing: .6px;
      font-size: 1.05rem;
      background: linear-gradient(135deg, var(--primary), var(--primary-700));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      line-height: 1.1;
    }
    .app-loader__subtitle{
      margin-top: 2px;
      color: var(--muted);
      font-weight: 600;
      font-size: .92rem;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* ===========================
       HEADER (Stable + Premium)
    ============================ */
    .nk-header{
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-700) 100%);
      border: none;
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(10px);
      transition: box-shadow var(--t) var(--ease);
      will-change: box-shadow;
      transform: none !important; /* évite le jitter */
    }
    .nk-header.scrolled{
      box-shadow: var(--shadow-med);
    }

    .logo-container{
      background: rgba(255,255,255,.14);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(255,255,255,.22);
      transition: transform var(--t) var(--ease), background var(--t) var(--ease), box-shadow var(--t) var(--ease);
      backdrop-filter: blur(10px);
    }
    .logo-container:hover{
      background: rgba(255,255,255,.22);
      transform: translateY(-2px);
      box-shadow: 0 10px 28px rgba(255,255,255,.12);
    }
    .logo-img{ height: 42px; transition: transform var(--t) var(--ease); }

    .hospital-info{ text-align: center; margin-top: 1rem; }
    .hospital-name{
      font-weight: 800;
      font-size: 1.08rem;
      color: #0b5fff;
      margin-bottom: .25rem;
    }
    .department-name{
      font-size: .82rem;
      color: rgba(255,255,255,.92);
      line-height: 1.25;
    }
    .hospital-title{
      font-weight: 900;
      font-size: 1.22rem;
      background: linear-gradient(135deg, #ffffff 0%, #e0f2fe 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* ===========================
       SIDEBAR (Optimisée)
    ============================ */
    .nk-sidebar{
      background: linear-gradient(180deg, var(--surface) 0%, var(--surface-2) 100%);
      border-right: 1px solid var(--border);
      box-shadow: 4px 0 20px rgba(0,0,0,.06);
      will-change: transform;
    }
    html[data-theme="dark"] .nk-sidebar{
      background: linear-gradient(180deg, rgba(15,23,42,.92) 0%, rgba(18,26,43,.92) 100%);
      box-shadow: 4px 0 26px rgba(0,0,0,.34);
    }

    .nk-sidebar-head{
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-700) 100%);
      border-bottom: 1px solid rgba(255,255,255,.14);
      padding: 1.25rem 1rem;
    }

    .nk-menu-item{ margin: 4px 12px; }

    .nk-menu-link{
      border-radius: 12px;
      transition: transform var(--t) var(--ease), background var(--t) var(--ease), box-shadow var(--t) var(--ease), color var(--t-fast) var(--ease);
      border-left: 4px solid transparent;
      position: relative;
      overflow: hidden;
      padding: 6px 8px;
      margin: 4px 0;
      color: var(--text-2);
      display: flex;
      gap: 12px;
      align-items: center;
    }
    html[data-theme="dark"] .nk-menu-link{
      color: var(--text-2);
    }

    .nk-menu-link::before{
      content:'';
      position:absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(14,165,233,.10), transparent);
      transform: translateX(-100%);
      transition: transform .55s var(--ease);
    }
    .nk-menu-link:hover::before{ transform: translateX(100%); }

    .nk-menu-link:hover{
      background: rgba(14,165,233,.10);
      transform: translateX(8px);
      border-left-color: var(--primary);
      box-shadow: 0 8px 22px rgba(14,165,233,.12);
    }
    html[data-theme="dark"] .nk-menu-link:hover{
      background: rgba(14,165,233,.14);
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
    }

    /* Active state premium + très lisible */
    .nk-menu-link.active{
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-700) 100%);
      color: #1d7500 !important;
      box-shadow: 0 12px 32px rgba(2,132,199,.28);
      border-left-color: rgba(255,255,255,.85);
      transform: translateX(4px);
    }
    .nk-menu-link.active::before{ display:none; }

    /* Icon (custom medical-icon que tu utilisais) */
    .medical-icon{
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: transform var(--t) var(--ease), background var(--t) var(--ease), color var(--t) var(--ease);
      background: rgba(14,165,233,.12);
      color: var(--primary-700);
      flex: 0 0 auto;
    }
    html[data-theme="dark"] .medical-icon{
      background: rgba(14,165,233,.16);
      color: #e0f2fe;
    }
    .nk-menu-link:hover .medical-icon{
      background: var(--primary);
      color: #fff;
      transform: scale(1.05);
    }
    .nk-menu-link.active .medical-icon{
      background: rgba(255,255,255,.18);
      color: #1d7500;
      transform: scale(1.06);
    }

    /* Submenu optimized */
    .nk-menu-item.has-sub > .nk-menu-toggle{
      position: relative;
    }
    .nk-menu-item.has-sub > .nk-menu-sub{
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transform: translateY(-6px);
      transition: max-height .32s var(--ease), opacity .22s var(--ease), transform .32s var(--ease);
      will-change: max-height, opacity, transform;
      margin-left: 10px;
      padding-left: 10px;
      border-left: 1px dashed rgba(100,116,139,.35);
    }
    html[data-theme="dark"] .nk-menu-item.has-sub > .nk-menu-sub{
      border-left-color: rgba(148,163,184,.30);
    }

    .nk-menu-item.has-sub.open > .nk-menu-sub{
      max-height: 60vh; /* large enough */
      opacity: 1;
      transform: translateY(0);
    }

    /* Submenu links */
    .nk-menu-sub .nk-menu-link{
      padding: 10px 14px;
      border-left-width: 3px;
      transform: none !important; /* sub items keep stable */
    }

    /* ===========================
       CARDS / TABLES / FORMS (Premium)
    ============================ */
    .card-modern{
      background: var(--surface);
      border-radius: var(--r16);
      box-shadow: 0 6px 20px rgba(2, 8, 23, .06);
      border: 1px solid var(--border);
      transition: transform var(--t) var(--ease), box-shadow var(--t) var(--ease);
      overflow: hidden;
      position: relative;
      will-change: transform;
    }
    html[data-theme="dark"] .card-modern{
      box-shadow: 0 16px 48px rgba(0,0,0,.32);
    }

    .card-modern::before{
      content:'';
      position:absolute; top:0; left:0; right:0; height:4px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--teal) 100%);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform var(--t) var(--ease);
    }
    .card-modern:hover::before{ transform: scaleX(1); }
    .card-modern:hover{
      box-shadow: var(--shadow-soft);
      transform: translateY(-6px);
    }

    .card-header-modern{
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-700) 100%);
      color:#fff;
      border-radius: var(--r16) var(--r16) 0 0;
      padding: 1.15rem 1.5rem;
      border: none;
      position: relative;
      overflow: hidden;
    }
    .card-header-modern::after{
      content:'';
      position:absolute;
      top:0; right:0;
      width: 120px; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);
      transform: skewX(-20deg) translateX(120px);
      animation: shimmer 3s infinite;
    }
    @keyframes shimmer{
      0%{ transform: skewX(-20deg) translateX(-140px); }
      100%{ transform: skewX(-20deg) translateX(340px); }
    }

    .btn-modern{
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-700) 100%);
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 700;
      color: #fff;
      transition: transform var(--t) var(--ease), box-shadow var(--t) var(--ease);
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 22px rgba(2,132,199,.25);
    }
    .btn-modern:hover{
      transform: translateY(-2px);
      box-shadow: 0 16px 34px rgba(2,132,199,.30);
    }
    .btn-modern:active{ transform: translateY(-1px); }

    /* Badges */
    .badge-modern{
      padding: 6px 12px;
      border-radius: 999px;
      font-size: .75rem;
      font-weight: 800;
      letter-spacing: .5px;
      text-transform: uppercase;
      border: 1px solid transparent;
    }
    .badge-primary-modern{ background: rgba(14,165,233,.14); color: var(--primary-700); border-color: rgba(14,165,233,.28); }
    .badge-success-modern{ background: rgba(34,197,94,.14); color: #166534; border-color: rgba(34,197,94,.28); }
    .badge-warning-modern{ background: rgba(245,158,11,.14); color: #92400e; border-color: rgba(245,158,11,.28); }
    .badge-error-modern{ background: rgba(239,68,68,.14); color: #991b1b; border-color: rgba(239,68,68,.28); }
    html[data-theme="dark"] .badge-primary-modern{ color:#e0f2fe; }

    /* Tables */
    .table-modern{
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(2, 8, 23, .06);
      background: var(--surface);
      border: 1px solid var(--border);
    }
    .table-modern thead th{
      background: linear-gradient(135deg, rgba(14,165,233,.14) 0%, rgba(20,184,166,.10) 100%);
      color: var(--primary-700);
      font-weight: 800;
      border-bottom: 2px solid rgba(14,165,233,.30);
      padding: 16px 20px;
      font-size: .84rem;
      text-transform: uppercase;
      letter-spacing: .6px;
    }
    html[data-theme="dark"] .table-modern thead th{
      color: #e0f2fe;
      border-bottom-color: rgba(14,165,233,.22);
    }
    .table-modern tbody tr{
      transition: background var(--t-fast) var(--ease), transform var(--t-fast) var(--ease);
      border-bottom: 1px solid rgba(148,163,184,.20);
    }
    .table-modern tbody tr:hover{
      background: rgba(14,165,233,.08);
      transform: scale(1.006);
    }
    .table-modern tbody td{
      padding: 14px 20px;
      vertical-align: middle;
      color: var(--text-2);
    }
    html[data-theme="dark"] .table-modern tbody td{ color: var(--text-2); }

    /* Forms */
    .form-control-modern{
      border: 2px solid rgba(148,163,184,.35);
      border-radius: 10px;
      padding: 12px 16px;
      transition: box-shadow var(--t) var(--ease), border-color var(--t) var(--ease), transform var(--t) var(--ease);
      background: var(--surface);
      font-size: .95rem;
      color: var(--text);
    }
    html[data-theme="dark"] .form-control-modern{
      border-color: rgba(148,163,184,.26);
      background: rgba(18,26,43,.8);
    }
    .form-control-modern:focus{
      border-color: rgba(14,165,233,.75);
      box-shadow: var(--ring);
      outline: none;
      transform: translateY(-1px);
    }

    /* Footer */
    .nk-footer{
      background: linear-gradient(135deg, #0f172a 0%, #0b1220 100%);
      color: #cbd5e1;
      border-top: 1px solid rgba(148,163,184,.18);
      margin-top: auto;
    }
    .footer-content{
      background: rgba(255,255,255,.03);
      border-radius: 12px;
      padding: 2rem;
      margin: 1rem 0;
      border: 1px solid rgba(148,163,184,.14);
    }

    /* Responsive */
    @media (max-width: 768px){
      .nk-header{ padding: .75rem 0; }
      .logo-img{ height: 36px; }
      .hospital-title{ font-size: 1.08rem; }
      .nk-menu-link{ padding: 10px 14px; margin: 2px 0; }
      .medical-icon{ width: 40px; height: 40px; font-size: 16px; }
    }

    /* ===========================
       LAYOUT FIXES (Sidebar fixed + Header fixed)
    ============================ */
    .nk-sidebar.nk-sidebar-fixed{
      position: fixed;
      inset: 0 auto 0 0;
      width: var(--sidebar-w);
      z-index: 1030;
      transform: translateX(0);
      transition: transform var(--t) var(--ease);
      will-change: transform;
    }

    .nk-main{ margin-left: var(--sidebar-w); }

    .nk-wrap{ padding-top: var(--header-h); }

    .nk-header.nk-header-fixed{
      left: var(--sidebar-w);
      right: 0;
      width: auto;
    }

    @media (max-width: 1199.98px){
      .nk-sidebar.nk-sidebar-fixed{ transform: translateX(-100%); box-shadow: none; }
      .nk-sidebar.nk-sidebar-fixed.show{
        transform: translateX(0);
        box-shadow: 0 0 0 100vmax rgba(0,0,0,.35);
      }
      .nk-main{ margin-left: 0; }
      .nk-header.nk-header-fixed{ left: 0; }
    }

    .nk-sidebar-body[data-simplebar]{ height: 100vh; }
    body{ overflow-x: hidden; }
  </style>

  <!-- TinyMCE (init après DOM ready) -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (!window.tinymce) return;
      tinymce.init({
        selector: 'textarea',
        height: 400,
        plugins: [
          'advlist autolink lists link image charmap print preview anchor',
          'searchreplace visualblocks code fullscreen',
          'insertdatetime media table paste code help wordcount'
        ],
        toolbar: 'undo redo | formatselect | bold italic backcolor | ' +
          'alignleft aligncenter alignright alignjustify | ' +
          'bullist numlist outdent indent | removeformat | help',
        menubar: false,
        statusbar: false,
        content_style: `
          body {
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #334155;
          }
        `
      });
    });
  </script>

  {% unicorn_scripts %}
</head>

<body class="nk-body">
  <!-- Loader -->
  <div id="globalLoader" class="app-loader" aria-live="polite" aria-busy="true">
    <div class="app-loader__card">
      <div class="app-loader__spinner" aria-hidden="true"></div>
      <div class="app-loader__text">
        <div class="app-loader__title">Lyne</div>
        <div class="app-loader__subtitle">Chargement de l’application…</div>
      </div>
    </div>
  </div>

  <div class="nk-app-root">
    <div class="nk-main">
      <!-- Sidebar -->
      {% include "layout/aside.html" %}

      <!-- Contenu Principal -->
      <div class="nk-wrap">
        <!-- Header -->
        {% include 'layout/notif_header.html' %}

        <main class="mt-5">
          {% block content %}
          {% endblock %}
        </main>

        <!-- Footer -->
        <div class="nk-footer">
          <div class="container-fluid">
            <div class="footer-content">
              <div class="row align-items-center">
                <div class="col-lg-12 text-center text-lg-start mb-3 mb-lg-0">
                  <div class="nk-footer-copyright">
                    <span>© 2024 Lyne Hospital Management System</span>
                    <span class="mx-2" style="color: rgba(148,163,184,.7)">•</span>
                    <span>Développé par</span>
                    <a href="https://afriqconsulting.com" target="_blank"
                       style="color:#e0f2fe;font-weight:800;text-decoration:none;">
                      AFRIQ CONSULTING
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div><!-- .nk-footer -->
      </div><!-- .nk-wrap -->
    </div><!-- .nk-main -->
  </div><!-- .nk-app-root -->

  <!-- Scripts base -->
  <script src="{% static 'assets/js/bundle.js' %}"></script>
  <script src="{% static 'assets/js/scripts.js' %}"></script>

  <!-- (Optionnel) GSAP si tu l’utilises ailleurs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>

  <!-- HTMX + SweetAlert2 -->
  <script src="https://unpkg.com/htmx.org@1.9.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Toasts Django messages (optimisé) -->
  {% if messages %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const toasts = [
        {% for message in messages %}
        (function () {
          const icon =
            {% if "success" in message.tags %}'success'
            {% elif "warning" in message.tags %}'warning'
            {% elif "error" in message.tags %}'error'
            {% elif "info" in message.tags %}'info'
            {% else %}'info'{% endif %};

          const iconColor =
            {% if "success" in message.tags %}'#22c55e'
            {% elif "warning" in message.tags %}'#f59e0b'
            {% elif "error" in message.tags %}'#ef4444'
            {% else %}'#0ea5e9'{% endif %};

          return { icon, iconColor, title: '{{ message|escapejs }}' };
        })(),
        {% endfor %}
      ];

      const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 5000,
        timerProgressBar: true,
        background: (document.documentElement.dataset.theme === 'dark') ? '#0f172a' : '#ffffff',
        color: (document.documentElement.dataset.theme === 'dark') ? '#e5e7eb' : '#0f172a',
        customClass: { popup: 'rounded-xl' },
        didOpen: (toast) => {
          toast.addEventListener('mouseenter', Swal.stopTimer);
          toast.addEventListener('mouseleave', Swal.resumeTimer);
        }
      });

      toasts.forEach(t => Toast.fire({ icon: t.icon, iconColor: t.iconColor, title: t.title }));
    });
  </script>
  {% endif %}

  <!-- intl-tel-input (styles) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css"/>

  <script>
    (function () {
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const root = document.documentElement;

      /* ===========================
         THEME (Light/Dark) - PRO
         - stocke dans localStorage
         - respecte préférence système si pas de choix
      ============================ */
      function getSystemTheme() {
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      function getSavedTheme() {
        return localStorage.getItem('lyne-theme');
      }

      function setTheme(theme) {
        root.dataset.theme = theme;
        localStorage.setItem('lyne-theme', theme);
        // Optionnel: mettre à jour theme-color
        const metaTheme = document.querySelector('meta[name="theme-color"]');
        if (metaTheme) metaTheme.setAttribute('content', theme === 'dark' ? '#0b1220' : '#0ea5e9');
      }

      // init theme
      const saved = getSavedTheme();
      setTheme(saved || getSystemTheme());

      // si l’utilisateur n’a pas choisi, on suit les changements système
      if (!saved && window.matchMedia) {
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        mq.addEventListener?.('change', () => setTheme(getSystemTheme()));
      }

      // bouton dark switch (si présent dans notif_header.html)
      // IMPORTANT: mets la classe "dark-switch" sur ton bouton
      document.addEventListener('DOMContentLoaded', () => {
        const darkSwitch = document.querySelector('.dark-switch');
        if (darkSwitch) {
          darkSwitch.addEventListener('click', () => {
            const next = (root.dataset.theme === 'dark') ? 'light' : 'dark';
            setTheme(next);
          });
        }
      });

      /* ===========================
         LOADER - fade out clean
      ============================ */
      function hideLoader() {
        const loader = document.getElementById('globalLoader');
        if (!loader) return;
        loader.classList.add('is-hidden');
        loader.setAttribute('aria-busy', 'false');
        setTimeout(() => loader.remove(), 450);
      }

      /* ===========================
         HEADER - stable (no translateY)
      ============================ */
      function setupHeaderScroll() {
        const header = document.querySelector('.nk-header');
        if (!header) return;

        let ticking = false;
        const onScroll = () => {
          if (ticking) return;
          ticking = true;
          requestAnimationFrame(() => {
            header.classList.toggle('scrolled', window.scrollY > 10);
            ticking = false;
          });
        };
        window.addEventListener('scroll', onScroll, { passive: true });
        onScroll();
      }

      /* ===========================
         REVEAL (cards/tables) - IntersectionObserver
      ============================ */
      function setupReveal() {
        const els = document.querySelectorAll('.card-modern, .table-modern');
        if (!els.length) return;

        els.forEach(el => {
          el.style.opacity = '0';
          el.style.transform = 'translateY(14px)';
          el.style.transition = prefersReduced ? 'none' : 'opacity .55s ease, transform .55s ease';
        });

        if (!('IntersectionObserver' in window) || prefersReduced) {
          els.forEach(el => { el.style.opacity = '1'; el.style.transform = 'translateY(0)'; });
          return;
        }

        const io = new IntersectionObserver(entries => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const el = entry.target;
              el.style.opacity = '1';
              el.style.transform = 'translateY(0)';
              io.unobserve(el);
            }
          });
        }, { threshold: 0.08 });

        els.forEach(el => io.observe(el));
      }

      /* ===========================
         SIDEBAR MOBILE TOGGLE + BACKDROP CLOSE
      ============================ */
      function setupSidebarToggle() {
        const sidebar = document.querySelector('.nk-sidebar.nk-sidebar-fixed');
        const toggles = document.querySelectorAll('[data-target="sidebarMenu"]');
        if (!sidebar || !toggles.length) return;

        toggles.forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            sidebar.classList.toggle('show');
          });
        });

        document.addEventListener('click', (e) => {
          const isDesktop = matchMedia('(min-width: 1200px)').matches;
          if (isDesktop) return;
          const insideSidebar = e.target.closest('.nk-sidebar');
          const onToggle = e.target.closest('[data-target="sidebarMenu"]');
          if (sidebar.classList.contains('show') && !insideSidebar && !onToggle) {
            sidebar.classList.remove('show');
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') sidebar.classList.remove('show');
        });
      }

      /* ===========================
         MENU ACTIVE + SUBMENU (Premium)
         - active: match pathname
         - auto-open parent submenu if a child is active
         - toggle: one open at a time (optionnel)
      ============================ */
      function setupMenu() {
        const currentPath = window.location.pathname;
        const links = document.querySelectorAll('.nk-menu-link[href]');

        let activeLink = null;
        links.forEach(link => {
          const href = link.getAttribute('href');
          if (!href || href === '#') return;

          // match exact OR prefix (si tu veux): currentPath.startsWith(href)
          if (href === currentPath) activeLink = link;
        });

        if (activeLink) {
          activeLink.classList.add('active');
          // open parents
          const parentHasSub = activeLink.closest('.nk-menu-item.has-sub');
          if (parentHasSub) parentHasSub.classList.add('open');
        }

        // Toggle submenus
        document.querySelectorAll('.nk-menu-toggle').forEach(toggle => {
          toggle.addEventListener('click', (e) => {
            e.preventDefault();
            const parent = toggle.closest('.nk-menu-item.has-sub');
            if (!parent) return;

            // close others (accordion)
            document.querySelectorAll('.nk-menu-item.has-sub.open').forEach(openItem => {
              if (openItem !== parent) openItem.classList.remove('open');
            });

            parent.classList.toggle('open');
          });
        });
      }

      /* ===========================
         RIPPLE on .btn-modern (premium)
      ============================ */
      function setupRipple() {
        if (prefersReduced) return;

        document.addEventListener('click', (e) => {
          const btn = e.target.closest('.btn-modern');
          if (!btn) return;

          const ripple = document.createElement('span');
          const rect = btn.getBoundingClientRect();
          const size = Math.max(rect.width, rect.height);
          const x = e.clientX - rect.left - size / 2;
          const y = e.clientY - rect.top - size / 2;

          ripple.style.cssText = `
            position:absolute;border-radius:999px;
            background:rgba(255,255,255,.55);
            transform:scale(0);
            animation:ripple .55s linear;
            width:${size}px;height:${size}px;
            left:${x}px;top:${y}px;
            pointer-events:none;
          `;

          btn.style.position = 'relative';
          btn.style.overflow = 'hidden';
          btn.appendChild(ripple);
          setTimeout(() => ripple.remove(), 600);
        });

        const st = document.createElement('style');
        st.textContent = `@keyframes ripple{to{transform:scale(3.6);opacity:0}}`;
        document.head.appendChild(st);
      }

      /* ===========================
         IMG fallback
      ============================ */
      function setupImgFallback() {
        document.addEventListener('error', (e) => {
          if (e.target && e.target.tagName === 'IMG') {
            e.target.style.opacity = '0.65';
            e.target.alt = e.target.alt || 'Image non disponible';
          }
        }, true);
      }

      /* ===========================
         intl-tel-input (si présent)
      ============================ */
      function setupIntlTel() {
        const phoneInput = document.querySelector("#phone");
        if (phoneInput && window.intlTelInput) {
          window.intlTelInput(phoneInput, {
            nationalMode: true,
            initialCountry: "ci",
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
            preferredCountries: ['ci', 'fr', 'sn', 'ml', 'bf', 'ne', 'gn'],
            customContainer: "w-100",
            dropdownContainer: document.body
          });
          phoneInput.classList.add('form-control-modern');
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        hideLoader();
        setupHeaderScroll();
        setupReveal();
        setupSidebarToggle();
        setupMenu();
        setupRipple();
        setupImgFallback();
        setupIntlTel();
      });
    })();
  </script>
</body>
</html>