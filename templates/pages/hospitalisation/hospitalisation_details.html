{% extends 'layout/base.html' %}
{% load static %}
{% load humanize %}
{% load  custom_filter %}
{% block content %}
    <style>
        .uniform-btn {
            width: 100%;
            min-width: 100px; /* Définit une largeur minimale pour tous les boutons */
            text-align: left; /* Centre le texte dans les boutons */
            padding: 5px 5px; /* Uniformise le padding des boutons */
            font-size: 16px; /* Assure une taille de texte uniforme */
        }

        .patient-name h3 {
            word-wrap: break-word;
            white-space: normal;
            overflow-wrap: break-word;
            max-width: 100%; /* Empêche le débordement */
        }

        .custom-checkbox {
            width: 20px; /* Largeur du checkbox */
            height: 20px; /* Hauteur du checkbox */
            cursor: pointer; /* Curseur cliquable */
            transform: scale(1.5); /* Agrandit le checkbox */
            margin-right: 40px; /* Espacement avec le texte */
        }
    </style>
    <div class="nk-content nk-content-fluid">

        <div class="container-xl wide-lg">

            <div class="nk-content-body">

                <div class="nk-block-head nk-block-head-sm ">

                    <div class="row rounded card-bordered mt-5 p-3 d-flex align-items-center"
                         style="background-color: white; background-image: url('{% static 'images/hospitwalization.png' %}'); background-size: cover; background-position: center;">

                        <!-- Colonne : Informations du patient -->
                        <div class="col-lg-6 col-md-6 col-sm-6 d-flex flex-column justify-content-center">
                            <h3 class="nk-block-title page-title text-lg-right text-center text-dark">Détails
                                Hospitalisation Patient</h3>
                            <a href="{% url 'detail_patient' hospitalisationdetail.patient.pk %}" class="patient-name">
                                <h3 class="text-primary">{{ hospitalisationdetail.patient|upper }}</h3>
                            </a>
                            <h6>
                                Code Patient: <span
                                    class="text-danger">{{ hospitalisationdetail.patient.code_patient }}</span>
                                <br>
                                <a href="{% url 'detail_patient' hospitalisationdetail.patient.pk %}"
                                   class="text-primary mt-2">
                                    <em class="icon ni ni-folder-list"></em> Dossier Médical
                                </a>
                            </h6>

                            {% if hospitalisationdetail.discharge_date %}
                                <span class="h4 text-success" data-toggle="tooltip"
                                      title="{{ hospitalisationdetail.discharge_date }}">
                Patient sorti {{ hospitalisationdetail.discharge_date|naturaltime }}
            </span>
                            {% else %}
                                <ul class="nav m-0 p-0 text-end">
                                <li class="d-flex justify-content-between align-items-center">
                                    <a href="#" data-toggle="modal" data-target="#hospitalisationout"
                                       class="btn btn-outline-warning">
                                        <i class="fa-solid fa-sign-out"></i> Sortir ?
                                    </a></li>
                                <li class="d-flex justify-content-between align-items-center ml-5">
                                    <a href="#" data-toggle="modal" data-target="#hospitalisationtransfert"
                                       class="btn btn-outline-secondary">
                                        <i class="fa-solid fa-arrow-left-rotate"></i> Transferer
                                    </a></li>
                            {% endif %}
                        </div>

                        <!-- Colonne : QR Code Patient -->
                        <div class="col-lg-2 col-md-3 col-sm-6 d-flex justify-content-center">
                            <img class="img-fluid" src="{{ hospitalisationdetail.patient.qr_code.url }}" height="140"
                                 alt="QR Code Patient">
                        </div>

                        <!-- Colonne : Informations hospitalisation -->
                        <div class="col-lg-2 col-md-6 col-sm-6">
                            <blockquote class="blockquote text-start">
                                <p class="mb-0">Admis le :</p>
                                <strong class="text-primary">{{ hospitalisationdetail.created_at }}</strong>
                                <footer class="blockquote-footer">{{ hospitalisationdetail.reason_for_admission }}</footer>

                                {% if hospitalisationdetail.discharge_date %}
                                    <p class="mb-0 mt-3">Sortie le :</p>
                                    <strong class="text-primary">{{ hospitalisationdetail.discharge_date }}</strong>
                                    <footer class="blockquote-footer">
                                        <span class="badge badge-secondary">{{ hospitalisationdetail.status }}</span><br>
                                        {{ hospitalisationdetail.discharge_reason }}
                                    </footer>
                                {% endif %}
                            </blockquote>
                        </div>

                        <!-- Colonne : Image animée -->
                        <div class="col-lg-2 col-md-3 col-sm-6 d-flex justify-content-center">
                            {% if not hospitalisationdetail.discharge_date %}
                                <ul class="nav m-0 p-0 text-end">
                                <li class="d-flex justify-content-between align-items-center">
                                    <img src="{% static 'images/hospitalization-2.gif' %}" class="img-fluid"
                                         height="140" alt="Hospitalization Image">
                                </li>
                                <li class="d-flex justify-content-between align-items-center">
                                    <span>{{ hospitalisationdetail.bed }}</span></li>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row pl-4 pb-4">
                        <div class="mt-2 col-md-12 text-end">
                            <ul class="nav m-0 p-0 text-end">

                                {% if observations %}
                                    <li class="d-flex justify-content-between align-items-center">
                                        <button class="btn btn-outline-primary uniform-btn" data-toggle="modal"
                                                data-target="#observationsModal">
                                            <em class="icon ni ni-eye"></em> Observations<span
                                                class="badge badge-info ml-1">{{ observationscount }}</span>
                                        </button>
                                    </li>

                                {% endif %}
                                <div class="modal fade" id="observationsModal" tabindex="-1"
                                     aria-labelledby="observationsModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="observationsModalLabel">Observations pour
                                                    l'Hospitalisation</h5>
                                                <button type="button" class="btn btn-outline-secondary"
                                                        data-bs-dismiss="modal" aria-label="Close"><em
                                                        class="icon ni ni-close"></em></button>
                                            </div>
                                            <div class="modal-body">
                                                {% if observations %}
                                                    <ul class="list-group">
                                                        {% for observation in observations %}
                                                            <li class="list-group-item">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <div>
                                                                        <h6 class="mb-1">
                                                                            <strong>{{ observation.date_enregistrement|naturaltime }}</strong>
                                                                            -
                                                                            <span class="badge badge-info text-dark">{{ observation.statut }}</span>
                                                                        </h6>
                                                                        <div class="mb-1">{{ observation.details|safe }}</div>
                                                                        <small class="text-muted">Enregistré par
                                                                            : {{ observation.medecin.get_full_name|default:"Non spécifié" }}</small>
                                                                    </div>
                                                                    <div>
                                                                        {% if observation.medecin == request.user %}
                                                                            <!-- Button to delete observation -->
                                                                            <form method="post"
                                                                                  action=""
                                                                                  style="display:inline;">
                                                                                {% csrf_token %}
                                                                                <button type="submit"
                                                                                        class="btn btn-danger btn-sm"
                                                                                        onclick="return confirm('Voulez-vous vraiment supprimer cette observation ?')">
                                                                                    Supprimer
                                                                                </button>
                                                                            </form>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            </li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <div class="alert alert-info text-center">
                                                        Aucune observation enregistrée pour cette hospitalisation.
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    Fermer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {% if historiques_maladie %}

                                    <li class="d-flex justify-content-between align-items-center mt-3">
                                        <button class="btn btn-outline-primary ml-2 uniform-btn" data-toggle="modal"
                                                data-target="#historiqueModal">
                                            <em class="icon ni ni-book"></em>Histoire Maladie<span
                                                class="badge badge-info ml-1">{{ effets_indesirablescount }}</span>
                                        </button>
                                    </li>

                                {% endif %}
                                <!-- Modal Historique -->
                                <div class="modal fade" id="historiqueModal" tabindex="-1"
                                     aria-labelledby="historiqueModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="historiqueModalLabel">Historique de la
                                                    Maladie</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                {% if historiques_maladie %}
                                                    <ul class="list-group">
                                                        {% for historique in historiques_maladie %}
                                                            <li class="list-group-item">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <div>
                                                                        <h6 class="mb-1">
                                                                            <strong>{{ historique.date_enregistrement|date:"d/m/Y H:i" }}</strong>
                                                                            -
                                                                            <span class="badge bg-info text-dark">Par {{ historique.medecin.get_full_name|default:"Médecin inconnu" }}</span>
                                                                        </h6>
                                                                        <p class="mb-1">
                                                                            <strong>Details
                                                                                :</strong>
                                                                        </p>
                                                                        {{ historique.description|safe }}


                                                                    </div>
                                                                    <div>
                                                                        {% if historique.medecin == request.user %}
                                                                            <!-- Button to delete historique -->
                                                                            <form method="post" action=""
                                                                                  style="display:inline;">
                                                                                {% csrf_token %}
                                                                                <button type="submit"
                                                                                        class="btn btn-danger btn-sm"
                                                                                        onclick="return confirm('Voulez-vous vraiment supprimer cet historique ?')">
                                                                                    Supprimer
                                                                                </button>
                                                                            </form>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            </li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <div class="alert alert-info text-center">
                                                        Aucun historique enregistré pour cette hospitalisation.
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    Fermer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Button to Trigger Modal -->
                                {% if diagnostics %}

                                    <li class="d-flex justify-content-between align-items-center mt-3">
                                        <button class="btn btn-outline-primary ml-2 uniform-btn" data-toggle="modal"
                                                data-target="#diagnosticModal">
                                            <em class="icon ni ni-list"></em> Diagnostics<span
                                                class="badge badge-info ml-1">{{ diagnosticscount }}</span>
                                        </button>
                                    </li>{% endif %}
                                <!-- Modal Diagnostics -->
                                <div class="modal fade" id="diagnosticModal" tabindex="-1"
                                     aria-labelledby="diagnosticModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="diagnosticModalLabel">Diagnostics
                                                    Associés</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                {% if diagnostics %}
                                                    <ul class="list-group">
                                                        {% for diagnostic in diagnostics %}
                                                            <li class="list-group-item">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <div>
                                                                        <h6 class="mb-1">
                                                                            <strong>{{ diagnostic.date_diagnostic|naturaltime }}</strong>
                                                                            -
                                                                            <span class="badge bg-info text-dark">{{ diagnostic.get_type_diagnostic_display }}</span>
                                                                        </h6>
                                                                        <p class="mb-1">
                                                                            <strong>Maladie
                                                                                :</strong> {{ diagnostic.maladie }}
                                                                        </p>
                                                                        <p class="mb-1">
                                                                            <strong>Remarques
                                                                                :</strong> {{ diagnostic.remarques|safe|default:"Aucune remarque" }}
                                                                        </p>
                                                                        <p class="mb-1">
                                                                            <strong>Médecin
                                                                                :</strong> {{ diagnostic.medecin_responsable.get_full_name|default:"Inconnu" }}
                                                                        </p>
                                                                    </div>
                                                                    <div>
                                                                        {% if diagnostic.medecin_responsable == request.user %}
                                                                            <!-- Button to delete diagnostic -->
                                                                            <form method="post" action=""
                                                                                  style="display:inline;">
                                                                                {% csrf_token %}
                                                                                <button type="submit"
                                                                                        class="btn btn-danger btn-sm"
                                                                                        onclick="return confirm('Voulez-vous vraiment supprimer ce diagnostic ?')">
                                                                                    <em class="icon ni ni-trash"></em>
                                                                                </button>
                                                                            </form>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            </li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <div class="alert alert-info text-center">
                                                        Aucun diagnostic enregistré pour cette hospitalisation.
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    Fermer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {% if antecedents_par_type %}
                                    <li class="d-flex justify-content-between align-items-center mt-3">
                                        <button class="btn btn-outline-primary ml-2 uniform-btn" data-toggle="modal"
                                                data-target="#antecedentsViewModal">
                                            <em class="icon ni ni-list"></em> Antécédents
                                            <span class="badge badge-info ml-1">{{ antecedentscount }}</span>
                                        </button>
                                    </li>
                                {% endif %}

                                <!-- Modal Affichage des Antécédents -->
                                <div class="modal fade" id="antecedentsViewModal" tabindex="-1"
                                     aria-labelledby="antecedentsModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="antecedentsModalLabel">Antécédents
                                                    Médicaux</h5>
                                                <button type="button" class="btn-close" data-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                {% if antecedents_par_type %}
                                                    <div class="accordion" id="accordionAntecedents">
                                                        {% for type_nom, antecedents in antecedents_par_type.items %}
                                                            <div class="accordion-item">
                                                                <h2 class="accordion-header"
                                                                    id="heading{{ forloop.counter }}">
                                                                    <button class="accordion-button collapsed btn btn-outline-primary uniform-btn"
                                                                            type="button" data-toggle="collapse"
                                                                            data-target="#collapse{{ forloop.counter }}"
                                                                            aria-expanded="false"
                                                                            aria-controls="collapse{{ forloop.counter }}">
                                                                        {{ type_nom }} ({{ antecedents|length }})
                                                                    </button>
                                                                </h2>
                                                                <div id="collapse{{ forloop.counter }}"
                                                                     class="accordion-collapse collapse"
                                                                     aria-labelledby="heading{{ forloop.counter }}"
                                                                     data-parent="#accordionAntecedents">
                                                                    <div class="accordion-body">
                                                                        <ul class="list-group">
                                                                            {% for antecedent in antecedents %}
                                                                                <li class="list-group-item">
                                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                                        <div>
                                                                                            <h6 class="mb-1">
                                                                                                <strong>{{ antecedent.date_debut|default:"Date inconnue" }}</strong>
                                                                                                -
                                                                                                <span class="badge bg-info text-dark">{{ antecedent.nom }}</span>
                                                                                            </h6>
                                                                                            <p class="mb-1">
                                                                                                <strong>Description
                                                                                                    :</strong> {{ antecedent.descriptif|default:"Aucune description" }}
                                                                                            </p>
                                                                                        </div>
                                                                                        <div>
                                                                                            {% if request.user == antecedent.hospitalisation.medecin_responsable %}
                                                                                                <!-- Bouton Supprimer -->
                                                                                                <form method="post"
                                                                                                      action="{% url 'delete_antecedent' antecedent.id %}"
                                                                                                      style="display:inline;">
                                                                                                    {% csrf_token %}
                                                                                                    <button type="submit"
                                                                                                            class="btn btn-danger btn-sm"
                                                                                                            onclick="return confirm('Voulez-vous vraiment supprimer cet antécédent ?')">
                                                                                                        <em class="icon ni ni-trash"></em>
                                                                                                    </button>
                                                                                                </form>
                                                                                            {% endif %}
                                                                                        </div>
                                                                                    </div>
                                                                                </li>
                                                                            {% endfor %}
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <div class="alert alert-info text-center">
                                                        Aucun antécédent enregistré pour cette hospitalisation.
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    Fermer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {% if modedevies_by_categories %}
                                    <li class="d-flex justify-content-between align-items-center mt-3">
                                        <button class="btn btn-outline-primary ml-1 uniform-btn" data-toggle="modal"
                                                data-target="#modeDeVieviewModal">
                                            <em class="icon ni ni-list"></em> Mode vies
                                            <span class="badge badge-info ml-1">{{ modedevies_count }}</span>
                                        </button>
                                    </li>
                                {% endif %}


                                <!-- Modal d'Affichage des Modes de Vie -->
                                <div class="modal fade" id="modeDeVieviewModal" tabindex="-1"
                                     aria-labelledby="modeDeVieModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Modes de Vie du Patient</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                {% if modedevies_by_categories %}
                                                    <div class="accordion" id="accordionModeDeVie">
                                                        {% for categorie, modedevies in modedevies_by_categories.items %}
                                                            <div class="accordion-item">
                                                                <h2 class="accordion-header"
                                                                    id="heading{{ forloop.counter }}">
                                                                    <button class="accordion-button collapsed btn btn-outline-primary uniform-btn "
                                                                            type="button"
                                                                            data-bs-toggle="collapse"
                                                                            data-bs-target="#collapse{{ forloop.counter }}"
                                                                            aria-expanded="false"
                                                                            aria-controls="collapse{{ forloop.counter }}">
                                                                        {{ categorie }} ({{ modedevies|length }})
                                                                    </button>
                                                                </h2>
                                                                <div id="collapse{{ forloop.counter }}"
                                                                     class="accordion-collapse collapse"
                                                                     aria-labelledby="heading{{ forloop.counter }}"
                                                                     data-bs-parent="#accordionModeDeVie">
                                                                    <div class="accordion-body">
                                                                        <ul class="list-group">
                                                                            {% for mode in modedevies %}
                                                                                <li class="list-group-item">
                                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                                        <div>
                                                                                            <h6 class="mb-1">
                                                                                                <strong>{{ mode.date_enregistrement|date:"d M Y" }}</strong>
                                                                                                -
                                                                                                <span class="badge bg-info text-dark">{{ mode.get_frequence_display }}</span>
                                                                                            </h6>
                                                                                            <p class="mb-1"><strong>Description
                                                                                                :</strong> {{ mode.description|default:"Aucune description" }}
                                                                                            </p>
                                                                                            <p class="mb-1"><strong>Impact
                                                                                                :</strong> {{ mode.get_niveau_impact_display }}
                                                                                            </p>
                                                                                        </div>
                                                                                        <div>
                                                                                            <form method="post"
                                                                                                  action=""
                                                                                                  style="display:inline;">
                                                                                                {% csrf_token %}
                                                                                                <button type="submit"
                                                                                                        class="btn btn-danger btn-sm"
                                                                                                        onclick="return confirm('Voulez-vous vraiment supprimer ce mode de vie ?')">
                                                                                                    <em class="icon ni ni-trash"></em>
                                                                                                </button>
                                                                                            </form>
                                                                                        </div>
                                                                                    </div>
                                                                                </li>
                                                                            {% endfor %}
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <div class="alert alert-info text-center">
                                                        Aucun mode de vie enregistré pour cette hospitalisation.
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    Fermer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {% if appareils_by_categories %}
                                    <li class="d-flex justify-content-between align-items-center mt-3">
                                        <button class="btn btn-outline-primary ml-1 uniform-btn" data-toggle="modal"
                                                data-target="#appareilsViewModal">
                                            <em class="icon ni ni-list"></em> Appareils exam.
                                            <span class="badge badge-info ml-1">{{ appareils_count }}</span>
                                        </button>
                                    </li>
                                {% endif %}
                                <!-- Modal d'Affichage des Appareils -->
                                <div class="modal fade" id="appareilsViewModal" tabindex="-1"
                                     aria-labelledby="appareilsViewModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Appareils examinés</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                {% if appareils_by_categories %}
                                                    <div class="accordion" id="accordionAppareils">
                                                        {% for categorie, appareils in appareils_by_categories.items %}
                                                            <div class="accordion-item">
                                                                <h2 class="accordion-header"
                                                                    id="heading{{ forloop.counter }}">
                                                                    <button class="accordion-button collapsed btn btn-outline-primary uniform-btn"
                                                                            type="button"
                                                                            data-toggle="collapse"
                                                                            data-target="#collapseAppareil{{ forloop.counter }}"
                                                                            aria-expanded="false"
                                                                            aria-controls="collapseAppareil{{ forloop.counter }}">
                                                                        {{ categorie }} ({{ appareils|length }})
                                                                    </button>
                                                                </h2>
                                                                <div id="collapseAppareil{{ forloop.counter }}"
                                                                     class="accordion-collapse collapse"
                                                                     aria-labelledby="heading{{ forloop.counter }}"
                                                                     data-parent="#accordionAppareils">
                                                                    <div class="accordion-body">
                                                                        <ul class="list-group">
                                                                            {% for appareil in appareils %}
                                                                                <li class="list-group-item">
                                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                                        <div>
                                                                                            <h6 class="mb-1">
                                                                                                <strong>{{ appareil.nom }}</strong>
                                                                                                -
                                                                                                <span class="badge bg-info text-dark">{{ appareil.get_etat_display }}</span>
                                                                                            </h6>
                                                                                            <p class="mb-1"><strong>Observation :</strong>
                                                                                                {{ appareil.observation|safe|default:"Aucune observation" }}
                                                                                            </p>
                                                                                            <p class="mb-1"><strong>Ajouté
                                                                                                par :</strong>
                                                                                                {{ appareil.created_by }}
                                                                                            </p>
                                                                                            <p class="mb-1"><strong>Date
                                                                                                :</strong>
                                                                                                {{ appareil.created_at|date:"d M Y" }}
                                                                                            </p>
                                                                                        </div>
                                                                                        <div>
                                                                                            <form method="post"
                                                                                                  action="{% url 'delete_appareil' appareil.id %}"
                                                                                                  style="display:inline;">
                                                                                                {% csrf_token %}
                                                                                                <button type="submit"
                                                                                                        class="btn btn-danger btn-sm"
                                                                                                        onclick="return confirm('Voulez-vous vraiment supprimer cet appareil ?')">
                                                                                                    <em class="icon ni ni-trash"></em>
                                                                                                </button>
                                                                                            </form>
                                                                                        </div>
                                                                                    </div>
                                                                                </li>
                                                                            {% endfor %}
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <div class="alert alert-info text-center">
                                                        Aucun appareil enregistré pour cette hospitalisation.
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    Fermer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {% if resumes_by_hospitalisation %}
                                    <li class="d-flex justify-content-between align-items-center mt-3">
                                        <button class="btn btn-outline-primary ml-2 uniform-btn" data-toggle="modal"
                                                data-target="#resumesViewModal">
                                            <em class="icon ni ni-list"></em> Résumés synd.
                                            <span class="badge badge-info ml-1">{{ resumes_count }}</span>
                                        </button>
                                    </li>
                                {% endif %}
                                <!-- Modal d'Affichage des Résumés Syndromiques -->
                                <div class="modal fade" id="resumesViewModal" tabindex="-1"
                                     aria-labelledby="resumesViewModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Résumés syndromiques</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                {% if resumes_by_hospitalisation %}
                                                    <div class="accordion" id="accordionResumes">
                                                        {% for hospitalisation, resumes in resumes_by_hospitalisation.items %}
                                                            <div class="accordion-item">
                                                                <h2 class="accordion-header"
                                                                    id="headingResume{{ forloop.counter }}">
                                                                    <button class="accordion-button collapsed btn btn-outline-primary uniform-btn"
                                                                            type="button"
                                                                            data-bs-toggle="collapse"
                                                                            data-bs-target="#collapseResume{{ forloop.counter }}"
                                                                            aria-expanded="false"
                                                                            aria-controls="collapseResume{{ forloop.counter }}">
                                                                        {{ hospitalisation }} ({{ resumes|length }})
                                                                    </button>
                                                                </h2>
                                                                <div id="collapseResume{{ forloop.counter }}"
                                                                     class="accordion-collapse collapse"
                                                                     aria-labelledby="headingResume{{ forloop.counter }}"
                                                                     data-bs-parent="#accordionResumes">
                                                                    <div class="accordion-body">
                                                                        <ul class="list-group">
                                                                            {% for resume in resumes %}
                                                                                <li class="list-group-item">
                                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                                        <div>
                                                                                            <h6 class="mb-1">
                                                                                                <strong>{{ resume.patient }}</strong>
                                                                                                -
                                                                                                <span class="badge bg-info text-dark">{{ resume.created_at|date:"d M Y H:i" }}</span>
                                                                                            </h6>
                                                                                            <p class="mb-1"><strong>Description
                                                                                                :</strong>
                                                                                                {{ resume.description|safe|default:"Aucune description" }}
                                                                                            </p>
                                                                                            <p class="mb-1"><strong>Ajouté
                                                                                                par :</strong>
                                                                                                {{ resume.created_by }}
                                                                                            </p>
                                                                                        </div>
                                                                                        <div>
                                                                                            <form method="post"
                                                                                                  action="{% url 'delete_resume' resume.id %}"
                                                                                                  style="display:inline;">
                                                                                                {% csrf_token %}
                                                                                                <button type="submit"
                                                                                                        class="btn btn-danger btn-sm"
                                                                                                        onclick="return confirm('Voulez-vous vraiment supprimer ce résumé ?')">
                                                                                                    <em class="icon ni ni-trash"></em>
                                                                                                </button>
                                                                                            </form>
                                                                                        </div>
                                                                                    </div>
                                                                                </li>
                                                                            {% endfor %}
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <div class="alert alert-info text-center">
                                                        Aucun résumé syndromique enregistré pour cette hospitalisation.
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    Fermer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {% if problemes_by_hospitalisation %}
                                    <li class="d-flex justify-content-between align-items-center mt-3">
                                        <button class="btn btn-outline-primary ml-2 uniform-btn " data-toggle="modal"
                                                data-target="#problemesViewModal">
                                            <em class="icon ni ni-list"></em> Problèmes posés
                                            <span class="badge badge-info ml-1">{{ problemes_count }}</span>
                                        </button>
                                    </li>
                                {% endif %}
                                <!-- Modal d'Affichage des Problèmes Posés -->
                                <div class="modal fade" id="problemesViewModal" tabindex="-1"
                                     aria-labelledby="problemesViewModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Problèmes posés</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                {% if problemes_by_hospitalisation %}
                                                    <div class="accordion" id="accordionProblemes">
                                                        {% for hospitalisation, problemes in problemes_by_hospitalisation.items %}
                                                            <div class="accordion-item">
                                                                <h2 class="accordion-header"
                                                                    id="headingProbleme{{ forloop.counter }}">
                                                                    <button class="accordion-button collapsed btn btn-outline-primary uniform-btn"
                                                                            type="button"
                                                                            data-bs-toggle="collapse"
                                                                            data-bs-target="#collapseProbleme{{ forloop.counter }}"
                                                                            aria-expanded="false"
                                                                            aria-controls="collapseProbleme{{ forloop.counter }}">
                                                                        {{ hospitalisation }} ({{ problemes|length }})
                                                                    </button>
                                                                </h2>
                                                                <div id="collapseProbleme{{ forloop.counter }}"
                                                                     class="accordion-collapse collapse"
                                                                     aria-labelledby="headingProbleme{{ forloop.counter }}"
                                                                     data-bs-parent="#accordionProblemes">
                                                                    <div class="accordion-body">
                                                                        <ul class="list-group">
                                                                            {% for probleme in problemes %}
                                                                                <li class="list-group-item">
                                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                                        <div>
                                                                                            <h6 class="mb-1">
                                                                                                <strong>{{ probleme.patient }}</strong>
                                                                                                -
                                                                                                <span class="badge bg-info text-dark">{{ probleme.created_at|date:"d M Y" }}</span>
                                                                                            </h6>
                                                                                            <p class="mb-1"><strong>Description
                                                                                                :</strong>
                                                                                                {{ probleme.description|safe|default:"Aucune description" }}
                                                                                            </p>
                                                                                            <p class="mb-1"><strong>Ajouté
                                                                                                par :</strong>
                                                                                                {{ probleme.created_by }}
                                                                                            </p>
                                                                                        </div>
                                                                                        <div>
                                                                                            <form method="post"
                                                                                                  action="{% url 'delete_probleme' probleme.id %}"
                                                                                                  style="display:inline;">
                                                                                                {% csrf_token %}
                                                                                                <button type="submit"
                                                                                                        class="btn btn-danger btn-sm"
                                                                                                        onclick="return confirm('Voulez-vous vraiment supprimer ce problème ?')">
                                                                                                    <em class="icon ni ni-trash"></em>
                                                                                                </button>
                                                                                            </form>
                                                                                        </div>
                                                                                    </div>
                                                                                </li>
                                                                            {% endfor %}
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <div class="alert alert-info text-center">
                                                        Aucun problème posé pour cette hospitalisation.
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    Fermer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {% if bilans_by_type %}
                                    <li class="d-flex justify-content-between align-items-center mt-3">
                                        <button class="btn btn-outline-primary ml-2 uniform-btn" data-toggle="modal"
                                                data-target="#bilansViewModal">
                                            <em class="icon ni ni-list"></em> Bilans para.
                                            <span class="badge badge-info ml-1">{{ bilans_count }}</span>
                                        </button>
                                    </li>
                                {% endif %}
                                <!-- Modal d'Affichage des Bilans Paracliniques -->
                                <!-- Modal d'Affichage des Bilans Paracliniques Groupés par Type -->
                                <div class="modal fade" id="bilansViewModal" tabindex="-1"
                                     aria-labelledby="bilansViewModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-xl">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Bilans Paracliniques</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                {% if bilans_by_type %}
                                                    <div class="accordion" id="accordionBilans">
                                                        {% for type_bilan, bilans in bilans_by_type.items %}
                                                            <div class="accordion-item">
                                                                <h2 class="accordion-header"
                                                                    id="headingBilan{{ forloop.counter }}">
                                                                    <button class="accordion-button collapsed btn btn-outline-primary uniform-btn"
                                                                            type="button"
                                                                            data-bs-toggle="collapse"
                                                                            data-bs-target="#collapseBilan{{ forloop.counter }}"
                                                                            aria-expanded="false"
                                                                            aria-controls="collapseBilan{{ forloop.counter }}">
                                                                        {{ type_bilan }} ({{ bilans|length }})
                                                                    </button>
                                                                </h2>
                                                                <div id="collapseBilan{{ forloop.counter }}"
                                                                     class="accordion-collapse collapse"
                                                                     aria-labelledby="headingBilan{{ forloop.counter }}"
                                                                     data-bs-parent="#accordionBilans">
                                                                    <div class="accordion-body">
                                                                        <ul class="list-group">
                                                                            {% for bilan in bilans %}
                                                                                <li class="list-group-item">
                                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                                        <div>
                                                                                            <h6 class="mb-1">
                                                                                                <strong>{{ bilan.examen.nom }}</strong>
                                                                                                -
                                                                                                <span class="badge bg-info text-dark">{{ bilan.get_status_display }}</span>
                                                                                            </h6>
                                                                                            <p class="mb-1"><strong>Type
                                                                                                d'examen :</strong>
                                                                                                {{ bilan.examen.type_examen.nom }}
                                                                                            </p>
                                                                                            <p class="mb-1"><strong>Résultat
                                                                                                :</strong>
                                                                                                {{ bilan.result|default:"Non disponible" }}
                                                                                            </p>
                                                                                            <p class="mb-1"><strong>Date
                                                                                                du résultat :</strong>
                                                                                                {{ bilan.result_date|date:"d M Y" }}
                                                                                            </p>
                                                                                            <p class="mb-1"><strong>Valeur
                                                                                                de référence :</strong>
                                                                                                {{ bilan.reference_range|default:"Non spécifié" }}
                                                                                            </p>
                                                                                            <p class="mb-1"><strong>Unité
                                                                                                de mesure :</strong>
                                                                                                {{ bilan.unit|default:"Non spécifié" }}
                                                                                            </p>
                                                                                            <p class="mb-1"><strong>Commentaire
                                                                                                du médecin :</strong>
                                                                                                {{ bilan.comment|default:"Aucun commentaire" }}
                                                                                            </p>
                                                                                            <p class="mb-1"><strong>Prescrit
                                                                                                par :</strong>
                                                                                                {{ bilan.doctor|default:"Non spécifié" }}
                                                                                            </p>
                                                                                            <p class="mb-1"><strong>Date
                                                                                                prescription :</strong>
                                                                                                {{ bilan.created_at|date:"d M Y H:i" }}
                                                                                            </p>
                                                                                            {% if bilan.report_file %}
                                                                                                <p class="mb-1">
                                                                                                    <strong>Rapport
                                                                                                        :</strong>
                                                                                                    <a href="{{ bilan.report_file.url }}"
                                                                                                       target="_blank"
                                                                                                       class="btn btn-primary btn-sm">
                                                                                                        📄 Télécharger le
                                                                                                        rapport
                                                                                                    </a>
                                                                                                </p>
                                                                                            {% endif %}
                                                                                        </div>
                                                                                        <div>
                                                                                            <form method="post"
                                                                                                  action="{% url 'delete_bilan' bilan.id %}"
                                                                                                  style="display:inline;">
                                                                                                {% csrf_token %}
                                                                                                <button type="submit"
                                                                                                        class="btn btn-danger btn-sm"
                                                                                                        onclick="return confirm('Voulez-vous vraiment supprimer ce bilan ?')">
                                                                                                    <em class="icon ni ni-trash"></em>
                                                                                                </button>
                                                                                            </form>
                                                                                        </div>
                                                                                    </div>
                                                                                </li>
                                                                            {% endfor %}
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <div class="alert alert-info text-center">
                                                        Aucun bilan paraclinique enregistré pour cette hospitalisation.
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    Fermer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {% if imageries_by_type %}
                                    <li class="d-flex justify-content-between align-items-center mt-3">
                                        <button class="btn btn-outline-primary ml-2 uniform-btn" data-toggle="modal"
                                                data-target="#imagerieMedicaleModal">
                                            <em class="icon ni ni-edit-alt"></em> Imagerie <span
                                                class="badge badge-info ml-1">{{ imageries_count }}</span>
                                        </button>
                                    </li>
                                {% endif %}
                                <div class="modal fade" id="imagerieMedicaleModal" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Imagerie Medicale</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <input type="text" id="searchAvis" class="form-control mb-3"
                                                       placeholder="Rechercher une image medicale">
                                                <div id="ImagerieMedicalList">
                                                    {% if imageries_by_type %}
                                                        <div class="accordion" id="accordionImagerie">
                                                            {% for type_imagerie, imageries in imageries_by_type.items %}
                                                                <div class="accordion-item">
                                                                    <h2 class="accordion-header"
                                                                        id="headingImagerie{{ forloop.counter }}">
                                                                        <button class="accordion-button collapsed btn btn-outline-primary uniform-btn"
                                                                                type="button"
                                                                                data-bs-toggle="collapse"
                                                                                data-bs-target="#collapseImagerie{{ forloop.counter }}"
                                                                                aria-expanded="false"
                                                                                aria-controls="collapseImagerie{{ forloop.counter }}">
                                                                            {{ type_imagerie }} ({{ imageries|length }})
                                                                        </button>
                                                                    </h2>
                                                                    <div id="collapseImagerie{{ forloop.counter }}"
                                                                         class="accordion-collapse collapse"
                                                                         aria-labelledby="headingImagerie{{ forloop.counter }}"
                                                                         data-bs-parent="#accordionImagerie">
                                                                        <div class="accordion-body">
                                                                            <ul class="list-group">
                                                                                {% for imagerie in imageries %}
                                                                                    <li class="list-group-item">
                                                                                        <h6 class="text-primary">{{ imagerie.type_imagerie.nom }}
                                                                                            -
                                                                                            <span class="badge bg-info">{{ imagerie.get_status_display }}</span>
                                                                                        </h6>
                                                                                        <p><strong>Motif de la demande
                                                                                            :</strong> {{ imagerie.prescription|default:"Non spécifié" }}
                                                                                        </p>
                                                                                        <p><strong>Interprétation
                                                                                            :</strong> {{ imagerie.interpretation|default:"Aucune interprétation" }}
                                                                                        </p>
                                                                                        <p><strong>Médecin Prescripteur
                                                                                            :</strong> {{ imagerie.medecin_prescripteur|default:"Non spécifié" }}
                                                                                        </p>
                                                                                        <p><strong>Radiologue
                                                                                            :</strong> {{ imagerie.radiologue|default:"Non spécifié" }}
                                                                                        </p>
                                                                                        <p><strong>Date de l'examen
                                                                                            :</strong> {{ imagerie.date_examen|date:"d M Y H:i" }}
                                                                                        </p>
                                                                                        <p><strong>Interprétation IA
                                                                                            :</strong></p>
                                                                                        <div class="alert alert-{% if '🔴' in imagerie.interpretation_ia %}danger{% elif '🟠' in imagerie.interpretation_ia %}warning{% else %}success{% endif %}">
                                                                                            <pre>{{ imagerie.interpretation_ia }}</pre>
                                                                                        </div>

                                                                                        {% if imagerie.organes_detectes %}
                                                                                            <p><strong>Organes détectés
                                                                                                :</strong> {{ imagerie.organes_detectes }}
                                                                                            </p>
                                                                                        {% else %}
                                                                                            <p><strong>Organes détectés
                                                                                                :</strong> Non spécifié
                                                                                            </p>
                                                                                        {% endif %}


                                                                                        <div class="mt-2">
                                                                                            {% if imagerie.image_file %}
                                                                                                <p><strong>Image
                                                                                                    :</strong></p>
                                                                                                <img src="{{ imagerie.image_file.url }}"
                                                                                                     alt="Imagerie"
                                                                                                     class="img-fluid rounded"
                                                                                                     style="max-width: 300px;">
                                                                                                <br>
                                                                                                <a href="{% url 'telecharger_fichier' imagerie.id 'image' %}"
                                                                                                   class="btn btn-primary btn-sm mt-2">📥
                                                                                                    Télécharger</a>
                                                                                            {% endif %}

                                                                                            {% if imagerie.rapport_file %}
                                                                                                <p><strong>Rapport
                                                                                                    Médical :</strong>
                                                                                                </p>
                                                                                                <a href="{% url 'telecharger_fichier' imagerie.id 'rapport' %}"
                                                                                                   class="btn btn-primary btn-sm mt-2">📥
                                                                                                    Télécharger
                                                                                                    Rapport</a>
                                                                                            {% endif %}
                                                                                        </div>
                                                                                    </li>
                                                                                {% endfor %}
                                                                            </ul>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    {% else %}
                                                        <div class="alert alert-info text-center">
                                                            Aucun examen d'imagerie enregistré pour cette
                                                            hospitalisation.
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <script>
                                    document.addEventListener('DOMContentLoaded', function () {
                                        const searchInput = document.getElementById('searchAvis');  // Champ de recherche
                                        const imagerieItems = document.querySelectorAll('.list-group-item'); // Liste des éléments d'imagerie

                                        searchInput.addEventListener('input', function () {
                                            const searchValue = searchInput.value.toLowerCase();

                                            imagerieItems.forEach(item => {
                                                const title = item.querySelector('h6').innerText.toLowerCase();  // Nom de l'imagerie
                                                const details = item.innerText.toLowerCase();  // Tout le contenu de l'item

                                                if (title.includes(searchValue) || details.includes(searchValue)) {
                                                    item.style.display = '';  // Afficher l'élément si trouvé
                                                } else {
                                                    item.style.display = 'none';  // Masquer sinon
                                                }
                                            });
                                        });
                                    });
                                </script>


                                {% if avis_medicaux %}
                                    <li class="d-flex justify-content-between align-items-center mt-3">
                                        <button class="btn btn-outline-primary ml-2 uniform-btn" data-toggle="modal"
                                                data-target="#voiravisMedicalModal">
                                            <em class="icon ni ni-edit-alt"></em> Avis medical<span
                                                class="badge badge-info ml-1">{{ avis_medicauxcount }}</span>
                                        </button>
                                    </li>
                                {% endif %}
                                <div class="modal fade" id="voiravisMedicalModal" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Avis Médicaux</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <input type="text" id="searchAvis" class="form-control mb-3"
                                                       placeholder="Rechercher un avis médical">
                                                <div id="avisMedicalList">
                                                    {% for avis in avis_medicaux %}
                                                        <div class="card mb-3 avis-card">
                                                            <div class="card-header">
                                                                <strong>{{ avis.medecin.get_full_name }}</strong> -
                                                                <em>{{ avis.date_avis|date:"d/m/Y H:i" }}</em>
                                                            </div>
                                                            <div class="card-body">
                                                                <p>{{ avis.contenu|safe }}</p>
                                                                <small>Par : {{ avis.medecin.get_full_name }}</small>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <script>
                                    document.addEventListener('DOMContentLoaded', function () {
                                        const searchInput = document.getElementById('searchAvis');
                                        const avisCards = document.querySelectorAll('.avis-card');

                                        searchInput.addEventListener('input', function () {
                                            const searchValue = searchInput.value.toLowerCase();

                                            avisCards.forEach(card => {
                                                const title = card.querySelector('.card-header strong').innerText.toLowerCase();
                                                const content = card.querySelector('.card-body p').innerText.toLowerCase();

                                                if (title.includes(searchValue) || content.includes(searchValue)) {
                                                    card.style.display = '';
                                                } else {
                                                    card.style.display = 'none';
                                                }
                                            });
                                        });
                                    });
                                </script>
                                {% if effets_indesirables %}
                                    <li class="d-flex justify-content-between align-items-center mt-3">
                                        <button class="btn btn-outline-primary ml-2 uniform-btn" data-toggle="modal"
                                                data-target="#effetIndesirableModal">
                                            <em class="icon ni ni-edit-alt"></em> Effets indesirables <span
                                                class="badge badge-info">{{ effets_indesirablescount }}</span>
                                        </button>
                                    </li>
                                {% endif %}

                                <div class="modal fade" id="effetIndesirableModal" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Effets Indésirables</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <input type="text" id="searchEffetsIndesirables"
                                                       class="form-control mb-3"
                                                       placeholder="Rechercher un effet indésirable">
                                                <div id="effetsIndesirablesList">
                                                    {% for effet in effets_indesirables %}
                                                        <div class="card mb-3 effet-card">
                                                            <div class="card-header">
                                                                <strong>Gravité : {{ effet.gravite }}</strong> -
                                                                <em>{{ effet.date_apparition|date:"d/m/Y" }}</em>
                                                            </div>
                                                            <div class="card-body">
                                                                <p><strong>Description
                                                                    : </strong>{{ effet.description }}
                                                                </p>
                                                                <p><strong>Médicament associé
                                                                    : </strong>{{ effet.medicament_associe.nom|default:"Non spécifié" }}
                                                                </p>
                                                                <small>Signalé par
                                                                    : {{ effet.medecin.get_full_name|default:"Non spécifié" }}</small>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <script>
                                    document.addEventListener('DOMContentLoaded', function () {
                                        const searchInput = document.getElementById('searchEffetsIndesirables');
                                        const effetCards = document.querySelectorAll('.effet-card');

                                        searchInput.addEventListener('input', function () {
                                            const searchValue = searchInput.value.toLowerCase();

                                            effetCards.forEach(card => {
                                                const description = card.querySelector('.card-body').innerText.toLowerCase();

                                                if (description.includes(searchValue)) {
                                                    card.style.display = '';
                                                } else {
                                                    card.style.display = 'none';
                                                }
                                            });
                                        });
                                    });
                                </script>
                                {% if hopi_comment %}
                                    <li class="d-flex justify-content-between align-items-center mt-3">
                                        <button class="btn btn-outline-primary ml-2 uniform-btn" data-toggle="modal"
                                                data-target="#commentairesModal">
                                            <em class="icon ni ni-edit-alt"></em>Comment. <span
                                                class="badge badge-info">{{ hopi_commentcount }}</span>
                                        </button>
                                    </li>
                                {% endif %}

                                <div class="modal fade" id="commentairesModal" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Commentaires des medecins </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <!-- Champ de recherche -->
                                                <input type="text" id="searchComment" class="form-control mb-3"
                                                       placeholder="Rechercher un commentaire">

                                                <!-- Liste des commentaires -->
                                                <div id="commentList">
                                                    {% if hopi_comment %}
                                                        {% for comment in hopi_comment %}
                                                            <div class="card mb-3 comment-card">
                                                                <div class="card-header">
                                                                    <strong>{{ comment.medecin|default:"auteur inconnu" }}</strong>
                                                                    -
                                                                    <em>{{ comment.date_commentaire|naturaltime }}</em>
                                                                </div>
                                                                <div class="card-body">
                                                                    <p>{{ comment.contenu }}</p>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        <p>Aucun commentaire disponible.</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <script>
                                    document.addEventListener('DOMContentLoaded', function () {
                                        const searchInput = document.getElementById('searchComment');
                                        const commentCards = document.querySelectorAll('.comment-card');

                                        searchInput.addEventListener('input', function () {
                                            const searchValue = searchInput.value.toLowerCase();

                                            commentCards.forEach(card => {
                                                const content = card.querySelector('.card-body').innerText.toLowerCase();

                                                if (content.includes(searchValue)) {
                                                    card.style.display = '';
                                                } else {
                                                    card.style.display = 'none';
                                                }
                                            });
                                        });
                                    });
                                </script>

                                <!-- Modal Content for patient out -->
                                <div class="modal fade" tabindex="-1" id="hospitalisationout">
                                    <div class="modal-dialog modal-lg" role="document">
                                        <div class="modal-content ">
                                            <a href="#" class="close" data-dismiss="modal" aria-label="Close">
                                                <em class="icon ni ni-cross"></em>
                                            </a>
                                            <div class="modal-header">
                                                <h5 class="modal-title">Hospitalisation
                                                    Patient: {{ hospitalisationdetail.patient }}</h5>
                                            </div>
                                            <div class="modal-body">
                                                <form method="POST"
                                                      action="{% url 'update_hospitalisation_discharge' hospitalisation_id=hospitalisationdetail.id %}">
                                                    {% csrf_token %}
                                                    {{ Hospi_discharge_form }}
                                                    <button type="submit" class="btn btn-primary">Sortir</button>

                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modal Content for transfert -->
                                <div class="modal fade" tabindex="-1" id="hospitalisationtransfert">
                                    <div class="modal-dialog modal-lg" role="document">
                                        <div class="modal-content ">
                                            <a href="#" class="close" data-dismiss="modal" aria-label="Close">
                                                <em class="icon ni ni-cross"></em>
                                            </a>
                                            <div class="modal-header">
                                                <h5 class="modal-title">Tranferer du Patient
                                                    : {{ hospitalisationdetail.patient }}</h5>
                                            </div>
                                            <div class="modal-body">

                                                <form method="post"
                                                      action="{% url 'transferer_patient' hospitalisation_id=hospitalisationdetail.id %}">
                                                    {% csrf_token %}

                                                    <div class="form-group">
                                                        <label for="new_lit_id">Sélectionner un lit disponible :</label>
                                                        <select class="form-control" name="new_lit_id" required>
                                                            <option value="">--- Choisir un lit ---</option>
                                                            {% for unite in unites %}
                                                                <optgroup label="Unité : {{ unite.nom }}">
                                                                    {% for chambre in unite.chambres.all %}
                                                                        {% for box in chambre.boxes.all %}
                                                                            {% for lit in box.lits.all %}
                                                                                {% if not lit.occuper and not lit.is_out_of_service and not lit.is_cleaning %}
                                                                                    <option value="{{ lit.id }}">
                                                                                        {{ lit.nom }}
                                                                                        - {{ chambre.nom }}
                                                                                        - {{ unite.nom }}
                                                                                    </option>
                                                                                {% endif %}
                                                                            {% endfor %}
                                                                        {% endfor %}
                                                                    {% endfor %}
                                                                </optgroup>
                                                            {% endfor %}
                                                        </select>
                                                    </div>

                                                    <button type="submit" class="btn btn-primary">Transférer</button>
                                                    <a href="{% url 'hospitalisationdetails' hospitalisationdetail.pk %}"
                                                       class="btn btn-secondary">Annuler</a>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </ul>
                        </div>


                    </div>

                    <div class="nk-block">
                        <div class="card card-bordered card-stretch">
                            <div class="card-inner-group">
                                <div class="row pl-2 pr-2 pb-5">
                                    {% if hospitalisationdetail.discharge_date %}
                                    {% else %}

                                        <div class="col-lg-3 text-end">
                                            <ul class="m-0 p-0 list-unstyled text-end">
                                                <!-- Historique Maladie -->
                                                <li class="d-flex justify-content-between align-items-center">
                                                    <button type="button" class="btn btn-primary uniform-btn  mt-2"
                                                            data-toggle="modal" data-target="#addhistoireModal">
                                                        <em class="icon ni ni-plus-circle-fill"></em> Histoire maladie
                                                    </button>
                                                    <div class="modal fade" id="addhistoireModal" data-backdrop="static"
                                                         role="dialog" tabindex="-1" aria-hidden="true">
                                                        <div class="modal-dialog" role="document">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title">Historique de la
                                                                        maladie</h5>
                                                                    <a href="#" class="close" data-dismiss="modal"
                                                                       aria-label="Close">
                                                                        <em class="icon ni ni-cross"></em>
                                                                    </a>

                                                                </div>
                                                                <div class="modal-body">
                                                                    <form method="post"
                                                                          action="{% url 'add_historique_maladie' hospitalisation_id=hospitalisationdetail.id %}">
                                                                        {% csrf_token %}
                                                                        {{ historiquemaladieform.as_p }}
                                                                        <button type="submit" class="btn btn-primary">
                                                                            Enregistrer
                                                                        </button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <script>
                                                            document.addEventListener('DOMContentLoaded', function () {
                                                                // Reinitialiser TinyMCE quand le modal est affiché
                                                                $('#addhistoireModal').on('shown.bs.modal', function () {
                                                                    tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                                                                    tinymce.init({
                                                                        selector: '.tinymce-effet',
                                                                        plugins: 'advlist autolink lists link charmap print preview anchor image media table paste wordcount',
                                                                        toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                                                                        menubar: false,
                                                                        height: 300,
                                                                        browser_spellcheck: true,
                                                                        contextmenu: false,
                                                                    });
                                                                });
                                                            });
                                                        </script>
                                                    </div>

                                                </li>
                                                <!-- Button antecedent  -->
                                                <li class="d-flex justify-content-between align-items-center">
                                                    <button type="button" class="btn btn-primary uniform-btn mt-2"
                                                            data-toggle="modal" data-target="#antecedentsModal">
                                                        <em class="icon ni ni-plus-circle-fill"></em> Antécédents
                                                    </button>

                                                    <!-- Modal -->
                                                    <div class="modal fade" id="antecedentsModal" tabindex="-1"
                                                         aria-hidden="true">
                                                        <div class="modal-dialog modal-lg">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title">Antécédents Médicaux</h5>
                                                                    <button type="button" class="btn-close"
                                                                            data-dismiss="modal"></button>
                                                                </div>
                                                                <div class="modal-body">

                                                                    <form method="post"
                                                                          action="{% url 'add_antecedent_hospi' hospitalisation_id=hospitalisationdetail.id %}">
                                                                        {% csrf_token %}

                                                                        <!-- Initialisation Alpine.js avec les types chargés dynamiquement -->
                                                                        <div x-data="antecedentsForm(JSON.parse('{{ types_antecedents_json|safe|escapejs }}'))">
                                                                            <template x-for="(group, index) in groups"
                                                                                      :key="index">
                                                                                <div class="mb-4 p-3 border rounded">
                                                                                    <h5 x-text="group.label"
                                                                                        class="mb-3"></h5>

                                                                                    <template
                                                                                            x-for="(antecedent, idx) in group.antecedents"
                                                                                            :key="idx">
                                                                                        <div class="mb-3">
                                                                                            <input type="hidden"
                                                                                                   :name="'type_' + index + '_' + idx"
                                                                                                   x-model="group.id">

                                                                                            <input type="text"
                                                                                                   class="form-control mb-2"
                                                                                                   placeholder="Nom"
                                                                                                   :name="'nom_' + index + '_' + idx"
                                                                                                   x-model="antecedent.nom">

                                                                                            <input type="text"
                                                                                                   class="form-control mb-2"
                                                                                                   placeholder="Description"
                                                                                                   :name="'descriptif_' + index + '_' + idx"
                                                                                                   x-model="antecedent.descriptif">

                                                                                            <input type="date"
                                                                                                   class="form-control mb-2"
                                                                                                   :name="'date_debut_' + index + '_' + idx"
                                                                                                   x-model="antecedent.date_debut">

                                                                                            <button type="button"
                                                                                                    class="btn btn-danger btn-sm"
                                                                                                    @click="removeAntecedent(index, idx)">
                                                                                                Supprimer
                                                                                            </button>
                                                                                        </div>
                                                                                    </template>

                                                                                    <button type="button"
                                                                                            class="btn btn-success btn-sm"
                                                                                            @click="addAntecedent(index)">
                                                                                        Ajouter un champ
                                                                                    </button>
                                                                                </div>
                                                                            </template>
                                                                        </div>

                                                                        <button type="submit"
                                                                                class="btn btn-primary mt-3">Enregistrer
                                                                        </button>
                                                                    </form>

                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>

                                                <!-- Alpine.js Script -->
                                                <script>
                                                    function antecedentsForm(typesAntecedents) {
                                                        return {
                                                            groups: typesAntecedents.map(type => ({
                                                                label: type.nom,  // Utilisation du nom du type
                                                                id: type.id,  // ID du type pour la relation ForeignKey
                                                                antecedents: [{nom: "", descriptif: "", date_debut: ""}]
                                                            })),
                                                            addAntecedent(index) {
                                                                this.groups[index].antecedents.push({
                                                                    nom: "",
                                                                    descriptif: "",
                                                                    date_debut: ""
                                                                });
                                                            },
                                                            removeAntecedent(index, idx) {
                                                                if (this.groups[index].antecedents.length > 1) {
                                                                    this.groups[index].antecedents.splice(idx, 1);
                                                                }
                                                            }
                                                        };
                                                    }
                                                </script>

                                                <!-- Mode de vie  -->
                                                <li class="d-flex justify-content-between align-items-center">
                                                    <button type="button" class="btn btn-primary uniform-btn mt-2"
                                                            data-bs-toggle="modal" data-bs-target="#modeDeVieModal">
                                                        <em class="icon ni ni-plus-circle-fill"></em> Mode de Vie
                                                    </button>

                                                    <!-- Modal -->
                                                    <div class="modal fade" id="modeDeVieModal" tabindex="-1"
                                                         aria-hidden="true">
                                                        <div class="modal-dialog modal-lg">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title">Mode de Vie du Patient</h5>
                                                                    <button type="button" class="btn-close"
                                                                            data-bs-dismiss="modal"></button>
                                                                </div>
                                                                <div class="modal-body">

                                                                    <form method="post"
                                                                          action="{% url 'ajouter_mode_de_vie' hospitalisation_id=hospitalisationdetail.id %}">
                                                                        {% csrf_token %}

                                                                        <!-- Initialisation Alpine.js -->
                                                                        <div x-data="modeDeVieForm(JSON.parse('{{ categorie_modedevie_json|safe|escapejs }}'))">
                                                                            <template x-for="(group, index) in groups"
                                                                                      :key="index">
                                                                                <div class="mb-4 p-3 border rounded">
                                                                                    <h5 x-text="group.label"
                                                                                        class="mb-3"></h5>

                                                                                    <template
                                                                                            x-for="(mode, idx) in group.modes"
                                                                                            :key="idx">
                                                                                        <div class="mb-3">
                                                                                            <input type="hidden"
                                                                                                   :name="'categorie_' + index + '_' + idx"
                                                                                                   x-model="group.id">

                                                                                            <select class="form-control mb-2"
                                                                                                    :name="'frequence_' + index + '_' + idx"
                                                                                                    x-model="mode.frequence">
                                                                                                <option value="">
                                                                                                    Sélectionner la
                                                                                                    fréquence
                                                                                                </option>
                                                                                                <option value="quotidien">
                                                                                                    Quotidien
                                                                                                </option>
                                                                                                <option value="hebdomadaire">
                                                                                                    Hebdomadaire
                                                                                                </option>
                                                                                                <option value="mensuel">
                                                                                                    Mensuel
                                                                                                </option>
                                                                                                <option value="occasionnel">
                                                                                                    Occasionnel
                                                                                                </option>
                                                                                                <option value="rare">
                                                                                                    Rare
                                                                                                </option>
                                                                                            </select>

                                                                                            <select class="form-control mb-2"
                                                                                                    :name="'impact_' + index + '_' + idx"
                                                                                                    x-model="mode.impact">
                                                                                                <option value="">Impact
                                                                                                    sur la
                                                                                                    santé
                                                                                                </option>
                                                                                                <option value="faible">
                                                                                                    Faible
                                                                                                </option>
                                                                                                <option value="modéré">
                                                                                                    Modéré
                                                                                                </option>
                                                                                                <option value="élevé">
                                                                                                    Élevé
                                                                                                </option>
                                                                                            </select>

                                                                                            <textarea
                                                                                                    class="form-control mb-2"
                                                                                                    placeholder="Détails"
                                                                                                    :name="'description_' + index + '_' + idx"
                                                                                                    x-model="mode.description"></textarea>

                                                                                            <button type="button"
                                                                                                    class="btn btn-danger btn-sm"
                                                                                                    @click="removeMode(index, idx)">
                                                                                                Supprimer
                                                                                            </button>
                                                                                        </div>
                                                                                    </template>

                                                                                    <button type="button"
                                                                                            class="btn btn-success btn-sm"
                                                                                            @click="addMode(index)">
                                                                                        Ajouter un champ
                                                                                    </button>
                                                                                </div>
                                                                            </template>
                                                                        </div>

                                                                        <button type="submit"
                                                                                class="btn btn-primary mt-3">
                                                                            Enregistrer
                                                                        </button>
                                                                    </form>

                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>

                                                <!-- Alpine.js Script -->
                                                <script>
                                                    function modeDeVieForm(categories) {
                                                        return {
                                                            groups: categories.map(cat => ({
                                                                label: cat.nom,  // Nom de la catégorie
                                                                id: cat.id,  // ID de la catégorie
                                                                modes: [{description: "", frequence: "", impact: ""}]
                                                            })),
                                                            addMode(index) {
                                                                this.groups[index].modes.push({
                                                                    description: "",
                                                                    frequence: "",
                                                                    impact: ""
                                                                });
                                                            },
                                                            removeMode(index, idx) {
                                                                if (this.groups[index].modes.length > 1) {
                                                                    this.groups[index].modes.splice(idx, 1);
                                                                }
                                                            }
                                                        };
                                                    }
                                                </script>

                                            </ul>
                                        </div>
                                        <div class="col-lg-3 text-end">
                                            <ul class="m-0 p-0 list-unstyled text-end">
                                              <!-- Examen Physique -->
<!-- Examen Physique -->
<li class="d-flex justify-content-between align-items-center">

  <!-- Bouton d’ouverture du modal (Bootstrap 4) -->
  <button
    type="button"
    class="btn btn-success uniform-btn mt-2"
    data-toggle="modal"
    data-target="#examensphysiqueModal"
  >
    <em class="icon ni ni-plus-circle-fill"></em> Examens Physiques
  </button>

  <!-- Modal Bootstrap 4 -->
  <div class="modal fade" id="examensphysiqueModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Examens des Appareils</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <form
            method="post"
            id="examenAppareil"
            action="{% url 'add_examen_apareil' hospitalisation_id=hospitalisationdetail.id %}"
            autocomplete="off"
            novalidate
          >
            {% csrf_token %}

            <div x-data="appareilForm(JSON.parse('{{ types_appareils_json|safe|escapejs }}'))">

              <template x-for="(group, i) in groups" :key="i">
                <fieldset class="border rounded p-3 mb-4">
                  <legend class="h6" x-text="group.label"></legend>

                  <!-- 🔒 Transmet l'ID du type parent de ce groupe -->
                  <input type="hidden" :name="`parent_type_${i}`" :value="group.parent_id">

                  <template x-for="(row, j) in group.sous_types" :key="row.key">
                    <div class="border rounded bg-light p-3 mb-3">
                      <!-- NOM (obligatoire si ligne active) -->
                      <label class="form-label">Nom</label>
                      <input
                        type="text"
                        class="form-control mb-2"
                        :name="`nom_${i}_${j}`"
                        x-model="row.nom"
                        maxlength="150"
                        placeholder="Ex. Aire cardio-respiratoire"
                      >

                      <!-- ÉTAT (facultatif; ne rend pas une ligne “active”) -->
                      <label class="form-label">État</label>
                      <select
                        class="form-control mb-2"
                        :name="`etat_${i}_${j}`"
                        x-model="row.etat"
                      >
                        <option value="">— Sélectionner —</option>
                        <option value="normal">Normal</option>
                        <option value="altéré">Altéré</option>
                        <option value="anormal">Anormal</option>
                        <option value="non-applicable">Non-applicable</option>
                      </select>

                      <!-- OBSERVATION (facultatif) -->
                      <label class="form-label">Observation</label>
                      <textarea
                        class="form-control mb-2"
                        :name="`observation_${i}_${j}`"
                        x-model="row.obs"
                        maxlength="1000"
                        placeholder="Détails (facultatif)"
                      ></textarea>

                      <button type="button" class="btn btn-outline-danger btn-sm"
                              @click="removeAppareil(i,j)">
                        Supprimer
                      </button>
                    </div>
                  </template>

                  <button type="button" class="btn btn-success btn-sm" @click="addAppareil(i)">
                    Ajouter un champ
                  </button>
                </fieldset>
              </template>

            </div>

            <div class="text-right mt-3">
              <button type="submit" id="exaSubmit" class="btn btn-primary">Enregistrer</button>
            </div>
          </form>
        </div>

      </div>
    </div>
  </div>

</li>

<script>
/* ---------- Alpine.js component (groupes avec parent_id + lignes vides par défaut) ---------- */
function appareilForm(data) {
  const safe = Array.isArray(data) ? data : [];
  // On attend que chaque item contienne au moins { id, nom } pour le parent (type)
  return {
    groups: (safe.length ? safe : [{ id: null, nom: 'Appareils' }]).map((g, i) => ({
      parent_id: g?.id ?? null,                 // 👈 ID du type parent
      label: g?.nom ?? `Groupe ${i+1}`,
      // Au moins une ligne vide
      sous_types: [ { key: `${i}-0-${Date.now()}`, nom: "", etat: "", obs: "" } ]
    })),

    addAppareil(i) {
      this.groups[i].sous_types.push({
        key: `${i}-${this.groups[i].sous_types.length}-${Date.now()}`,
        nom: "",
        etat: "",
        obs: ""
      });
    },

    removeAppareil(i, j) {
      const arr = this.groups[i].sous_types;
      if (arr.length > 1) arr.splice(j, 1);
      else alert("Impossible de supprimer le dernier champ.");
    }
  };
}

/* ---------- VALIDATION Bootstrap 4 (sans champ type ; parent transmis caché) ---------- */
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("examenAppareil");

  form.addEventListener("submit", function (event) {
    const container = document.getElementById("examensphysiqueModal"); // scope strict
    const nomFields = Array.from(container.querySelectorAll('input[name^="nom_"]'));
    const getIdx = (name) => {
      const m = name.match(/^nom_(\d+)_(\d+)$/);
      return m ? [m[1], m[2]] : null;
    };

    let activeRows = 0;
    let firstInvalidEl = null;
    let invalid = false;

    container.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));

    nomFields.forEach(nomEl => {
      const ids = getIdx(nomEl.name);
      if (!ids) return;
      const [i, j] = ids;

      const etatEl = container.querySelector(`[name="etat_${i}_${j}"]`);
      const obsEl  = container.querySelector(`[name="observation_${i}_${j}"]`);
      const parentEl = container.querySelector(`[name="parent_type_${i}"]`);

      const nom  = (nomEl?.value  || "").trim();
      const obs  = (obsEl?.value  || "").trim();
      const etat = (etatEl?.value || "").trim();
      const parentVal = (parentEl?.value || "").trim(); // 👈 ID parent envoyé

      // ligne active si NOM ou OBS
      const isActive = !!(nom || obs);

      if (!isActive) {
        if (etatEl && etat) etatEl.value = "";
        return;
      }

      activeRows += 1;

      // parent doit exister si on a une ligne active (sinon on ne sait pas où ranger)
      if (!parentVal) {
        // On met un indicateur doux mais on n'empêche pas : on laissera le serveur ignorer proprement si besoin
        console.warn(`Parent manquant pour la ligne ${i}-${j}`);
      }

      // Pour une ligne active : NOM requis
      if (!nom) {
        nomEl.classList.add("is-invalid");
        if (!firstInvalidEl) firstInvalidEl = nomEl;
        invalid = true;
      }

      // État par défaut
      if (etatEl && !etat) etatEl.value = "normal";
    });

    if (activeRows === 0) {
      event.preventDefault();
      $('#examensphysiqueModal').modal('hide');
      return;
    }

    if (invalid) {
      event.preventDefault();
      alert("Pour les lignes remplies, 'Nom' est obligatoire.");
      if (firstInvalidEl) {
        firstInvalidEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => firstInvalidEl.focus(), 200);
      }
    }
  });
});
</script>




                                                <!-- Resume Syndromique  -->
                                                <li class="d-flex justify-content-between align-items-center">
                                                    <button type="button" class="btn btn-success  uniform-btn mt-2"
                                                            data-toggle="modal" data-target="#resumesyndromiqueModal">
                                                        <em class="icon ni ni-plus-circle-fill"></em> Résumés
                                                        Syndromique
                                                    </button>
                                                    <div class="modal fade" id="resumesyndromiqueModal" tabindex="-1"
                                                         aria-hidden="true">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title">Ajouter un résumé</h5>
                                                                    <button type="button" class="btn-close"
                                                                            data-bs-dismiss="modal"></button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <form method="post"
                                                                          action="{% url 'add_resume_syndromique' hospitalisation_id=hospitalisationdetail.id %}">
                                                                        {% csrf_token %}
                                                                        {{ resumesyndromiqueform.as_p }}
                                                                        <button type="submit" class="btn btn-primary">
                                                                            Enregistrer
                                                                        </button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <script>
                                                        document.addEventListener('DOMContentLoaded', function () {
                                                            // Reinitialiser TinyMCE quand le modal est affiché
                                                            $('#resumesyndromiqueModal').on('shown.bs.modal', function () {
                                                                tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                                                                tinymce.init({
                                                                    selector: '.tinymce-effet',
                                                                    plugins: 'advlist autolink lists link charmap print preview anchor',
                                                                    toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                                                                    menubar: false,
                                                                    height: 300,
                                                                });
                                                            });
                                                        });
                                                    </script>
                                                </li>

                                                <!-- Problemes posés  -->
                                                <li class="d-flex justify-content-between align-items-center">
                                                    <button type="button" class="btn btn-success  uniform-btn mt-2"
                                                            data-toggle="modal" data-target="#problemesposerModal">
                                                        <em class="icon ni ni-plus-circle-fill"></em>Problèmes posés
                                                    </button>
                                                    <div class="modal fade" id="problemesposerModal" tabindex="-1"
                                                         aria-hidden="true">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title">Rediger le Problèmes</h5>
                                                                    <button type="button" class="btn-close"
                                                                            data-bs-dismiss="modal"></button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <form method="post"
                                                                          action="{% url 'add_problemes_pose' hospitalisation_id=hospitalisationdetail.id %}">
                                                                        {% csrf_token %}
                                                                        {{ problemesposerform.as_p }}
                                                                        <button type="submit" class="btn btn-primary">
                                                                            Enregistrer
                                                                        </button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <script>
                                                        document.addEventListener('DOMContentLoaded', function () {
                                                            // Reinitialiser TinyMCE quand le modal est affiché
                                                            $('#problemesposerModal').on('shown.bs.modal', function () {
                                                                tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                                                                tinymce.init({
                                                                    selector: '.tinymce-effet',
                                                                    plugins: 'advlist autolink lists link charmap print preview anchor',
                                                                    toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                                                                    menubar: false,
                                                                    height: 300,
                                                                });
                                                            });
                                                        });
                                                    </script>
                                                </li>

                                            </ul>

                                        </div>
                                        <div class="col-lg-3 text-end">
                                            <ul class="m-0 p-0 list-unstyled text-end">
                                                <!-- Bilan Paraclinique -->
                                                <li class="d-flex justify-content-between align-items-center">
                                                    <button type="button" class="btn btn-danger  uniform-btn mt-2"
                                                            data-toggle="modal" data-target="#bilanModal">
                                                        <em class="icon ni ni-plus-circle-fill"></em> Bilan Paraclinique
                                                    </button>

                                                    <div class="modal fade" id="bilanModal" tabindex="-1"
                                                         aria-hidden="true">
                                                        <div class="modal-dialog modal-lg">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title">Ajouter des Examens
                                                                        Paracliniques</h5>
                                                                    <button type="button" class="btn-close"
                                                                            data-bs-dismiss="modal"></button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <form @submit.prevent="submitForm">
                                                                        {% csrf_token %}

                                                                        <div x-data="bilanForm(JSON.parse('{{ types_examens_json|safe|escapejs }}'))">
                                                                            <template x-for="(type, index) in types"
                                                                                      :key="index">
                                                                                <div class="mb-4 p-3 border rounded">
                                                                                    <h5 class="mb-3 text-primary"
                                                                                        x-text="type.nom"></h5>

                                                                                    <template
                                                                                            x-for="(examen, idx) in type.examens"
                                                                                            :key="idx">
                                                                                        <label class="d-flex align-items-center mb-4">
                                                                                            <input type="checkbox"
                                                                                                   class="form-check-input custom-checkbox me-2"
                                                                                                   :value="examen.id"
                                                                                                   x-model="selectedExamens">
                                                                                            <span x-text="examen.nom"
                                                                                                  class="ml-3"></span>
                                                                                        </label>
                                                                                    </template>
                                                                                </div>
                                                                            </template>

                                                                            <!-- Bouton d'enregistrement -->
                                                                            <div class="text-center mt-4">
                                                                                <button type="submit"
                                                                                        class="btn btn-primary"
                                                                                        @click.prevent="submitForm">
                                                                                    Enregistrer les examens
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <script>
                                                        function bilanForm(data) {
                                                            return {
                                                                types: data,  // Liste des types d'examens et examens associés
                                                                selectedExamens: [],  // Examens sélectionnés

                                                                submitForm() {
                                                                    if (this.selectedExamens.length === 0) {
                                                                        alert("Veuillez sélectionner au moins un examen.");
                                                                        return;
                                                                    }

                                                                    let formData = new FormData();
                                                                    formData.append("csrfmiddlewaretoken", document.querySelector("[name=csrfmiddlewaretoken]").value);

                                                                    this.selectedExamens.forEach(id => {
                                                                        formData.append("examens", id);
                                                                    });

                                                                    let url = "{% url 'add_bilan_paraclinique' hospitalisation_id=0 %}".replace("0", "{{ hospitalisationdetail.id }}");

                                                                    fetch(url, {
                                                                        method: "POST",
                                                                        body: formData,
                                                                        headers: {
                                                                            "X-Requested-With": "XMLHttpRequest"
                                                                        }
                                                                    })
                                                                        .then(response => response.json())
                                                                        .then(data => {
                                                                            if (data.success) {
                                                                                alert(data.message);
                                                                                location.reload();
                                                                            } else {
                                                                                alert(data.message);
                                                                            }
                                                                        })
                                                                        .catch(error => {
                                                                            alert("Erreur lors de l'enregistrement : " + error);
                                                                        });
                                                                }
                                                            };
                                                        }
                                                    </script>
                                                </li>
                                                <!-- Imagerie -->
                                                <li class="d-flex justify-content-between align-items-center">
                                                    <button type="button" class="btn btn-danger  uniform-btn mt-2"
                                                            data-toggle="modal" data-target="#imagerieModal">
                                                        <em class="icon ni ni-plus-circle-fill"></em> Imagerie
                                                    </button>

                                                    <div class="modal fade" id="imagerieModal" tabindex="-1"
                                                         aria-hidden="true">
                                                        <div class="modal-dialog modal-lg">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title">Ajouter une Imagerie
                                                                        Médicale</h5>
                                                                    <button type="button" class="btn-close"
                                                                            data-bs-dismiss="modal"></button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <form @submit.prevent="submitForm"
                                                                          enctype="multipart/form-data" method="post"
                                                                          action="{% url 'add_imagerie' hospitalisation_id=hospitalisationdetail.id %}">
                                                                        {% csrf_token %}

                                                                        <div x-data="imagerieForm(JSON.parse('{{ types_imagerie_json|safe|escapejs }}'))">
                                                                            <!-- Type d'Imagerie -->
                                                                            <label for="type_imagerie">Type d'Imagerie
                                                                                :</label>
                                                                            <select name="type_imagerie"
                                                                                    class="form-select mb-3"
                                                                                    x-model="selectedType">
                                                                                <option value="">Sélectionner un type
                                                                                </option>
                                                                                <template x-for="(type, index) in types"
                                                                                          :key="index">
                                                                                    <option :value="type.id"
                                                                                            x-text="type.nom"></option>
                                                                                </template>
                                                                            </select>

                                                                            <!-- Motif -->
                                                                            <label for="prescription">Motif :</label>
                                                                            <textarea name="prescription"
                                                                                      class="form-control mb-3"
                                                                                      x-model="prescription"
                                                                                      placeholder="Motif de l'examen..."></textarea>

                                                                            <!-- Fichier Image -->
                                                                            <label for="image_file">Fichier Image
                                                                                :</label>
                                                                            <input name="image_file" type="file"
                                                                                   class="form-control mb-3"
                                                                                   @change="handleImageUpload">
                                                                            <img x-show="imagePreview"
                                                                                 :src="imagePreview"
                                                                                 class="img-fluid rounded mt-2"
                                                                                 style="max-width: 600px;">

                                                                            <!-- Indicateur de chargement -->
                                                                            <div x-show="loading" class="text-center">
                                                                                <div class="spinner-border text-primary"
                                                                                     role="status">
                                                                                    <span class="visually-hidden">Chargement...</span>
                                                                                </div>
                                                                            </div>

                                                                            <!-- Bouton d'enregistrement -->
                                                                            <div class="text-center mt-4">
                                                                                <button type="submit"
                                                                                        class="btn btn-primary"
                                                                                        :disabled="loading">
                                                                                    <span x-show="!loading">Enregistrer l'Imagerie</span>
                                                                                    <span x-show="loading">Traitement en cours...</span>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </form>

                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <script>
                                                        function imagerieForm(types) {
                                                            return {
                                                                types: types,
                                                                selectedType: '',
                                                                prescription: '',
                                                                imageFile: null,
                                                                imagePreview: '',
                                                                loading: false,
                                                                errors: {},

                                                                handleImageUpload(event) {
                                                                    let file = event.target.files[0];
                                                                    if (file) {
                                                                        this.imageFile = file;

                                                                        // Vérifier si c'est bien une image
                                                                        let validTypes = ["image/jpeg", "image/png", "image/jpg"];
                                                                        if (!validTypes.includes(file.type)) {
                                                                            alert("Format non supporté. Seules les images JPEG/PNG sont autorisées.");
                                                                            return;
                                                                        }

                                                                        // Générer un aperçu de l'image
                                                                        let reader = new FileReader();
                                                                        reader.onload = (e) => {
                                                                            this.imagePreview = e.target.result;
                                                                        };
                                                                        reader.readAsDataURL(file);
                                                                    }
                                                                },

                                                                async submitForm() {
                                                                    if (!this.selectedType) {
                                                                        alert("Veuillez sélectionner un type d'imagerie.");
                                                                        return;
                                                                    }

                                                                    this.loading = true;
                                                                    this.errors = {}; // Réinitialiser les erreurs

                                                                    let formData = new FormData();
                                                                    formData.append("csrfmiddlewaretoken", document.querySelector("[name=csrfmiddlewaretoken]").value);
                                                                    formData.append("type_imagerie", this.selectedType);
                                                                    formData.append("prescription", this.prescription);
                                                                    if (this.imageFile) {
                                                                        formData.append("image_file", this.imageFile);
                                                                    }

                                                                    console.log("🔹 Envoi des données:", Object.fromEntries(formData));

                                                                    try {
                                                                        let response = await fetch("{% url 'add_imagerie' hospitalisation_id=hospitalisationdetail.id %}", {
                                                                            method: "POST",
                                                                            body: formData
                                                                        });

                                                                        let data = await response.json();
                                                                        this.loading = false;

                                                                        if (data.success) {
                                                                            alert(data.message);
                                                                            location.reload();
                                                                        } else {
                                                                            console.error("❌ Erreurs Django:", data.errors);
                                                                            this.errors = data.errors;
                                                                            alert("Erreur lors de l'enregistrement.");
                                                                        }
                                                                    } catch (error) {
                                                                        this.loading = false;
                                                                        console.error("❌ Erreur Fetch:", error);
                                                                        alert("Une erreur s'est produite lors de la soumission.");
                                                                    }
                                                                }
                                                            };
                                                        }
                                                    </script>
                                                    {#<script>#}
                                                    {#function imagerieForm(types) {#}
                                                    {#    return {#}
                                                    {#        types: types,#}
                                                    {#        selectedType: '',#}
                                                    {#        prescription: '',#}
                                                    {#        imageFile: null,#}
                                                    {#        imagePreview: '',#}
                                                    {#        dicomFile: null,#}
                                                    {#        loading: false,#}
                                                    {##}
                                                    {#        handleImageUpload(event) {#}
                                                    {#            const file = event.target.files[0];#}
                                                    {#            if (file) {#}
                                                    {#                this.imageFile = file;#}
                                                    {#                const reader = new FileReader();#}
                                                    {#                reader.onload = (e) => {#}
                                                    {#                    this.imagePreview = e.target.result;#}
                                                    {#                };#}
                                                    {#                reader.readAsDataURL(file);#}
                                                    {#            }#}
                                                    {#        },#}
                                                    {##}
                                                    {#        handleDicomUpload(event) {#}
                                                    {#            this.dicomFile = event.target.files[0];#}
                                                    {#        },#}
                                                    {##}
                                                    {#        submitForm() {#}
                                                    {#            if (!this.selectedType) {#}
                                                    {#                alert("Veuillez sélectionner un type d'imagerie.");#}
                                                    {#                return;#}
                                                    {#            }#}
                                                    {##}
                                                    {#            let formData = new FormData();#}
                                                    {#            formData.append("csrfmiddlewaretoken", document.querySelector("[name=csrfmiddlewaretoken]").value);#}
                                                    {#            formData.append("type_imagerie", this.selectedType);#}
                                                    {#            formData.append("prescription", this.prescription);#}
                                                    {#            if (this.imageFile) formData.append("image_file", this.imageFile);#}
                                                    {#            if (this.dicomFile) formData.append("dicom_file", this.dicomFile);#}
                                                    {##}
                                                    {#            this.loading = true;#}
                                                    {##}
                                                    {#            fetch("{% url 'add_imagerie' hospitalisation_id=hospitalisationdetail.id %}", {#}
                                                    {#                method: "POST",#}
                                                    {#                body: formData#}
                                                    {#            })#}
                                                    {#            .then(response => response.json())#}
                                                    {#            .then(data => {#}
                                                    {#                this.loading = false;#}
                                                    {#                if (data.success) {#}
                                                    {#                    alert(data.message);#}
                                                    {#                    location.reload();#}
                                                    {#                } else {#}
                                                    {#                    alert("Erreur lors de l'enregistrement.");#}
                                                    {#                }#}
                                                    {#            })#}
                                                    {#            .catch(() => {#}
                                                    {#                this.loading = false;#}
                                                    {#                alert("Une erreur est survenue.");#}
                                                    {#            });#}
                                                    {#        }#}
                                                    {#    };#}
                                                    {#}#}
                                                    {#</script>#}

                                                </li>

                                                <!-- Diagnostique -->
                                                <li class="d-flex justify-content-between align-items-center">
                                                    <button type="button" class="btn btn-danger  uniform-btn mt-2"
                                                            data-toggle="modal" data-target="#adddiagnosticModal">
                                                        <em class="icon ni ni-plus-circle-fill"></em> Diagnostic
                                                    </button>

                                                    <div class="modal fade" id="adddiagnosticModal" tabindex="-1"
                                                         aria-hidden="true">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title">Ajouter un Diagnostic</h5>
                                                                    <button type="button" class="btn-close"
                                                                            data-bs-dismiss="modal"></button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <form method="post"
                                                                          action="{% url 'add_diagnostic' hospitalisation_id=hospitalisationdetail.id %}">
                                                                        {% csrf_token %}
                                                                        {{ diagnosticsform.as_p }}
                                                                        <button type="submit" class="btn btn-primary">
                                                                            Enregistrer
                                                                        </button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>


                                            </ul>

                                        </div>
                                        <div class="col-lg-3 text-end">

                                            <ul class="m-0 p-0 list-unstyled text-end">
                                                <!-- avis medical -->
                                                <li class="d-flex justify-content-between align-items-center">
                                                    <button type="button" class="btn btn-light  uniform-btn mt-2"
                                                            data-toggle="modal" data-target="#addavisModal">
                                                        <em class="icon ni ni-plus-circle-fill"></em> Avis médical
                                                    </button>

                                                    <div class="modal fade" id="addavisModal" tabindex="-1"
                                                         aria-hidden="true">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title">Ajouter un Avi medical</h5>
                                                                    <button type="button" class="btn-close"
                                                                            data-bs-dismiss="modal"></button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <form method="post"
                                                                          action="{% url 'add_avis_medical' hospitalisation_id=hospitalisationdetail.id %}">
                                                                        {% csrf_token %}
                                                                        {{ avismedicalform.as_p }}
                                                                        <button type="submit" class="btn btn-primary">
                                                                            Enregistrer
                                                                        </button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <script>
                                                        document.addEventListener('DOMContentLoaded', function () {
                                                            // Reinitialiser TinyMCE quand le modal est affiché
                                                            $('#addavisModal').on('shown.bs.modal', function () {
                                                                tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                                                                tinymce.init({
                                                                    selector: '.tinymce-avis',
                                                                    plugins: 'advlist autolink lists link charmap print preview anchor',
                                                                    toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                                                                    menubar: false,
                                                                    height: 300,
                                                                });
                                                            });
                                                        });
                                                    </script>
                                                </li>

                                                <!-- effet indesirable -->
                                                <li class="d-flex justify-content-between align-items-center">
                                                    <button type="button" class="btn btn-light uniform-btn mt-2"
                                                            data-toggle="modal" data-target="#addeffetindesirableModal">
                                                        <em class="icon ni ni-plus-circle-fill"></em> Effet indésirable
                                                    </button>
                                                    <div class="modal fade" id="addeffetindesirableModal" tabindex="-1"
                                                         aria-hidden="true">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title">Ajouter un effet
                                                                        indesirable</h5>
                                                                    <button type="button" class="btn-close"
                                                                            data-bs-dismiss="modal"></button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <form method="post"
                                                                          action="{% url 'add_effet_indesirable' hospitalisation_id=hospitalisationdetail.id %}">
                                                                        {% csrf_token %}
                                                                        {{ effetindesirableform.as_p }}
                                                                        <button type="submit" class="btn btn-primary">
                                                                            Enregistrer
                                                                        </button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <script>
                                                        document.addEventListener('DOMContentLoaded', function () {
                                                            // Reinitialiser TinyMCE quand le modal est affiché
                                                            $('#addeffetindesirableModal').on('shown.bs.modal', function () {
                                                                tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                                                                tinymce.init({
                                                                    selector: '.tinymce-effet',
                                                                    plugins: 'advlist autolink lists link charmap print preview anchor',
                                                                    toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                                                                    menubar: false,
                                                                    height: 300,
                                                                });
                                                            });
                                                        });
                                                    </script>
                                                </li>
                                                <!-- Commentaire -->
                                                <li class="d-flex justify-content-between align-items-center">
                                                    <button type="button" class="btn btn-light  uniform-btn mt-2"
                                                            data-toggle="modal" data-target="#addcommentModal">
                                                        <em class="icon ni ni-plus-circle-fill"></em> Commentaire /
                                                        update
                                                    </button>
                                                    <div class="modal fade" id="addcommentModal" tabindex="-1"
                                                         aria-hidden="true">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title">Ajouter un commentaire</h5>
                                                                    <button type="button" class="btn-close"
                                                                            data-bs-dismiss="modal"></button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <form method="post"
                                                                          action="{% url 'add_coment' hospitalisation_id=hospitalisationdetail.id %}">
                                                                        {% csrf_token %}
                                                                        {{ hospicomment.as_p }}
                                                                        <button type="submit" class="btn btn-primary">
                                                                            Enregistrer
                                                                        </button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </li>
                                            </ul>

                                        </div>
                                    {% endif %}

                                </div>
                                <div class="row">
                                    <!-- Médicament manqué -->
                                    <div class="col-lg-6 mx-auto">
                                        {% if missed_executions %}
                                            <div class="card shadow-sm border-0 bg-light rounded-lg">
                                                <div class="card-body">
                                                    <h5 class="text-danger font-weight-bold ">
                                                        Médicaments Non Pris
                                                    </h5>
                                                    <div class="scrollable-container"
                                                         style="max-height: 200px; overflow-y: auto;">
                                                        <ul class="list-group">
                                                            {% for execution in missed_executions %}
                                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                    <div>
                                                                        <strong>{{ execution.prescription.medication }}</strong>
                                                                        <br>
                                                                        <span class="text-muted">Heure prévue : {{ execution.scheduled_time|date:"d/m/Y H:i" }}</span>
                                                                    </div>
                                                                    <span class="badge bg-danger text-white">Non pris</span>
                                                                </li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="card shadow-sm border-0 bg-success text-white rounded-lg p-4">
                                                <div class="card-body text-center">
                                                    <h5 class="font-weight-bold">Aucune Prise Manquée</h5>
                                                    <p class="mt-2">Toutes les prescriptions ont été suivies à
                                                        temps.</p>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                
                                    <div class="col-lg-6 mx-auto">
                                    
                                        {% if next_execution %}
                                            <div class="card shadow-sm border-0 bg-light rounded-lg p-4">
                                                <div class="card-body text-center">
                                                    <h5 class="text-primary font-weight-bold">Prochaine Prise de Médicament</h5>
                                                    <h4 class="text-dark mt-3">{{ next_execution.prescription.medication }}</h4>
                                                    <p class="text-muted">Date et heure prévue :
                                                        <strong>{{ next_execution.scheduled_time|date:"d/m/Y H:i" }}</strong>
                                                    </p>
                                                    <div class="mt-4">
                                                        <div id="countdown"
                                                             class="display-4 text-warning font-weight-bold"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="card shadow-sm border-0 bg-success text-white rounded-lg p-4">
                                                <div class="card-body text-center">
                                                    <h5 class="font-weight-bold">Aucun Médicament Prévu</h5>
                                                    <p class="mt-2">Tous les médicaments prescrits ont été administrés
                                                        ou
                                                        aucune prescription n'est en attente.</p>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <script>
                                        {% if next_execution %}
                                            // Récupère la date de la prochaine exécution
                                            const nextExecutionTime = new Date("{{ next_execution.scheduled_time|date:'Y-m-d H:i:s' }}").getTime();
                                            const countdownElement = document.getElementById("countdown");

                                            const countdown = setInterval(function () {
                                                const now = new Date().getTime();
                                                const distance = nextExecutionTime - now;

                                                if (distance <= 0) {
                                                    clearInterval(countdown);
                                                    countdownElement.innerHTML = "Prise de médicament en cours ou en retard.";

                                                    // ⚠️ Lancer la requête AJAX pour marquer comme "Missed"
                                                    updateMissedExecution("{{ next_execution.id }}");
                                                } else {
                                                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                                    const minutes = Math.floor((distance % (1000 * 60)) / (1000 * 60));
                                                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                                                    countdownElement.innerHTML = `${hours}h ${minutes}m ${seconds}s`;
                                                }
                                            }, 1000);

                                            // Fonction AJAX pour mettre à jour le statut en "Missed"
                                            function updateMissedExecution(executionId) {
                                                fetch("{% url 'update_execution_status' %}", {
                                                    method: "POST",
                                                    headers: {
                                                        "Content-Type": "application/json",
                                                        "X-CSRFToken": "{{ csrf_token }}"
                                                    },
                                                    body: JSON.stringify({
                                                        execution_id: executionId,
                                                        new_status: "Missed"
                                                    })
                                                })
                                                    .then(response => response.json())
                                                    .then(data => {
                                                        if (data.success) {
                                                            alert("La prise de médicament a été marquée comme 'Missed'.");
                                                            location.reload();  // Recharge la page pour afficher la mise à jour
                                                        } else {
                                                            console.error("Erreur de mise à jour :", data.message);
                                                        }
                                                    })
                                                    .catch(error => console.error("Erreur AJAX :", error));
                                            }
                                        {% endif %}
                                    </script>
                                    {#                                <script>#}
                                    {#                                    {% if next_execution %}#}
                                    {#                                        // Script pour le compte à rebours#}
                                    {#                                        const nextExecutionTime = new Date("{{ next_execution.scheduled_time|date:"Y-m-d H:i:s" }}").getTime();#}
                                    {#                                        const countdownElement = document.getElementById("countdown");#}
                                    {##}
                                    {#                                        const countdown = setInterval(function () {#}
                                    {#                                            const now = new Date().getTime();#}
                                    {#                                            const distance = nextExecutionTime - now;#}
                                    {##}
                                    {#                                            if (distance <= 0) {#}
                                    {#                                                clearInterval(countdown);#}
                                    {#                                                countdownElement.innerHTML = "Prise de médicament en cours ou en retard.";#}
                                    {#                                            } else {#}
                                    {#                                                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));#}
                                    {#                                                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));#}
                                    {#                                                const seconds = Math.floor((distance % (1000 * 60)) / 1000);#}
                                    {##}
                                    {#                                                countdownElement.innerHTML = `${hours}h ${minutes}m ${seconds}s`;#}
                                    {#                                            }#}
                                    {#                                        }, 1000);#}
                                    {#                                    {% endif %}#}
                                    {#                                </script>#}

                                </div>

                                <hr>
                                <div class="row m-4">
                                    <h3 class="text-muted"> Suivie de Soins </h3>

                                    <div class="row col-12">

                                       
                                        <div class="col-xl-12" id="constantesChart"></div>


                                    </div>

                                    <div class="row col-12">
                                    
                                        <!-- Constantes Card -->
                                        <!-- Tableau des constantes -->
                                    
                                        <div class="col-12 col-md-12 mb-5">
                                            <div class="card text-black-100 border">
                                                <div class="card-header">
                                                    Constantes
                                                    {% if not hospitalisationdetail.discharge_date %}
                                                        <button type="button"
                                                                class="btn btn-dark btn-icon btn-round float-right"
                                                                data-toggle="modal" data-target="#constanteModal">
                                                            <em class="icon ni ni-plus-circle-fill"></em>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                                <div class="card-inner text-black-70">
                                                    <table class="table">
                                                        <thead>
                                                        <tr>
                                                            <th>Constantes</th>
                                                            <th>Date</th>
                                                            <th>Medecin</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        
                                                        {% if constantes %}
                                                            {% for constante in constantes %}
                                                                <tr class="{% if forloop.counter > 3 %}constante-data d-none{% endif %}">
                                                                    <td>
                                <span class="badge badge-outline-dark">
                                    Tension: {{ constante.tension_systolique }} ts / {{ constante.tension_diastolique }} td - mmHg
                                </span><br>
                                                                        <span class="badge badge-outline-dark">Température | {{ constante.temperature }} °C</span>
                                                                    </td>
                                                                    <td>
                                                                        <span>{{ constante.created_at }}</span>
                                                                    </td>

                                                                    <td>
                                                                        <span>{{ constante.created_by }}</span>
                                                                    </td>
                                                                    <td>
                                <span>
                                    <a href="#" class="btn btn-primary btn-icon btn-round btn-xs"><em
                                            class="icon ni ni-eye"></em></a>
                                    <a class="btn btn-outline-info btn-icon btn-round btn-xs"
                                       href="{% url 'export_constante_pdf' hospitalisationdetail.id %}"><em
                                            class="icon ni ni-download-cloud ml-10"></em></a>
                                    <a href="#" class="btn btn-danger btn-icon btn-round btn-xs"><em
                                            class="icon ni ni-trash-fill"></em></a>
                                </span>
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        {% else %}
                                                            <tr>
                                                                <td colspan="3"
                                                                    style="font-style: italic; text-align: center"
                                                                    class="text-white">
                                                                    Aucune donnée enregistrée
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                        </tbody>
                                                    </table>
                                                    <!-- Bouton pour afficher plus ou moins de données -->
                                                    {% if constantes|length > 3 %}
                                                        <div class="text-center mt-3">
                                                            <button id="toggleButtonConstantes"
                                                                    class="btn btn-secondary">
                                                                Voir plus
                                                            </button>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- JavaScript pour le tableau des constantes -->
                                        <script>
                                            document.addEventListener('DOMContentLoaded', function () {
                                                const toggleButtonConstantes = document.getElementById('toggleButtonConstantes');
                                                const constanteDataRows = document.querySelectorAll('.constante-data');
                                                let isExpandedConstantes = false;

                                                toggleButtonConstantes.addEventListener('click', function () {
                                                    if (isExpandedConstantes) {
                                                        constanteDataRows.forEach(row => row.classList.add('d-none'));
                                                        toggleButtonConstantes.textContent = 'Voir plus';
                                                    } else {
                                                        constanteDataRows.forEach(row => row.classList.remove('d-none'));
                                                        toggleButtonConstantes.textContent = 'Voir moins';
                                                    }
                                                    isExpandedConstantes = !isExpandedConstantes;
                                                });
                                            });
                                        </script>

                                        <!-- Constante Form Modal -->
                                        <div class="modal fade" id="constanteModal" tabindex="-1"
                                             aria-labelledby="constanteModalLabel" aria-hidden="true">
                                            <div class="modal-dialog modal-lg">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="constanteModalLabel">Nouvelles
                                                            Constante</h5>
                                                        <button type="button" class="btn btn-close"
                                                                data-bs-dismiss="modal"
                                                                aria-label="Close">X
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="row">
                                                            <form method="post"
                                                                  action="{% url 'hospitalisationdetails' hospitalisationdetail.id %}">
                                                                {% csrf_token %}
                                                                <div class="row">
                                                                    {% for field in constante_form %}
                                                                        <div class="col-md-6 mb-3">
                                                                            <div class="form-group">
                                                                                <label class="form-label"
                                                                                       for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                                                <div class="form-control-wrap">
                                                                                    {{ field }}
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    {% endfor %}
                                                                </div>
                                                                <button type="submit"
                                                                        class="btn btn-primary float-right">
                                                                    Enregistrer
                                                                </button>
                                                            </form>
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Calendrier de prise de médicaments -->
                                        <div class="col-12 col-md-12 mb-5">
                                            <div class="card card-bordered">
                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                    <h5 class="card-title mb-0">
                                                        <i class="fas fa-calendar-alt text-primary me-2"></i>
                                                        Calendrier des prises médicamenteuses
                                                    </h5>
                                                    <div class="d-flex align-items-center">
                <span class="badge badge-sm badge-success me-2">
                    <i class="fas fa-circle me-1"></i> Pris
                </span>
                                                        <span class="badge badge-sm badge-danger me-2">
                    <i class="fas fa-circle me-1"></i> Non pris
                </span>
                                                        <span class="badge badge-sm badge-secondary">
                    <i class="fas fa-circle me-1"></i> À venir
                </span>
                                                    </div>
                                                </div>
                                                <div class="card-inner">
                                                    <!-- Filtres et navigation -->
                                                    <div class="row mb-4">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label class="form-label">Filtrer par médicament</label>
                                                                <select class="form-select" id="medicationFilter">
                                                                    <option value="">Tous les médicaments</option>
                                                                    {% for prescription in prescriptions %}
                                                                        <option value="{{ prescription.medication.nom|slugify }}">
                                                                            {{ prescription.medication.nom }}
                                                                        </option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label class="form-label">Période</label>
                                                                <select class="form-select" id="periodFilter">
                                                                    <option value="7">7 prochains jours</option>
                                                                    <option value="14">14 prochains jours</option>
                                                                    <option value="30">30 prochains jours</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Calendrier -->
                                                    <div class="table-responsive">
                                                        <table class="table table-bordered table-calendar">
                                                            <thead class="table-light">
                                                            <tr>
                                                                <th style="min-width: 200px;">Médicament</th>
                                                                {% for day in calendar_days %}
                                                                    <th class="text-center" style="min-width: 150px;">
                                                                        <div class="fw-bold">{{ day.date|date:"d/m" }}</div>
                                                                        <div class="small text-muted">{{ day.date|date:"l" }}</div>
                                                                    </th>
                                                                {% endfor %}
                                                            </tr>
                                                            <tr>
                                                                <th></th>
                                                                {% for day in calendar_days %}
                                                                    <th class="text-center small">
                                                                        <div class="d-flex justify-content-around">
                                                                            <span>Matin</span>
                                                                            <span>Midi</span>
                                                                            <span>Soir</span>
                                                                        </div>
                                                                    </th>
                                                                {% endfor %}
                                                            </tr>
                                                            </thead>
                                                            <tbody>
                                                            {% for prescription in prescriptions %}
                                                                <tr class="medication-row"
                                                                    data-medication="{{ prescription.medication.nom|slugify }}">
                                                                    <td>
                                                                        <div class="d-flex align-items-center">
                                                                            <div class="flex-shrink-0">
                                                                                <i class="fas fa-pills text-primary me-2"></i>
                                                                            </div>
                                                                            <div class="flex-grow-1">
                                                                                <strong>{{ prescription.medication.nom }}</strong>
                                                                                <div class="small text-muted">
                                                                                    {{ prescription.posology }}
                                                                                    • {{ prescription.quantity }} unités
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                    {% for day in calendar_days %}
                                                                        <td>
                                                                            <div class="d-flex justify-content-around py-2">
                                                                                {% for time_slot in day.time_slots %}
                                                                                    {% with execution=prescription|get_execution_for_day:day.date|get_execution_for_time:time_slot %}
                                                                                        <div class="time-slot position-relative">
                                                                                            {% if execution %}
                                                                                                {% if execution.status == 'Taken' %}
                                                                                                    <span class="badge badge-dot badge-lg badge-success"
                                                                                                          data-toggle="tooltip"
                                                                                                          title="Pris à {{ execution.executed_at|time }}">
                                                                    <i class="fas fa-check"></i>
                                                                </span>
                                                                                                {% elif execution.status == 'Missed' %}
                                                                                                    <span class="badge badge-dot badge-lg badge-danger"
                                                                                                          data-toggle="tooltip"
                                                                                                          title="Prise manquée">
                                                                    <i class="fas fa-times-circle"></i>
                                                                </span>
                                                                                                {% elif execution.status == 'Pending' and day.is_past %}
                                                                                                    <span class="badge badge-dot badge-lg badge-warning"
                                                                                                          data-toggle="tooltip"
                                                                                                          title="En retard">
                                                                    <i class="fas fa-clock"></i>
                                                                </span>
                                                                                                {% else %}
                                                                                                    <span class="badge badge-dot badge-lg badge-secondary"
                                                                                                          data-toggle="tooltip"
                                                                                                          title="À prendre {% if execution.scheduled_time %} le {{ execution.scheduled_time|date:'d/m/Y' }} à {{ execution.scheduled_time|time:'H:i' }}{% endif %} ">
                                                                    <i class="fas fa-clock"></i>
                                                                </span>
                                                                                                {% endif %}
                                                                                            {% else %}
                                                                                                <span class="badge badge-dot badge-lg badge-light"
                                                                                                      data-toggle="tooltip"
                                                                                                      title="Non programmé">
                                                                <i class="fas fa-minus"></i>
                                                            </span>
                                                                                            {% endif %}
                                                                                        </div>
                                                                                    {% endwith %}
                                                                                {% endfor %}
                                                                            </div>
                                                                        </td>
                                                                    {% endfor %}
                                                                </tr>
                                                            {% empty %}
                                                                <tr>
                                                                    <td colspan="{{ calendar_days|length|add:1 }}"
                                                                        class="text-center text-muted py-4">
                                                                        <i class="fas fa-pills fa-2x mb-3"></i>
                                                                        <p>Aucune prescription active</p>
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>

                                                    <!-- Légende et statistiques -->
                                                    <div class="row mt-4">
                                                        <div class="col-md-6">
                                                            <div class="d-flex flex-wrap gap-3">
                                                                <div class="d-flex align-items-center">
                                                                    <span class="badge badge-dot badge-lg badge-success me-2"></span>
                                                                    <small>Pris</small>
                                                                </div>
                                                                <div class="d-flex align-items-center">
                                                                    <span class="badge badge-dot badge-lg badge-danger me-2"></span>
                                                                    <small>Non pris</small>
                                                                </div>
                                                                <div class="d-flex align-items-center">
                                                                    <span class="badge badge-dot badge-lg badge-warning me-2"></span>
                                                                    <small>En retard</small>
                                                                </div>
                                                                <div class="d-flex align-items-center">
                                                                    <span class="badge badge-dot badge-lg badge-secondary me-2"></span>
                                                                    <small>À venir</small>
                                                                </div>
                                                                <div class="d-flex align-items-center">
                                                                    <span class="badge badge-dot badge-lg badge-light me-2"></span>
                                                                    <small>Non programmé</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6 text-end">
                                                            <div class="text-muted small">
                                                                <i class="fas fa-sync-alt me-1"></i>
                                                                Dernière mise à jour : {% now "H:i" %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Styles CSS pour le calendrier -->
                                    
                                        <style>
                                            .table-calendar {
                                                font-size: 0.875rem;
                                            }

                                            .badge-dot {
                                                width: 24px;
                                                height: 24px;
                                                border-radius: 50%;
                                                display: inline-flex;
                                                align-items: center;
                                                justify-content: center;
                                                font-size: 0.75rem;
                                            }

                                            .badge-dot.badge-lg {
                                                width: 28px;
                                                height: 28px;
                                            }

                                            .time-slot {
                                                cursor: pointer;
                                                transition: transform 0.2s ease;
                                            }

                                            .time-slot:hover {
                                                transform: scale(1.1);
                                            }

                                            .medication-row {
                                                transition: background-color 0.3s ease;
                                            }

                                            .medication-row:hover {
                                                background-color: #f8f9fa;
                                            }

                                            .table-calendar th {
                                                background-color: #f8f9fa;
                                                border-bottom: 2px solid #dee2e6;
                                            }

                                            .table-calendar td {
                                                vertical-align: middle;
                                            }

                                            /* Couleurs des badges */
                                            .badge-success {
                                                background-color: #28a745;
                                            }

                                            .badge-danger {
                                                background-color: #dc3545;
                                            }

                                            .badge-warning {
                                                background-color: #ffc107;
                                                color: #000;
                                            }

                                            .badge-secondary {
                                                background-color: #6c757d;
                                            }

                                            .badge-light {
                                                background-color: #e9ecef;
                                                color: #6c757d;
                                            }

                                            /* Responsive */
                                            @media (max-width: 768px) {
                                                .table-calendar {
                                                    font-size: 0.75rem;
                                                }

                                                .badge-dot {
                                                    width: 20px;
                                                    height: 20px;
                                                }

                                                .badge-dot.badge-lg {
                                                    width: 22px;
                                                    height: 22px;
                                                }
                                            }
                                        </style>

                                        <!-- Script JavaScript pour l'interactivité -->
                                        <script>
                                            document.addEventListener('DOMContentLoaded', function () {
                                                // Filtrage des médicaments
                                                const medicationFilter = document.getElementById('medicationFilter');
                                                const medicationRows = document.querySelectorAll('.medication-row');

                                                medicationFilter.addEventListener('change', function () {
                                                    const selectedMedication = this.value;

                                                    medicationRows.forEach(row => {
                                                        if (!selectedMedication || row.dataset.medication === selectedMedication) {
                                                            row.style.display = '';
                                                        } else {
                                                            row.style.display = 'none';
                                                        }
                                                    });
                                                });

                                                // Gestion du changement de période
                                                const periodFilter = document.getElementById('periodFilter');
                                                periodFilter.addEventListener('change', function () {
                                                    // Ici vous pouvez recharger le calendrier avec la nouvelle période
                                                    const days = this.value;
                                                    window.location.href = `?period=${days}`;
                                                });

                                                // Initialisation des tooltips Bootstrap
                                                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                                                const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                                                    return new bootstrap.Tooltip(tooltipTriggerEl);
                                                });

                                                // Clic sur une prise pour marquer comme pris/non pris
                                                const timeSlots = document.querySelectorAll('.time-slot');
                                                timeSlots.forEach(slot => {
                                                    slot.addEventListener('click', function () {
                                                        const badge = this.querySelector('.badge');
                                                        const executionId = this.dataset.executionId;

                                                        if (executionId && badge.classList.contains('badge-secondary')) {
                                                            // Marquer comme pris
                                                            if (confirm('Marquer cette prise comme effectuée ?')) {
                                                                markExecutionAsTaken(executionId, this);
                                                            }
                                                        }
                                                    });
                                                });

                                                function markExecutionAsTaken(executionId, element) {
                                                    // Simulation d'appel AJAX
                                                    fetch(`/mark-execution-taken/${executionId}/`, {
                                                        method: 'POST',
                                                        headers: {
                                                            'X-CSRFToken': getCookie('csrftoken'),
                                                            'Content-Type': 'application/json',
                                                        },
                                                    })
                                                        .then(response => response.json())
                                                        .then(data => {
                                                            if (data.success) {
                                                                const badge = element.querySelector('.badge');
                                                                badge.className = 'badge badge-dot badge-lg badge-success';
                                                                badge.innerHTML = '<i class="fas fa-check"></i>';
                                                                badge.setAttribute('data-bs-original-title', `Pris à ${new Date().toLocaleTimeString()}`);

                                                                // Mettre à jour le tooltip
                                                                const tooltip = bootstrap.Tooltip.getInstance(element);
                                                                if (tooltip) {
                                                                    tooltip.dispose();
                                                                    new bootstrap.Tooltip(element);
                                                                }
                                                            }
                                                        })
                                                        .catch(error => console.error('Error:', error));
                                                }

                                                // Fonction utilitaire pour récupérer le token CSRF
                                                function getCookie(name) {
                                                    let cookieValue = null;
                                                    if (document.cookie && document.cookie !== '') {
                                                        const cookies = document.cookie.split(';');
                                                        for (let i = 0; i < cookies.length; i++) {
                                                            const cookie = cookies[i].trim();
                                                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                                                break;
                                                            }
                                                        }
                                                    }
                                                    return cookieValue;
                                                }
                                            });
                                        </script>
                                        <!-- Executes prescriptions -->
                                    
                                        <div class="col-12 col-md-12 mb-5">
                                            <div class="card text-black-100 border">
                                                <div class="card-header d-flex justify-content-between">
                                                    <h5 class="card-title">Suivi des soins prescrits</h5>

                                                </div>
                                                <div class="card-inner text-black-70">
                                                    <table class="table table-bordered table-responsive-md">
                                                        <thead>
                                                        <tr>
                                                            <th>Médicament</th>
                                                            <th>Heure Prévue</th>
                                                            <th>Heure Réelle</th>
                                                            <th>Durée</th>
                                                            <th>Status</th>
                                                            <th>Infirmier(ère)</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        {% for execution in executions %}
                                                            <tr class="{% if forloop.counter > 5 %}prescription-suivi-data d-none{% endif %}">
                                                                <td>{{ execution.prescription.medication.nom }}</td>
                                                                <td>{{ execution.scheduled_time|naturaltime }}</td>
                                                                <td>
                                                                    {% if execution.executed_at %}
                                                                        {{ execution.executed_at|naturaltime }}
                                                                    {% else %}
                                                                        Non prise
                                                                    {% endif %}
                                                                </td>
                                                                <td>{{ execution.prescription.pendant }} Jours</td>
                                                                <td>
                                <span class="badge
                                    {% if execution.status == 'Pending' %}badge-warning
                                    {% elif execution.status == 'Taken' %}badge-success
                                    {% else %}badge-danger{% endif %}">
                                    {{ execution.get_status_display }}
                                </span>
                                                                </td>
                                                                <td>
                                                                    {% if execution.executed_by %}
                                                                        {{ execution.executed_by }}
                                                                    {% else %}
                                                                        Non attribué
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    {% if execution.status == 'Pending' %}
                                                                        <form method="post"
                                                                              action="{% url 'mark_execution_taken' %}">
                                                                            {% csrf_token %}
                                                                            <input type="hidden" name="execution_id"
                                                                                   value="{{ execution.id }}">
                                                                            <button type="submit"
                                                                                    class="btn btn-primary btn-sm">
                                                                                Marquer comme pris
                                                                            </button>
                                                                        </form>

                                                                    {% else %}
                                                                        <button class="btn btn-secondary btn-sm"
                                                                                disabled>Inactif
                                                                        </button>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                        </tbody>
                                                    </table>
                                                    {% if executions|length > 5 %}
                                                        <div class="text-center mt-3">
                                                            <button id="toggleButtonPrescriptionssuivi"
                                                                    class="btn btn-secondary">
                                                                Voir plus
                                                            </button>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>

                                        <script>
                                            document.addEventListener('DOMContentLoaded', function () {
                                                const toggleButton = document.getElementById('toggleButtonPrescriptionssuivi');
                                                const hiddenRows = document.querySelectorAll('.prescription-suivi-data');
                                                let isExpanded = false;

                                                toggleButton.addEventListener('click', function () {
                                                    hiddenRows.forEach(row => row.classList.toggle('d-none'));
                                                    isExpanded = !isExpanded;
                                                    toggleButton.textContent = isExpanded ? 'Voir moins' : 'Voir plus';
                                                });
                                            });
                                        </script>

                                        <!-- Prescription Card -->
                                        <!-- Tableau des prescriptions -->
                                        <div class="col-12 col-md-12 mb-5">
                                            <div class="card text-black-100 border">
                                                <div class="card-header">
                                                    Prescriptions
                                                    <a class="btn btn-outline-info btn-icon btn-round mr-5"
                                                       href="{% url 'generate_ordonnance_pdf' patient_id=hospitalisationdetail.patient.id hospitalisation_id=hospitalisationdetail.id %}"><em
                                                            class="icon ni ni-printer-fill"></em></a>
                                                    {% if not hospitalisationdetail.discharge_date %}
                                                        <button type="button"
                                                                class="btn btn-dark btn-icon btn-round float-right"
                                                                data-toggle="modal" data-target="#prescriptionModal">
                                                            <em class="icon ni ni-plus-circle-fill"></em>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                                <div class="card-inner text-black-70">
                                                    <table class="table table-responsive-md">
                                                        <thead>
                                                        <tr>

                                                            <th>Médicaments</th>
                                                            <th>Posology</th>
                                                            {#                                                        <th>Pendant</th>#}
                                                            <th>Date creation</th>
                                                            <th>Status</th>
                                                            <th>Medecin</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>

                                                        {% if prescriptions %}
                                                            {% for prescription in prescriptions %}
                                                                <tr class="{% if forloop.counter > 5 %}prescription-data d-none{% endif %}">
                                                                    <td>
                                                                        {% if prescription.medication.dosage_form == 'comprime' %}
                                                                            <img src="{% static 'images/comprimes.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'sirop' %}
                                                                            <img src="{% static 'images/sirop.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'injection' %}
                                                                            <img src="{% static 'images/seringue.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'gelule' %}
                                                                            <img src="{% static 'images/gelules.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'creme' %}
                                                                            <img src="{% static 'images/pommade.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'pommade' %}
                                                                            <img src="{% static 'images/pommade.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'suppositoire' %}
                                                                            <img src="{% static 'images/suppositoire.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'gouttes' %}
                                                                            <img src="{% static 'images/goutte-deau.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'patch' %}
                                                                            <img src="{% static 'images/patch.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'inhalateur' %}
                                                                            <img src="{% static 'images/spray-de-peinture.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'solution' %}
                                                                            <img src="{% static 'images/solution.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'suspension' %}
                                                                            <img src="{% static 'images/suspension.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'poudre' %}
                                                                            <img src="{% static 'images/poudre-de-talc.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'spray' %}
                                                                            <img src="{% static 'images/spray-de-peinture.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'ovule' %}
                                                                            <img src="{% static 'images/ovule.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'collyre' %}
                                                                            <img src="{% static 'images/collyre.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'aerosol' %}
                                                                            <img src="{% static 'images/aerosol.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'elixir' %}
                                                                            <img src="{% static 'images/elixir.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'baume' %}
                                                                            <img src="{% static 'images/baume.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'granule' %}
                                                                            <img src="{% static 'images/granule.png' %}"
                                                                                 width="20">
                                                                        {% elif prescription.medication.dosage_form == 'capsule' %}
                                                                            <img src="{% static 'images/capsule.png' %}"
                                                                                 width="20">
                                                                        {% endif %}
                                                                        <span class="badge badge-dark">{{ prescription.medication }}</span><br>
                                                                    </td>

                                                                    <td> {{ prescription.quantity }} {{ prescription.medication.dosage_form }}(s),{{ prescription.posology }}, {{ prescription.pendant }}
                                                                        Jours
                                                                    </td>
                                                                    {#                                                                <td><span>{{ prescription.pendant }} Jours</span></td>#}

                                                                    <td><span>{{ prescription.created_at }}</span></td>
                                                                    <td>
    <span class="badge badge-xs
{% if prescription.status == 'Pending' %}badge-warning
                                    {% elif prescription.status == 'Taken' %}badge-success
                                    {% else %}badge-danger{% endif %}">
    {% if prescription.status == 'Cancelled' %}

        <span data-toggle="tooltip" data-placement="top"
              data-bs-original-title="Annuler le {{ prescription.cancellation_date }} pour motif : {{ prescription.cancellation_reason }} par : {{ prescription.cancellation_by }} ">{{ prescription.get_status_display }}</span>

    {% else %}
        {{ prescription.get_status_display }}
    {% endif %}
                                </span>
                                                                    </td>
                                                                    <td>
                                                                        <span>{{ prescription.created_by.user.get_full_name }}</span>
                                                                    </td>
                                                                    <td>
                                                                        {% if prescription.status == "Pending" %}
                                                                            <form method="post"
                                                                                  action="{% url 'delete_prescription' prescription.id %}"
                                                                                  style="display:inline;">
                                                                                {% csrf_token %}
                                                                                <button type="submit"
                                                                                        class="btn btn-danger btn-icon btn-round btn-xs"
                                                                                        onclick="return confirm('Voulez-vous vraiment supprimer cette prescription ?')">
                                                                                    <em class="icon ni ni-trash-fill"></em>
                                                                                </button>
                                                                            </form>
                                                                        {% endif %}
                                                                        <form method="post"
                                                                              action="{% url 'stop_traitement' prescription.id %}"
                                                                              style="display:inline;">

                                                                            {% csrf_token %}
                                                                            <button type="button"
                                                                                    class="btn btn-primary btn-icon btn-round btn-xs ml-2"
                                                                                    onclick="askCancellationReason(event, this)">
                                                                                <em class="icon ni ni-stop-fill"></em>
                                                                            </button>
                                                                            <input type="hidden"
                                                                                   name="cancellation_reason"
                                                                                   id="cancellation_reason_{{ prescription.id }}">
                                                                        </form>

                                                                        <script>
                                                                            function askCancellationReason(event, button) {
                                                                                event.preventDefault();  // Empêche la soumission automatique du formulaire

                                                                                let reason = prompt("Veuillez entrer un motif pour l'annulation de cette prescription :");

                                                                                if (reason !== null && reason.trim() !== "") {
                                                                                    let form = button.closest("form");  // Trouve le formulaire parent
                                                                                    let inputField = form.querySelector("[name='cancellation_reason']");
                                                                                    inputField.value = reason;
                                                                                    form.submit();  // Soumet le formulaire avec la raison
                                                                                } else {
                                                                                    alert("L'annulation a été annulée car aucun motif n'a été fourni.");
                                                                                }
                                                                            }
                                                                        </script>
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        {% else %}
                                                            <tr>
                                                                <td colspan="4"
                                                                    style="font-style: italic; text-align: center"
                                                                    class="text-white">
                                                                    Aucune donnée enregistrée
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                        </tbody>
                                                    </table>
                                                    <!-- Bouton pour afficher plus ou moins de données -->
                                                    {% if prescriptions|length > 5 %}
                                                        <div class="text-center mt-3">
                                                            <button id="toggleButtonPrescriptions"
                                                                    class="btn btn-secondary">Voir plus
                                                            </button>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>


                                        <!-- JavaScript pour le tableau des prescriptions -->
                                        <script>
                                            document.addEventListener('DOMContentLoaded', function () {
                                                const toggleButtonPrescriptions = document.getElementById('toggleButtonPrescriptions');
                                                const prescriptionDataRows = document.querySelectorAll('.prescription-data');
                                                let isExpandedPrescriptions = false;

                                                toggleButtonPrescriptions.addEventListener('click', function () {
                                                    if (isExpandedPrescriptions) {
                                                        prescriptionDataRows.forEach(row => row.classList.add('d-none'));
                                                        toggleButtonPrescriptions.textContent = 'Voir plus';
                                                    } else {
                                                        prescriptionDataRows.forEach(row => row.classList.remove('d-none'));
                                                        toggleButtonPrescriptions.textContent = 'Voir moins';
                                                    }
                                                    isExpandedPrescriptions = !isExpandedPrescriptions;
                                                });
                                            });
                                        </script>

                                        <!-- Prescriptions Form Modal -->
                                        {#                                    <div class="modal fade" id="prescriptionModal" tabindex="-1" aria-labelledby="prescriptionModalLabel" aria-hidden="true">#}
                                        {#                                        <div class="modal-dialog modal-lg">#}
                                        {#                                            <div class="modal-content">#}
                                        {#                                                <div class="modal-header">#}
                                        {#                                                    <h5 class="modal-title" id="prescriptionModalLabel">Nouvelles Prescription</h5>#}
                                        {#                                                    <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close">X</button>#}
                                        {#                                                </div>#}
                                        {#                                                <div class="modal-body">#}
                                        {#                                                    <div class="row">#}
                                        {#                                                        <form method="post" id="form-prescription" action="{% url 'hospitalisationdetails' hospitalisationdetail.id %}">#}
                                        {#                                                            {% csrf_token %}#}
                                        {#                                                          #}
                                        {#                                                            <div class="row">#}
                                        {#                                                                {% for field in prescription_hospi_form %}#}
                                        {#                                                                    <div class="col-md-3 mb-3">#}
                                        {#                                                                        <div class="form-group">#}
                                        {#                                                                            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>#}
                                        {#                                                                            <div class="form-control-wrap">#}
                                        {#                                                                                {{ field }}#}
                                        {#                                                                            </div>#}
                                        {#                                                                        </div>#}
                                        {#                                                                    </div>#}
                                        {#                                                                {% endfor %}#}
                                        {#                                                            </div>#}
                                        {#                                                            <button type="submit" class="btn btn-primary float-right">Enregistrer</button>#}
                                        {#                                                        </form>#}
                                        {#                                                    </div>#}
                                        {##}
                                        {#                                                </div>#}
                                        {#                                            </div>#}
                                        {#                                        </div>#}
                                        {#                                    </div>#}
                                        <div class="modal fade" id="prescriptionModal" tabindex="-1"
                                             aria-labelledby="prescriptionModalLabel" aria-hidden="true">
                                            <div class="modal-dialog modal-lg">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="prescriptionModalLabel">Nouvelle
                                                            Prescription</h5>
                                                        <button type="button" class="btn btn-close"
                                                                data-bs-dismiss="modal" aria-label="Close">X
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">

                                                        <div x-data="prescriptionForm()" class="row">
                                                            <div x-show="errorMessage" class="alert alert-danger">
                                                                <span x-text="errorMessage"></span>
                                                            </div>
                                                            <form method="post" id="form-prescription"
                                                                  x-on:submit.prevent="submitForm">
                                                                {% csrf_token %}
                                                                <input type="hidden" name="patient_id"
                                                                       x-model="patientId">
                                                                <!-- ✅ Ajout du patient ID -->
                                                                <input type="hidden" name="hospitalisation_id"
                                                                       x-model="hospitalisationId">
                                                                <!-- ✅ Ajout de l'hospitalisation ID -->
                                                                <div class="row">
                                                                    <!-- Champ de recherche dynamique pour le médicament -->
                                                                    <div class="col-md-8 mb-3">
                                                                        <label class="form-label">Médicament</label>
                                                                        <input type="text" class="form-control"
                                                                               x-model="search"
                                                                               x-on:input="fetchMedications()"
                                                                               placeholder="Ex: Nivaquine comprime 500 mg"
                                                                               autocomplete="off"
                                                                               required/>
                                                                        <!-- Liste des suggestions -->
                                                                        <ul x-show="results.length > 0"
                                                                            class="list-group mt-2">
                                                                            <template x-for="med in results"
                                                                                      :key="med.id">
                                                                                <li class="list-group-item list-group-item-action"
                                                                                    x-text="`${med.nom} ${(med.dosage_form ? med.dosage_form : '')} ${(med.dosage ? med.dosage : '')} ${(med.unitdosage ? med.unitdosage : '')}`.trim()"
                                                                                    x-on:click="selectMedication(med)">
                                                                                </li>
                                                                            </template>
                                                                        </ul>
                                                                    </div>

                                                                    <!-- Quantité -->
                                                                    <div class="col-md-4 mb-3">
                                                                        <label class="form-label">Quantité</label>
                                                                        <input type="number" class="form-control"
                                                                               name="quantity"
                                                                               placeholder="Entrez la quantité"
                                                                               required/>
                                                                    </div>

                                                                    <!-- Posologie -->
                                                                    <div class="col-md-4 mb-3">
                                                                        <label class="form-label">Posologie</label>
                                                                        <select class="form-control" name="posology"
                                                                                required>
                                                                            <option value="">Sélectionnez la posologie
                                                                            </option>
                                                                            <option value="Une fois par jour">Une fois
                                                                                par jour
                                                                            </option>
                                                                            <option value="Deux fois par jour">Deux fois
                                                                                par jour
                                                                            </option>
                                                                            <option value="Trois fois par jour">Trois
                                                                                fois par jour
                                                                            </option>
                                                                            <option value="Quatre fois par jour">Quatre
                                                                                fois par jour
                                                                            </option>
                                                                            <option value="Toutes les 4 heures">Toutes
                                                                                les 4 heures
                                                                            </option>
                                                                            <option value="Toutes les 6 heures">Toutes
                                                                                les 6 heures
                                                                            </option>
                                                                            <option value="Toutes les 8 heures">Toutes
                                                                                les 8 heures
                                                                            </option>
                                                                            <option value="Si besoin">Si besoin</option>
                                                                            <option value="Avant les repas">Avant les
                                                                                repas
                                                                            </option>
                                                                            <option value="Après les repas">Après les
                                                                                repas
                                                                            </option>
                                                                            <option value="Au coucher">Au coucher
                                                                            </option>
                                                                            <option value="Une fois par semaine">Une
                                                                                fois par semaine
                                                                            </option>
                                                                            <option value="Deux fois par semaine">Deux
                                                                                fois par semaine
                                                                            </option>
                                                                            <option value="Un jour sur deux">Un jour sur
                                                                                deux
                                                                            </option>
                                                                            ,
                                                                        </select>
                                                                    </div>

                                                                    <!-- Pendant -->
                                                                    <div class="col-md-4 mb-3">
                                                                        <label class="form-label">Pendant</label>
                                                                        <select class="form-control" name="pendant">
                                                                            <option value="">Sélectionnez</option>
                                                                            <option value="1">1 jours</option>
                                                                            <option value="2">2 jours</option>
                                                                            <option value="3">3 jours</option>
                                                                            <option value="4">4 jours</option>
                                                                            <option value="5">5 jours</option>
                                                                            <option value="6">6 jours</option>
                                                                            <option value="7">7 jours</option>
                                                                            <option value="8">8 jours</option>
                                                                            <option value="9">9 jours</option>
                                                                            <option value="10">10 jours</option>
                                                                            <option value="14">14 jours</option>
                                                                            <option value="21">21 jours</option>
                                                                            <option value="30">30 jours</option>
                                                                        </select>
                                                                    </div>

                                                                    <!-- À partir de -->
                                                                    <div class="col-md-4 mb-3">
                                                                        <label class="form-label">À partir de</label>
                                                                        <select class="form-control" name="a_partir_de">
                                                                            <option value="">Sélectionnez</option>
                                                                            <option value="0">Maintenant</option>
                                                                            <option value="1">dans 1 heure</option>
                                                                            <option value="2">dans 2 heures</option>
                                                                            <option value="3">dans 3 heures</option>
                                                                            <option value="4">dans 4 heures</option>
                                                                            <option value="5">dans 5 heures</option>
                                                                            <option value="6">dans 6 heures</option>
                                                                            <option value="7">dans 7 heures</option>
                                                                            <option value="8">dans 8 heures</option>
                                                                            <option value="12">dans 12 heures</option>
                                                                            <option value="24">dans 24 heures</option>
                                                                            <option value="48">dans 48 heures</option>
                                                                            <option value="72">dans 72 heures</option>
                                                                        </select>
                                                                    </div>
                                                                </div>

                                                                <!-- Champ caché pour indiquer si c'est un nouveau médicament -->
                                                                <input type="hidden" name="is_new_medication"
                                                                       x-model="isNewMedication">
                                                                <button type="submit"
                                                                        class="btn btn-success float-right">Enregistrer
                                                                </button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Indicateurs Biologiques -->
                                <div class="row m-4">

                                    <h3 class="text-muted"> Indicateurs de suivi de bilan Paraclinique </h3>

                                    <div class="row col-12">
                                        <!-- Indicateur Biologique Card -->
                                        <div class="col-12 col-md-12 mb-5">

                                            <div id="evolutionCharts"></div>


                                        </div>
                                        <div class="col-6">
                                            <div id="chart-examens-type"></div>


                                        </div>
                                        <div class="col-6">
                                            <div id="chart-status-examens"></div>
                                        </div>
                                        <div class="col-6">
                                            <div id="chart-examens-jour"></div>
                                        </div>
                                        <div class="col-6">
                                            <div id="chart-resultats-examens"></div>
                                        </div>

                                    </div>


                                </div>


                                <!-- Indicateurs  de Complications & de Traitement  -->

                                <div class="row m-4">

                                    <h3 class="text-muted"> Indicateurs de Complications & de Traitement </h3>


                                    <div class="row col-12">
                                        <div class="col-12">

                                        </div>
                                        <div class="col-3 col-md-3 mb-5">
                                            <div id="mental-state-chart"></div>
                                        </div>
                                        <div class="col-3 col-md-3 mb-5">
                                            <div id="electrolytes-balance-chart"></div>
                                        </div>

                                        <div class="col-3 col-md-3 mb-5">
                                            <div id="renal-function-chart"></div>
                                        </div>
                                        <div class="col-3 col-md-3 mb-5">
                                            <div id="hepatic-function-chart"></div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-12 mb-5">
                                        <div class="card text-black-100 border">
                                            <div class="card-header">
                                                Indicateurs Autres
                                                {% if not hospitalisationdetail.discharge_date %}
                                                    <button type="button"
                                                            class="btn btn-dark btn-icon btn-round float-right"
                                                            data-toggle="modal" data-target="#indicateurautresModal">
                                                        <em class="icon ni ni-plus-circle-fill"></em>
                                                    </button>
                                                {% endif %}
                                            </div>
                                            <div class="card-inner text-black-70">
                                                <h2 class="mb-4">Autres indicateurs d'Hospitalisation</h2>
                                                <table class="table table-bordered table-responsive">
                                                    <thead>
                                                    <tr>
                                                        <th>Niveau de Douleur</th>
                                                        <th>État de Conscience</th>
                                                        <th>Réponse au Traitement</th>
                                                        <th>Effets Secondaires</th>
                                                        <th>Observance</th>
                                                        <th>Équilibre Électrolytique</th>
                                                        <th>Fonction Rénale</th>
                                                        <th>Fonction Hépatique</th>
                                                        <th>Signes Vitaux Stables</th>
                                                        <th>Douleur Contrôlée</th>
                                                        <th>Capacité Fonctionnelle</th>
                                                        <th>État Mental Stable</th>
                                                        <th>Plan de Suivi</th>
                                                        <th>Date de Création</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for indicator in indicators %}
                                                        <tr>
                                                            <td>{{ indicator.pain_level }}</td>
                                                            <td>{{ indicator.get_mental_state_display }}</td>
                                                            <td>{{ indicator.treatment_response }}</td>
                                                            <td>{{ indicator.side_effects }}</td>
                                                            <td>{{ indicator.compliance|yesno:"Oui,Non" }}</td>
                                                            <td>{{ indicator.electrolytes_balance }}</td>
                                                            <td>{{ indicator.renal_function }}</td>
                                                            <td>{{ indicator.hepatic_function }}</td>
                                                            <td>{{ indicator.stable_vitals|yesno:"Oui,Non" }}</td>
                                                            <td>{{ indicator.pain_controlled|yesno:"Oui,Non" }}</td>
                                                            <td>{{ indicator.functional_ability|yesno:"Oui,Non" }}</td>
                                                            <td>{{ indicator.mental_stability|yesno:"Oui,Non" }}</td>
                                                            <td>{{ indicator.follow_up_plan }}</td>
                                                            <td>{{ indicator.created_at|date:"d/m/Y H:i" }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                            </div>

                            <div class="modal fade" id="indicateurautresModal" tabindex="-1"
                                 aria-labelledby="indicateurautresModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="indicateurautresModalLabel">Indicateurs
                                                autres</h5>
                                            <button type="button" class="btn btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close">X
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="row">
                                                <form method="post"
                                                      action="{% url 'hospitalisationdetails' hospitalisationdetail.id %}">
                                                    {% csrf_token %}
                                                    <div class="row">
                                                        {% for field in autresindicatorsform %}
                                                            <div class="col-md-6 mb-3">
                                                                <div class="form-group">
                                                                    <label class="form-label"
                                                                           for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                                    <div class="form-control-wrap">{{ field }}</div>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                    <button type="submit" class="btn btn-primary float-right">
                                                        Enregistrer
                                                    </button>
                                                </form>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div><!-- Indicateurs  de Traitement  -->


                        </div>
                        <!-- .card-inner-group -->
                    </div><!-- .card -->
                </div>
            </div>
        </div>

        <script>
            function prescriptionForm() {
                return {
                    search: '',
                    results: [],
                    selectedMedication: null,
                    isNewMedication: false,
                    errorMessage: '',
                    patientId: "{{ hospitalisationdetail.patient.id }}",
                    hospitalisationId: "{{ hospitalisationdetail.id }}",


                    fetchMedications() {
                        if (this.search.length < 2) {
                            this.results = [];
                            return;
                        }

                        fetch(`/apis/medicaments/?q=${this.search}`)
                            .then(response => response.json())
                            .then(data => {
                                this.results = data;
                                this.isNewMedication = this.results.length === 0;
                            })
                            .catch(error => console.error('❌ Erreur de récupération des médicaments:', error));
                    },

                    selectMedication(med) {
                        this.search = `${med.nom} ${(med.dosage_form ? med.dosage_form : '')} ${(med.dosage ? med.dosage : '')} ${(med.unitdosage ? med.unitdosage : '')}`.trim();
                        this.selectedMedication = med;
                        this.isNewMedication = false;
                        this.results = [];
                    },

                    submitForm() {
                        this.errorMessage = '';

                        let formData = new FormData(document.getElementById('form-prescription'));

                        // ✅ Ajout du patient ID
                        formData.append('patient_id', this.patientId);
                        formData.append('hospitalisation_id', this.hospitalisationId);
                        formData.append('medication', this.search);
                        formData.append('is_new_medication', this.isNewMedication);

                        fetch('/apis/prescription/add/', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}'
                            }
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert("✅ Prescription enregistrée !");
                                    window.location.reload();
                                } else {
                                    console.error("❌ Erreur lors de l'enregistrement:", data.error);
                                    this.errorMessage = "⚠️ " + data.error;
                                }
                            })
                            .catch(error => {
                                console.error('❌ Erreur AJAX:', error);
                                this.errorMessage = "Erreur réseau. Vérifiez votre connexion.";
                            });
                    }
                };
            }
        </script>
        <script>
            $(document).ready(function () {
                // Initialisation de Select2 avec l'option tags
                $('.select2').select2({
                    tags: true,
                    tokenSeparators: [',', ' '],
                    placeholder: "Choisissez ou ajoutez une maladie",
                    allowClear: true,
                    ajax: {
                        url: "{% url 'add_maladie' %}",
                        type: "POST",
                        dataType: "json",
                        delay: 250,
                        data: function (params) {
                            return {
                                nom: params.term, // Le terme recherché ou ajouté
                                csrfmiddlewaretoken: '{{ csrf_token }}' // Token CSRF pour sécuriser la requête
                            };
                        },
                        processResults: function (data) {
                            if (data.success) {
                                return {
                                    results: [
                                        {id: data.id, text: data.nom}
                                    ]
                                };
                            } else {
                                alert(data.message);
                                return {results: []};
                            }
                        },
                    },
                });
            });
        </script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Reinitialiser TinyMCE quand le modal est affiché
                $('#adddiagnosticModal').on('shown.bs.modal', function () {
                    tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                    tinymce.init({
                        selector: '.tinymce-basic',
                        plugins: 'advlist autolink lists link charmap print preview anchor',
                        toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                        menubar: false,
                        height: 300,
                    });
                });
            });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                let evolutionData = JSON.parse('{{ evolution_bilans_json|safe }}');

                Object.keys(evolutionData).forEach((type_bilan, index) => {
                    let chartContainer = document.createElement("div");
                    chartContainer.innerHTML = `<h4 class="mt-4">${type_bilan}</h4><div id="chart_${index}" class="mb-4"></div>`;
                    document.getElementById("evolutionCharts").appendChild(chartContainer);

                    let seriesData = [];

                    Object.keys(evolutionData[type_bilan]).forEach(examen => {
                        let dataPoints = evolutionData[type_bilan][examen].map(item => ({
                            x: item.date,
                            y: parseFloat(item.valeur) || 0
                        }));

                        seriesData.push({name: examen, data: dataPoints});
                    });

                    let options = {
                        chart: {type: 'line', height: 250},
                        series: seriesData,
                        xaxis: {type: 'category', title: {text: 'Date'}},
                        yaxis: {title: {text: 'Valeur'}},
                        stroke: {curve: 'smooth'},
                        markers: {size: 5},
                        legend: {position: 'top'}
                    };

                    new ApexCharts(document.querySelector(`#chart_${index}`), options).render();
                });
            });
        </script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                let examensParType = {{ examens_par_type_json|safe }};
                let statusExamens = {{ status_examens_json|safe }};
                let examensParJour = {{ examens_par_jour_json|safe }};
                let resultatsParExamen = {{ resultats_par_examen_json|safe }};

                // 📊 1. Répartition des examens par type
                new ApexCharts(document.querySelector("#chart-examens-type"), {
                    chart: {type: "bar"},
                    series: [{name: "Examens réalisés", data: examensParType.data}],
                    xaxis: {categories: examensParType.labels},
                    title: {text: "Examens réalisés par type"}
                }).render();

                // 📊 2. Statut des examens
                new ApexCharts(document.querySelector("#chart-status-examens"), {
                    chart: {type: "donut"},
                    series: statusExamens.data,
                    labels: statusExamens.labels,
                    title: {text: "Statut des examens"}
                }).render();

                // 📊 3. Evolution des examens par jour
                new ApexCharts(document.querySelector("#chart-examens-jour"), {
                    chart: {type: "line"},
                    series: [{name: "Examens réalisés", data: examensParJour.data}],
                    xaxis: {categories: examensParJour.labels},
                    title: {text: "Nombre d'examens réalisés par jour"}
                }).render();

                // 📊 4. Résultats des examens par type
                let examens = Object.keys(resultatsParExamen);
                let seriesData = [];
                let categories = [];

                Object.entries(resultatsParExamen).forEach(([examen, results]) => {
                    categories.push(examen);
                    Object.entries(results).forEach(([status, count]) => {
                        let serie = seriesData.find(s => s.name === status);
                        if (!serie) {
                            serie = {name: status, data: []};
                            seriesData.push(serie);
                        }
                        serie.data.push(count);
                    });
                });

                new ApexCharts(document.querySelector("#chart-resultats-examens"), {
                    chart: {type: "bar"},
                    series: seriesData,
                    xaxis: {categories: categories},
                    title: {text: "Résultats des examens par type"}
                }).render();
            });
        </script>


        <script>
            // Données JSON pour le graphique des constantes vitales
            const labels = [
                {% for constante in constantes %}
                    "{{ constante.created_at|date:'Y-m-d H:i' }}",
                {% endfor %}
            ];

            const temperatureData = [
                {% for constante in constantes %}
                    {{ constante.temperature|default:"null" }},
                {% endfor %}
            ];

            const heartRateData = [
                {% for constante in constantes %}
                    {{ constante.frequence_cardiaque|default:"null" }},
                {% endfor %}
            ];

            const respiratoryRateData = [
                {% for constante in constantes %}
                    {{ constante.frequence_respiratoire|default:"null" }},
                {% endfor %}
            ];

            const oxygenSaturationData = [
                {% for constante in constantes %}
                    {{ constante.saturation_oxygene|default:"null" }},
                {% endfor %}
            ];

            // Configuration du graphique des constantes vitales
            const constantesOptions = {
                chart: {
                    type: 'line',
                    height: 350,
                    zoom: {
                        enabled: true
                    }
                },
                series: [
                    {
                        name: 'Température (°C)',
                        data: temperatureData
                    },
                    {
                        name: 'Fréquence Cardiaque (bpm)',
                        data: heartRateData
                    },
                    {
                        name: 'Fréquence Respiratoire (rpm)',
                        data: respiratoryRateData
                    },
                    {
                        name: 'Saturation en Oxygène (%)',
                        data: oxygenSaturationData
                    }
                ],
                xaxis: {
                    categories: labels,
                    title: {
                        text: 'Date et Heure'
                    },
                    type: 'datetime'
                },
                yaxis: {
                    title: {
                        text: 'Valeurs des Constantes Vitales'
                    },
                    min: 0
                },
                title: {
                    text: 'Évolution des Constantes Vitales du Patient',
                    align: 'center'
                },
                tooltip: {
                    x: {
                        format: 'dd MMM yyyy HH:mm'
                    }
                }
            };

            // Initialisation du graphique des constantes vitales
            const constantesChart = new ApexCharts(document.querySelector("#constantesChart"), constantesOptions);
            constantesChart.render();
        </script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const dischargeCriteria = {{ discharge_criteria|safe }};

                const options = {
                    chart: {
                        type: 'bar',
                        height: 350
                    },
                    plotOptions: {
                        bar: {
                            horizontal: true,
                            distributed: true,  // This makes each bar individually colorable
                            colors: {
                                ranges: [
                                    {from: 1, to: 1, color: '#4CAF50'}, // Vert pour "Atteint"
                                    {from: 0, to: 0, color: '#F44336'}  // Rouge pour "Non Atteint"
                                ]
                            }
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        formatter: function (val) {
                            return val === 1 ? "Atteint" : "Non Atteint";
                        },
                        style: {
                            colors: ['#000']
                        }
                    },
                    series: [{
                        name: 'Critère de décharge',
                        data: [
                            dischargeCriteria.stable_vitals || 0,
                            dischargeCriteria.pain_controlled || 0,
                            dischargeCriteria.functional_ability || 0,
                            dischargeCriteria.mental_stability || 0,
                            dischargeCriteria.follow_up_plan || 0
                        ]
                    }],
                    xaxis: {
                        categories: [
                            "Signes vitaux stables",
                            "Douleur contrôlée",
                            "Capacité fonctionnelle",
                            "État mental stable",
                            "Plan de suivi post-hospitalisation"
                        ]
                    },
                    tooltip: {
                        enabled: true,
                        y: {
                            formatter: function (val) {
                                return val === 1 ? "Atteint" : "Non Atteint";
                            }
                        }
                    }
                };

                const chart = new ApexCharts(document.querySelector("#dischargeChart"), options);
                chart.render();
            });
        </script>
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function () {
                var booleanTypePairs = [
                    {checkbox: 'prophylaxie_antiretrovirale', typeField: 'prophylaxie_type'},
                    {checkbox: 'traitement_antiretrovirale', typeField: 'traitement_type'},
                    {checkbox: 'dernier_regime_antiretrovirale', typeField: 'dernier_regime_antiretrovirale_type'},
                    {
                        checkbox: 'traitement_prophylactique_cotrimoxazole',
                        typeField: 'traitement_prophylactique_cotrimoxazole_type'
                    },
                ];

                function toggleTypeField(checkboxId, typeFieldId) {
                    var checkbox = document.getElementById(checkboxId);
                    var typeField = document.getElementById(typeFieldId);

                    if (checkbox && typeField) {
                        if (checkbox.checked) {
                            typeField.closest('.form-group').style.display = 'block';
                        } else {
                            typeField.closest('.form-group').style.display = 'none';
                        }
                    }
                }

                booleanTypePairs.forEach(function (pair) {
                    toggleTypeField(pair.checkbox, pair.typeField);

                    document.getElementById(pair.checkbox).addEventListener('change', function () {
                        toggleTypeField(pair.checkbox, pair.typeField);
                    });
                });
            });
        </script>
    </div>
{% endblock %}