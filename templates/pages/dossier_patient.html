{% extends 'layout/base.html' %}
{% load static %}
{% load humanize %}
{% load custom_filter %}

{% block content %}
<style>
    :root {
        --primary-color: #4a6cf7;
        --secondary-color: #6c757d;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.03); }
        100% { transform: scale(1); }
    }
    @keyframes slideInRight {
        from { transform: translateX(20px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .profile-header {
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        animation: fadeIn 0.6s ease-out;
        margin-bottom: 30px;
    }

    .qr-code-container {
        transition: all 0.3s ease;
        border: 2px solid var(--primary-color);
        border-radius: 12px;
        padding: 8px;
        background: white;
        box-shadow: 0 4px 12px rgba(74, 108, 247, 0.15);
    }
    .qr-code-container:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(74, 108, 247, 0.3);
    }

    .patient-title {
        position: relative;
        padding-left: 20px;
        font-weight: 700;
    }
    .patient-title::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 5px;
        background: linear-gradient(to bottom, var(--primary-color), #3a5bd9);
        border-radius: 3px;
    }

    .info-card {
        background: white;
        border-radius: 12px;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        height: 100%;
    }
    .info-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .info-card .card-header {
        background: linear-gradient(135deg, var(--primary-color), #3a5bd9);
        color: white;
        border-radius: 12px 12px 0 0 !important;
        padding: 15px 20px;
        font-weight: 600;
        border: none;
    }
    .info-card .card-body { padding: 20px; }

    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    .info-item:hover { background: rgba(74, 108, 247, 0.05); padding-left: 10px; }
    .info-item:last-child { border-bottom: none; }

    .info-label {
        color: var(--secondary-color);
        font-weight: 500;
        font-size: 0.9rem;
    }
    .info-value {
        color: var(--dark-color);
        font-weight: 600;
        text-align: right;
        max-width: 60%;
    }

    .nav-tabs-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        margin-bottom: 25px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-top: 20px;
    }
    .nav-tabs {
        border: none;
        flex-wrap: nowrap;
        min-width: max-content;
        padding: 0 15px;
    }
    .nav-tabs .nav-item { margin: 0; }
    .nav-tabs .nav-link {
        border: none;
        color: var(--secondary-color);
        font-weight: 600;
        padding: 18px 24px;
        transition: all 0.3s ease;
        position: relative;
        white-space: nowrap;
        font-size: 0.95rem;
        background: transparent;
    }
    .nav-tabs .nav-link:hover {
        color: var(--primary-color);
        background: rgba(74, 108, 247, 0.05);
    }
    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        background: transparent;
        font-weight: 700;
    }
    .nav-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        height: 3px;
        background: var(--primary-color);
        border-radius: 3px 3px 0 0;
    }

    .tab-content {
        padding: 20px 0;
        animation: fadeIn 0.5s ease-out;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
        height: 100%;
    }
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.08);
    }
    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 15px;
    }
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--dark-color);
        line-height: 1;
        margin-bottom: 5px;
    }
    .stat-label {
        color: var(--secondary-color);
        font-size: 0.9rem;
        font-weight: 500;
    }

    .accordion-item {
        margin-bottom: 15px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 3px 12px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
    }
    .accordion-item:hover { box-shadow: 0 6px 18px rgba(0,0,0,0.1); }
    .accordion-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 25px;
        background: rgba(74, 108, 247, 0.08);
        color: var(--primary-color);
        text-decoration: none;
        transition: all 0.3s ease;
        font-weight: 600;
    }
    .accordion-head:hover { background: rgba(74, 108, 247, 0.15); }
    .accordion-body { padding: 25px; background: white; }

    .badge-custom {
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), #3a5bd9);
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(74, 108, 247, 0.25);
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(74, 108, 247, 0.35);
    }

    .timeline { position: relative; padding-left: 30px; }
    .timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--primary-color);
        opacity: 0.2;
    }
    .timeline-item {
        position: relative;
        margin-bottom: 25px;
        padding: 20px;
        background: white;
        border-radius: 10px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -30px;
        top: 25px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--primary-color);
        border: 3px solid white;
        box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.2);
    }

    @media (max-width: 768px) {
        .profile-header { flex-direction: column; text-align: center; }
        .patient-title::before { display: none; }
        .nav-tabs-container { border-radius: 10px; margin-top: 10px;}
        .nav-tabs .nav-link { padding: 15px 18px; font-size: 0.9rem; }
        .info-card .card-body { padding: 15px; }
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(74, 108, 247, 0.3);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>

<div class="nk-content nk-content-fluid">
    <div class="container-xl wide-lg">
        <div class="nk-content-body">

            <!-- Header -->
            <div class="nk-block-head nk-block-head-sm mb-4">
                <div class="nk-block-between g-3 align-items-center profile-header p-4">
                    <div class="d-flex align-items-center">
                        {% if patientsdetail.qr_code %}
                            <div class="qr-code-container mr-4 animate__animated animate__fadeInLeft">
                                <img src="{{ patientsdetail.qr_code.url }}" width="130" alt="QR Code" class="img-fluid">
                            </div>
                        {% else %}
                            <div class="alert alert-warning mr-4 mb-0">Aucun QR code disponible</div>
                        {% endif %}

                        <div>
                            <h3 class="nk-block-title page-title patient-title animate__animated animate__fadeIn">
                                Patient / <strong class="text-primary">{{ patientsdetail.nom|default:"-" }} {{ patientsdetail.prenoms|default:"" }}</strong>
                            </h3>
                            <div class="nk-block-des text-soft ml-0 ml-sm-5 animate__animated animate__fadeIn animate__delay-1s">
                                <ul class="list-inline mb-0">
                                    <li class="list-inline-item mr-3">
                                        <i class="fas fa-id-badge text-primary mr-1"></i>
                                        UUID:
                                        <span class="text-dark font-weight-bold">{{ patientsdetail.code_patient|default:"-" }}</span>
                                    </li>
                                    <li class="list-inline-item mr-3">
                                        <i class="fas fa-virus text-danger mr-1"></i>
                                        CODE VIH:
                                        <span class="text-dark font-weight-bold">
                                            {% if patientsdetail.code_vih %}{{ patientsdetail.code_vih }}{% else %}NEANT{% endif %}
                                        </span>
                                    </li>
                                    <li class="list-inline-item">
                                        <i class="fas fa-calendar-check text-success mr-1"></i>
                                        Dernière Visite:
                                        <span class="text-dark font-weight-bold">
                                            {% if consultations and consultations.0 %}
                                                {{ consultations.0.consultation_date|date:"d M, Y H:i" }}
                                            {% else %}
                                                Aucune
                                            {% endif %}
                                        </span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="nk-block-head-content animate__animated animate__fadeInRight">
                        <button class="btn btn-outline-light bg-white d-none d-sm-inline-flex mr-3 print-btn">
                            <em class="icon ni ni-printer-fill mr-1"></em><span>Imprimer</span>
                        </button>
                        <a href="/" class="btn btn-outline-light bg-white d-none d-sm-inline-flex back-btn">
                            <em class="icon ni ni-arrow-left mr-1"></em><span>Retour</span>
                        </a>
                        <a href="/" class="btn btn-icon btn-outline-light bg-white d-inline-flex d-sm-none">
                            <em class="icon ni ni-arrow-left"></em>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="row g-4 mb-5 animate__animated animate__fadeIn">
                <div class="col-xl-3 col-md-6">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(74, 108, 247, 0.1); color: var(--primary-color);">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-number">{{ consultations_total|default:"0" }}</div>
                        <div class="stat-label">Consultations</div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(40, 167, 69, 0.1); color: var(--success-color);">
                            <i class="fas fa-procedures"></i>
                        </div>
                        <div class="stat-number">{{ hospitalizations|length }}</div>
                        <div class="stat-label">Hospitalisations</div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(255, 193, 7, 0.1); color: var(--warning-color);">
                            <i class="fas fa-pills"></i>
                        </div>
                        <div class="stat-number">{{ prescriptions|length }}</div>
                        <div class="stat-label">Prescriptions</div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(23, 162, 184, 0.1); color: var(--info-color);">
                            <i class="fas fa-flask"></i>
                        </div>
                        <div class="stat-number">
                            {{ consultation_examens|length|add:paraclinical_exams|length }}
                        </div>
                        <div class="stat-label">Examens</div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="nav-tabs-container ">
                <ul class="nav nav-tabs nav-tabs-mb-icon nav-tabs-card">
                    <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#tabPersonal"><em class="icon ni ni-user"></em><span>Informations Personnelles</span></a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tabConsultations"><em class="icon ni ni-repeat"></em><span>Consultations</span></a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tabHospitalizations"><em class="icon ni ni-home"></em><span>Hospitalisations</span></a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tabAppointments"><em class="icon ni ni-calendar"></em><span>Rendez-vous</span></a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tabPharmacie"><em class="icon ni ni-capsule"></em><span>Pharmacie</span></a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tabExamens"><em class="icon ni ni-report"></em><span>Examens</span></a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tabBilans"><em class="icon ni ni-activity"></em><span>Bilans</span></a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tabImagerie"><em class="icon ni ni-camera"></em><span>Imagerie</span></a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tabConstantes"><em class="icon ni ni-heart"></em><span>Constantes</span></a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tabTestsVIH"><em class="icon ni ni-shield-check"></em><span>Tests VIH</span></a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tabSuivis"><em class="icon ni ni-user-check"></em><span>Suivis</span></a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tabCasContacts"><em class="icon ni ni-users"></em><span>Cas Contacts</span></a></li>
                </ul>
            </div>

            <div class="tab-content">

                <!-- TAB 1 -->
                <div class="tab-pane fade show active" id="tabPersonal">
                    <div class="row g-4">

                        <div class="col-lg-4">
                            <div class="info-card">
                                <div class="card-header"><i class="fas fa-user mr-2"></i>Informations Générales</div>
                                <div class="card-body">
                                    <div class="info-item">
                                        <span class="info-label">Nom Complet</span>
                                        <span class="info-value">{{ patientsdetail.nom|default:"-" }} {{ patientsdetail.prenoms|default:"" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Code Patient</span>
                                        <span class="info-value badge badge-primary">{{ patientsdetail.code_patient|default:"-" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Âge</span>
                                        <span class="info-value">{{ patientsdetail.calculate_age|default:"-" }} ans</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Genre</span>
                                        <span class="info-value">{{ patientsdetail.get_genre_display|default:"-" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Date Naissance</span>
                                        <span class="info-value">{{ patientsdetail.date_naissance|date:"d/m/Y"|default:"-" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Lieu Naissance</span>
                                        <span class="info-value">{{ patientsdetail.lieu_naissance|default:"-" }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="info-card">
                                <div class="card-header"><i class="fas fa-address-card mr-2"></i>Contact & Localisation</div>
                                <div class="card-body">
                                    <div class="info-item">
                                        <span class="info-label">Téléphone</span>
                                        <span class="info-value">{{ patientsdetail.contact|default:"-" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Email</span>
                                        <span class="info-value">{{ patientsdetail.adresse_mail|default:"-" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Localité</span>
                                        <span class="info-value">{{ patientsdetail.localite|default:"-" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Nationalité</span>
                                        <span class="info-value">{{ patientsdetail.nationalite|default:"-" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Ethnie</span>
                                        <span class="info-value">{{ patientsdetail.ethnie|default:"-" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Profession</span>
                                        <span class="info-value">{{ patientsdetail.profession|default:"-" }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="info-card">
                                <div class="card-header"><i class="fas fa-heartbeat mr-2"></i>Informations Médicales</div>
                                <div class="card-body">
                                    <div class="info-item">
                                        <span class="info-label">Groupe Sanguin</span>
                                        <span class="info-value">{{ patientsdetail.get_groupe_sanguin_display|default:"-" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">CMU</span>
                                        <span class="info-value">{{ patientsdetail.cmu|default:"-" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Niveau Étude</span>
                                        <span class="info-value">{{ patientsdetail.niveau_etude|default:"-" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Employeur</span>
                                        <span class="info-value">{{ patientsdetail.employeur|default:"-" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Situation Mat.</span>
                                        <span class="info-value">{{ patientsdetail.get_situation_matrimoniale_display|default:"-" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Nombre Enfants</span>
                                        <span class="info-value">{{ patientsdetail.nbr_enfants|default:"0" }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% with latest_const=patientsdetail.latest_constante %}
                        {% if latest_const %}
                        <div class="col-12">
                            <div class="info-card">
                                <div class="card-header">
                                    <i class="fas fa-chart-line mr-2"></i>
                                    Dernières Constantes ({{ latest_const.created_at|date:"d/m/Y H:i"|default:"-" }})
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-2">
                                            <div class="text-center">
                                                <div class="font-weight-bold text-primary" style="font-size: 1.5rem;">
                                                    {{ latest_const.tension_systolique|default:"-" }}/{{ latest_const.tension_diastolique|default:"-" }}
                                                </div>
                                                <small>TA (mmHg)</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="text-center">
                                                <div class="font-weight-bold text-success" style="font-size: 1.5rem;">
                                                    {{ latest_const.frequence_cardiaque|default:"-" }}
                                                </div>
                                                <small>FC (bpm)</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="text-center">
                                                <div class="font-weight-bold text-info" style="font-size: 1.5rem;">
                                                    {{ latest_const.temperature|default:"-" }}°C
                                                </div>
                                                <small>Température</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="text-center">
                                                <div class="font-weight-bold text-warning" style="font-size: 1.5rem;">
                                                    {{ latest_const.poids|default:"-" }} kg
                                                </div>
                                                <small>Poids</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="text-center">
                                                <div class="font-weight-bold text-secondary" style="font-size: 1.5rem;">
                                                    {{ latest_const.taille|default:"-" }} cm
                                                </div>
                                                <small>Taille</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="text-center">
                                                <div class="font-weight-bold text-danger" style="font-size: 1.5rem;">
                                                    {{ latest_const.imc|default:"-" }}
                                                </div>
                                                <small>IMC</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>

                <!-- TAB 2: Consultations -->
                <div class="tab-pane fade" id="tabConsultations">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Rechercher une consultation..." id="searchConsultations">
                                <div class="input-group-append">
                                    <button class="btn btn-primary" type="button"><i class="fas fa-search"></i></button>
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2">
                                Recherche sur la page courante. Pagination: page {{ consultations.number|default:"1" }} / {{ consultations.paginator.num_pages|default:"1" }}.
                            </small>
                        </div>
                        <div class="col-md-4 text-right">
                            <span class="badge badge-primary p-2">
                                {{ consultations_total|default:"0" }} consultation{{ consultations_total|pluralize }}
                            </span>
                        </div>
                    </div>

                    <div id="accordionConsultations">
                        {% for consultation in consultations %}
                        <div class="accordion-item consultation-item"
                             data-date="{{ consultation.consultation_date|date:'Y-m-d' }}"
                             data-doctor="{{ consultation.doctor|default:'' }}">

                            <a href="#" class="accordion-head {% if not forloop.first %}collapsed{% endif %}"
                               data-toggle="collapse" data-target="#consult-{{ consultation.id }}">
                                <div class="d-flex align-items-center justify-content-between w-100">
                                    <div class="d-flex align-items-center">
                                        <div class="mr-3"><i class="fas fa-stethoscope fa-lg text-primary"></i></div>
                                        <div>
                                            <h6 class="title mb-0">
                                                Consultation #{{ consultation.numeros|default:consultation.id }}
                                                <span class="badge badge-info ml-2">{{ consultation.services.nom|default:"-" }}</span>
                                            </h6>
                                            <small class="text-muted">
                                                <i class="far fa-calendar mr-1"></i>{{ consultation.consultation_date|date:"d/m/Y H:i"|default:"-" }}
                                                | <i class="fas fa-user-md mr-1"></i>{{ consultation.doctor.get_full_name|default:consultation.doctor|default:"Non spécifié" }}
                                            </small>
                                        </div>
                                    </div>

                                    <div class="text-right">
                                        <span class="badge
                                            {% if consultation.status == 'completed' %}badge-success
                                            {% elif consultation.status == 'in_progress' %}badge-primary
                                            {% elif consultation.status == 'cancelled' %}badge-danger
                                            {% else %}badge-secondary{% endif %} badge-custom">
                                            {{ consultation.get_status_display|default:"-" }}
                                        </span>
                                        <div class="text-muted small mt-1">
                                            Motif: {{ consultation.reason|default:"-"|truncatechars:30 }}
                                        </div>
                                    </div>
                                </div>
                                <span class="accordion-icon"><i class="fas fa-chevron-down"></i></span>
                            </a>

                            <div class="accordion-body collapse {% if forloop.first %}show{% endif %}"
                                 id="consult-{{ consultation.id }}"
                                 data-parent="#accordionConsultations">

                                <div class="row">
                                    <div class="col-lg-6 mb-3">
                                        <h6 class="text-primary mb-2"><i class="fas fa-notes-medical mr-2"></i>Détails</h6>
                                        <div class="info-item"><span class="info-label">Motif</span><span class="info-value">{{ consultation.reason|default:"-" }}</span></div>
                                        <div class="info-item"><span class="info-label">Observation</span><span class="info-value">{{ consultation|safe_get:"notes"|default:"-"|linebreaks }}</span></div>
                                        <div class="info-item"><span class="info-label">Service</span><span class="info-value">{{ consultation.services.nom|default:"-" }}</span></div>
                                        <div class="info-item"><span class="info-label">Médecin</span><span class="info-value">{{ consultation.doctor.get_full_name|default:consultation.doctor|default:"-" }}</span></div>
                                    </div>

                                    <div class="col-lg-6 mb-3">
                                        <h6 class="text-primary mb-2"><i class="fas fa-heartbeat mr-2"></i>Constantes liées</h6>
                                        {% if consultation.constante %}
                                            <div class="info-item"><span class="info-label">TA</span><span class="info-value">{{ consultation.constante.tension_systolique|default:"-" }}/{{ consultation.constante.tension_diastolique|default:"-" }}</span></div>
                                            <div class="info-item"><span class="info-label">FC</span><span class="info-value">{{ consultation.constante.frequence_cardiaque|default:"-" }}</span></div>
                                            <div class="info-item"><span class="info-label">Temp</span><span class="info-value">{{ consultation.constante.temperature|default:"-" }} °C</span></div>
                                            <div class="info-item"><span class="info-label">Poids</span><span class="info-value">{{ consultation.constante.poids|default:"-" }} kg</span></div>
                                            <div class="info-item"><span class="info-label">SpO2</span><span class="info-value">{{ consultation.constante.saturation_oxygene|default:"-" }} %</span></div>
                                        {% else %}
                                            <div class="alert alert-light mb-0">Aucune constante liée à cette consultation.</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-12 mb-3">
                                        <h6 class="text-primary mb-2"><i class="fas fa-allergies mr-2"></i>Symptômes / Antécédents / Allergies</h6>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="border rounded p-3 h-100">
                                                    <div class="font-weight-bold mb-2">Symptômes</div>
                                                    {% if consultation.symptomes.all %}
                                                        <ul class="mb-0">
                                                            {% for s in consultation.symptomes.all %}
                                                                <li>{{ s.nom|default:s.name|default:s }}</li>
                                                            {% empty %}
                                                                <li class="text-muted">Aucun</li>
                                                            {% endfor %}
                                                        </ul>
                                                    {% else %}
                                                        <div class="text-muted">Aucun</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="border rounded p-3 h-100">
                                                    <div class="font-weight-bold mb-2">Antécédents</div>
                                                    {% if consultation.antecedentsMedicaux.all %}
                                                        <ul class="mb-0">
                                                            {% for a in consultation.antecedentsMedicaux.all %}
                                                                <li>{{ a.nom|default:a.name|default:a }}</li>
                                                            {% empty %}
                                                                <li class="text-muted">Aucun</li>
                                                            {% endfor %}
                                                        </ul>
                                                    {% else %}
                                                        <div class="text-muted">Aucun</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="border rounded p-3 h-100">
                                                    <div class="font-weight-bold mb-2">Allergies</div>
                                                    {% if consultation.allergies.all %}
                                                        <ul class="mb-0">
                                                            {% for al in consultation.allergies.all %}
                                                                <li>{{ al.nom|default:al.name|default:al }}</li>
                                                            {% empty %}
                                                                <li class="text-muted">Aucune</li>
                                                            {% endfor %}
                                                        </ul>
                                                    {% else %}
                                                        <div class="text-muted">Aucune</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <h6 class="text-primary mb-2"><i class="fas fa-vials mr-2"></i>Examens / Résultats</h6>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <div class="border rounded p-3 h-100">
                                                    <div class="font-weight-bold mb-2">Examens demandés (labo)</div>
                                                    {% with has_labo=False %}
                                                    <ul class="mb-0">
                                                        {% for ex in consultation_examens %}
                                                            {% if ex.consultation_id == consultation.id %}
                                                                {% if not has_labo %}{% endif %}
                                                                <li>
                                                                    {{ ex.analyses.name|default:"Examen" }}
                                                                    —
                                                                    <span class="text-muted">{{ ex.created_at|date:"d/m/Y"|default:"-" }}</span>
                                                                    {% if ex.resultat %}<span class="badge badge-success ml-2">Résultat</span>{% endif %}
                                                                </li>
                                                            {% endif %}
                                                        {% empty %}
                                                            <li class="text-muted">Aucun examen labo</li>
                                                        {% endfor %}
                                                    </ul>
                                                    {% endwith %}
                                                </div>
                                            </div>

                                            <div class="col-md-6 mb-3">
                                                <div class="border rounded p-3 h-100">
                                                    <div class="font-weight-bold mb-2">Test VIH (si lié)</div>
                                                    <ul class="mb-0">
                                                        {% for t in tests_vih %}
                                                            {% if t.consultation_id == consultation.id %}
                                                                <li>
                                                                    {{ t.date_test|date:"d/m/Y"|default:"-" }} —
                                                                    <span class="badge {% if t.resultat == 'Positif' %}badge-danger{% elif t.resultat == 'Négatif' %}badge-success{% else %}badge-warning{% endif %}">
                                                                        {{ t.resultat|default:"-" }}
                                                                    </span>
                                                                    {% if t.viral_load %}<span class="ml-2 text-muted">VL: {{ t.viral_load }}</span>{% endif %}
                                                                    {% if t.cd4_count %}<span class="ml-2 text-muted">CD4: {{ t.cd4_count }}</span>{% endif %}
                                                                </li>
                                                            {% endif %}
                                                        {% empty %}
                                                            <li class="text-muted">Aucun test VIH</li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                            </div>
                        </div>
                        {% empty %}
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle fa-2x mb-3"></i>
                            <h5>Aucune consultation enregistrée</h5>
                            <p class="mb-0">Ce patient n'a pas encore de consultation médicale.</p>
                        </div>
                        {% endfor %}
                    </div>

                    {% if consultations.paginator.num_pages > 1 %}
                    <nav aria-label="Consultations pagination" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if consultations.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ consultations.previous_page_number }}#tabConsultations">Précédent</a>
                            </li>
                            {% endif %}

                            {% for num in consultations.paginator.page_range %}
                            <li class="page-item {% if consultations.number == num %}active{% endif %}">
                                <a class="page-link" href="?page={{ num }}#tabConsultations">{{ num }}</a>
                            </li>
                            {% endfor %}

                            {% if consultations.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ consultations.next_page_number }}#tabConsultations">Suivant</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>

                <!-- TAB 3: Hospitalisations -->
                <div class="tab-pane fade" id="tabHospitalizations">

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <div class="stat-number">{{ hospitalizations|length }}</div>
                                <div class="stat-label">Total Hospitalisations</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <div class="stat-number">{{ hospitalizations|filter_by_status:"active"|length }}</div>
                                <div class="stat-label">En cours</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <div class="stat-number">{{ hospitalizations|filter_by_status:"discharged"|length }}</div>
                                <div class="stat-label">Sorties</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <div class="stat-number">{{ hospitalizations|filter_by_status:"transferred"|length }}</div>
                                <div class="stat-label">Transférés</div>
                            </div>
                        </div>
                    </div>

                    <div id="accordionHospitalizations">
                        {% for hospitalization in hospitalizations %}
                        <div class="accordion-item">
                            <a href="#" class="accordion-head {% if not forloop.first %}collapsed{% endif %}"
                               data-toggle="collapse" data-target="#hospi-{{ hospitalization.id }}">
                                <div class="d-flex align-items-center justify-content-between w-100">
                                    <div class="d-flex align-items-center">
                                        <div class="mr-3"><i class="fas fa-hospital fa-lg text-primary"></i></div>
                                        <div>
                                            <h6 class="mb-0">
                                                Hospitalisation #{{ hospitalization.id }}
                                                {% if hospitalization.bed %}
                                                    <span class="badge badge-info ml-2">
                                                        Lit: {{ hospitalization.bed|default:"-" }}
                                                    </span>
                                                {% endif %}
                                            </h6>
                                            <small class="text-muted">
                                                <i class="far fa-calendar mr-1"></i>
                                                Admission: {{ hospitalization.admission_date|date:"d/m/Y H:i"|default:"-" }}
                                                {% if hospitalization.discharge_date %}
                                                    | Sortie: {{ hospitalization.discharge_date|date:"d/m/Y H:i" }}
                                                {% endif %}
                                                | <i class="fas fa-user-md mr-1"></i>{{ hospitalization.doctor.get_full_name|default:hospitalization.doctor|default:"-" }}
                                            </small>
                                        </div>
                                    </div>

                                    <div class="text-right">
                                        <span class="badge
                                            {% if hospitalization.status == 'active' %}badge-primary
                                            {% elif hospitalization.status == 'discharged' %}badge-success
                                            {% elif hospitalization.status == 'transferred' %}badge-warning
                                            {% else %}badge-secondary{% endif %} badge-custom">
                                            {{ hospitalization.get_status_display|default:hospitalization.status|default:"-" }}
                                        </span>
                                    </div>
                                </div>
                                <span class="accordion-icon"><i class="fas fa-chevron-down"></i></span>
                            </a>

                            <div class="accordion-body collapse {% if forloop.first %}show{% endif %}"
                                 id="hospi-{{ hospitalization.id }}"
                                 data-parent="#accordionHospitalizations">

                                <div class="row">
                                    <div class="col-lg-6 mb-3">
                                        <h6 class="text-primary mb-2"><i class="fas fa-clipboard-list mr-2"></i>Informations</h6>
                                        <div class="info-item"><span class="info-label">Motif</span><span class="info-value">{{ hospitalization.reason|default:"-" }}</span></div>
                                        <div class="info-item"><span class="info-label">Service/Unité</span><span class="info-value">{{ hospitalization.unite }}</span></div>
                                        <div class="info-item"><span class="info-label">Chambre/Box</span><span class="info-value">{{ hospitalization.bed.box|default:"-" }}</span></div>
                                        <div class="info-item"><span class="info-label">Lit</span><span class="info-value">{{ hospitalization.bed|default:"-" }}</span></div>
                                    </div>

                                   <div class="col-lg-6 mb-3">
  <h6 class="text-primary mb-2"><i class="fas fa-stethoscope mr-2"></i>Diagnostics</h6>

  {% with diags=hospitalization.diagnostics.all %}
    {% if diags %}
      <ul class="mb-0">
        {% for d in diags %}
          <li>
            {% firstof d.nom d.libelle d.titre d.description d.code d %}
          </li>
        {% empty %}
          <li class="text-muted">Aucun diagnostic</li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted">Aucun diagnostic</div>
    {% endif %}
  {% endwith %}
</div>

                                    <div class="col-12 mb-3">
                                        <h6 class="text-primary mb-2"><i class="fas fa-heartbeat mr-2"></i>Constantes Hospitalisation</h6>
                                        {% if hospitalization.hospiconstantes.all %}
                                            <div class="table-responsive">
                                                <table class="table table-sm table-hover mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th>Date/Heure</th>
                                                            <th>TA</th>
                                                            <th>FC</th>
                                                            <th>Temp</th>
                                                            <th>SpO2</th>
                                                            <th>Poids</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for c in hospitalization.hospiconstantes.all|slice:":10" %}
                                                        <tr>
                                                            <td>{{ c.created_at|date:"d/m/Y H:i"|default:"-" }}</td>
                                                            <td>{{ c.tension_systolique|default:"-" }}/{{ c.tension_diastolique|default:"-" }}</td>
                                                            <td>{{ c.frequence_cardiaque|default:"-" }}</td>
                                                            <td>{{ c.temperature|default:"-" }}</td>
                                                            <td>{{ c.saturation_oxygene|default:"-" }}</td>
                                                            <td>{{ c.poids|default:"-" }}</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <div class="alert alert-light mb-0">Aucune constante d'hospitalisation.</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-12 mb-3">
                                        <h6 class="text-primary mb-2"><i class="fas fa-vials mr-2"></i>Examens / Bilans / Imagerie</h6>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <div class="border rounded p-3 h-100">
                                                    <div class="font-weight-bold mb-2">Examens hospitalisation</div>
                                                    {% if hospitalization.hospitalization_exams.all %}
                                                        <ul class="mb-0">
                                                            {% for ex in hospitalization.hospitalization_exams.all %}
                                                                <li>{{ ex.name|default:ex.analyses.name|default:"Examen" }} — <span class="text-muted">{{ ex.created_at|date:"d/m/Y"|default:"-" }}</span></li>
                                                            {% empty %}
                                                                <li class="text-muted">Aucun</li>
                                                            {% endfor %}
                                                        </ul>
                                                    {% else %}
                                                        <div class="text-muted">Aucun</div>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <div class="col-md-4 mb-3">
                                                <div class="border rounded p-3 h-100">
                                                    <div class="font-weight-bold mb-2">Bilans</div>
                                                    {% if hospitalization.bilans.all %}
                                                        <ul class="mb-0">
                                                            {% for b in hospitalization.bilans.all %}
                                                                <li>{{ b.examen.nom|default:"Bilan" }} — <span class="text-muted">{{ b.created_at|date:"d/m/Y"|default:"-" }}</span></li>
                                                            {% empty %}
                                                                <li class="text-muted">Aucun</li>
                                                            {% endfor %}
                                                        </ul>
                                                    {% else %}
                                                        <div class="text-muted">Aucun</div>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <div class="col-md-4 mb-3">
                                                <div class="border rounded p-3 h-100">
                                                    <div class="font-weight-bold mb-2">Imagerie</div>
                                                    {% if hospitalization.imagerieshospi.all %}
                                                        <ul class="mb-0">
                                                            {% for im in hospitalization.imagerieshospi.all %}
                                                                <li>{{ im.type_imagerie.nom|default:"Imagerie" }} — <span class="text-muted">{{ im.date_examen|date:"d/m/Y"|default:"-" }}</span></li>
                                                            {% empty %}
                                                                <li class="text-muted">Aucune</li>
                                                            {% endfor %}
                                                        </ul>
                                                    {% else %}
                                                        <div class="text-muted">Aucune</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12 mb-3">
                                        <h6 class="text-primary mb-2"><i class="fas fa-pills mr-2"></i>Prescriptions (Hospitalisation)</h6>
                                        {% if hospitalization.hospiprescriptions.all %}
                                            <div class="table-responsive">
                                                <table class="table table-sm table-hover mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th>Date</th>
                                                            <th>Médicament</th>
                                                            <th>Posologie</th>
                                                            <th>Statut</th>
                                                            <th>Médecin</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for p in hospitalization.hospiprescriptions.all %}
                                                        <tr>
                                                            <td>{{ p.prescribed_at|date:"d/m/Y H:i"|default:"-" }}</td>
                                                            <td>{{ p.medication.nom|default:"-" }}</td>
                                                            <td>{{ p.dosage|default:"-" }}</td>
                                                            <td>{{ p.get_status_display|default:p.status|default:"-" }}</td>
                                                            <td>{{ p.doctor.get_full_name|default:p.doctor|default:"-" }}</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <div class="alert alert-light mb-0">Aucune prescription liée à cette hospitalisation.</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-12">
                                        <h6 class="text-primary mb-2"><i class="fas fa-chart-bar mr-2"></i>Indicateurs</h6>
                                        <div class="row">
                                            <div class="col-md-3 mb-3">
                                                <div class="border rounded p-3 h-100">
                                                    <div class="font-weight-bold mb-2">Biologiques</div>
                                                    {% if hospitalization.indicateurs_biologiques.all %}
                                                        <ul class="mb-0">
                                                            {% for i in hospitalization.indicateurs_biologiques.all|slice:":10" %}
                                                                <li>{{ i.nom|default:i.name|default:i }}: {{ i.valeur|default:i.value|default:"-" }}</li>
                                                            {% empty %}<li class="text-muted">Aucun</li>{% endfor %}
                                                        </ul>
                                                    {% else %}
                                                        <div class="text-muted">Aucun</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <div class="border rounded p-3 h-100">
                                                    <div class="font-weight-bold mb-2">Fonctionnels</div>
                                                    {% if hospitalization.indicateurs_fonctionnels.all %}
                                                        <ul class="mb-0">
                                                            {% for i in hospitalization.indicateurs_fonctionnels.all|slice:":10" %}
                                                                <li>{{ i.nom|default:i.name|default:i }}: {{ i.valeur|default:i.value|default:"-" }}</li>
                                                            {% empty %}<li class="text-muted">Aucun</li>{% endfor %}
                                                        </ul>
                                                    {% else %}
                                                        <div class="text-muted">Aucun</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <div class="border rounded p-3 h-100">
                                                    <div class="font-weight-bold mb-2">Subjectifs</div>
                                                    {% if hospitalization.indicateurs_subjectifs.all %}
                                                        <ul class="mb-0">
                                                            {% for i in hospitalization.indicateurs_subjectifs.all|slice:":10" %}
                                                                <li>{{ i.nom|default:i.name|default:i }}: {{ i.valeur|default:i.value|default:"-" }}</li>
                                                            {% empty %}<li class="text-muted">Aucun</li>{% endfor %}
                                                        </ul>
                                                    {% else %}
                                                        <div class="text-muted">Aucun</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <div class="border rounded p-3 h-100">
                                                    <div class="font-weight-bold mb-2">Complications/Autres</div>
                                                    <div class="small text-muted mb-2">Complications</div>
                                                    {% if hospitalization.indicateurs_compliques.all %}
                                                        <ul class="mb-2">
                                                            {% for i in hospitalization.indicateurs_compliques.all|slice:":5" %}
                                                                <li>{{ i.nom|default:i.name|default:i }}: {{ i.valeur|default:i.value|default:"-" }}</li>
                                                            {% empty %}<li class="text-muted">Aucun</li>{% endfor %}
                                                        </ul>
                                                    {% else %}
                                                        <div class="text-muted">Aucun</div>
                                                    {% endif %}

                                                    <div class="small text-muted mt-3 mb-2">Autres</div>
                                                    {% if hospitalization.indicateurs_autres.all %}
                                                        <ul class="mb-0">
                                                            {% for i in hospitalization.indicateurs_autres.all|slice:":5" %}
                                                                <li>{{ i.nom|default:i.name|default:i }}: {{ i.valeur|default:i.value|default:"-" }}</li>
                                                            {% empty %}<li class="text-muted">Aucun</li>{% endfor %}
                                                        </ul>
                                                    {% else %}
                                                        <div class="text-muted">Aucun</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                            </div>
                        </div>
                        {% empty %}
                        <div class="alert alert-info text-center">
                            <i class="fas fa-hospital fa-2x mb-3"></i>
                            <h5>Aucune hospitalisation</h5>
                            <p class="mb-0">Ce patient n'a jamais été hospitalisé.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- TAB 4: Rendez-vous -->
                <div class="tab-pane fade" id="tabAppointments">
                    <div class="row">
                        <div class="col-lg-8">
                            {% if appointments %}
                            <div class="timeline">
                                {% for appointment in appointments %}
                                <div class="timeline-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">{{ appointment.title|default:"Rendez-vous médical" }}</h6>
                                            <div class="text-muted mb-2">
                                                <i class="far fa-calendar mr-1"></i>{{ appointment.appointment_date|date:"d/m/Y H:i"|default:"-" }}
                                            </div>
                                            {% if appointment.description %}
                                            <p class="mb-0">{{ appointment.description }}</p>
                                            {% endif %}
                                        </div>
                                        <div class="text-right">
                                            <span class="badge
                                                {% if appointment.status == 'confirmed' %}badge-success
                                                {% elif appointment.status == 'pending' %}badge-warning
                                                {% elif appointment.status == 'cancelled' %}badge-danger
                                                {% else %}badge-secondary{% endif %} badge-custom">
                                                {{ appointment.get_status_display|default:appointment.status|default:"-" }}
                                            </span>
                                            {% if appointment.reminder_sent %}
                                            <div class="text-success small mt-1"><i class="fas fa-bell"></i> Rappel envoyé</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="alert alert-info text-center">
                                <i class="fas fa-calendar-times fa-2x mb-3"></i>
                                <h5>Aucun rendez-vous</h5>
                                <p class="mb-0">Aucun rendez-vous programmé pour ce patient.</p>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-lg-4">
                            <div class="info-card">
                                <div class="card-header"><i class="fas fa-chart-pie mr-2"></i>Statistiques Rendez-vous</div>
                                <div class="card-body">
                                    <canvas id="appointmentsChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 5: Pharmacie -->
                <div class="tab-pane fade" id="tabPharmacie">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Date</th>
                                    <th>Médicament</th>
                                    <th>Posologie</th>
                                    <th>Quantité</th>
                                    <th>Statut</th>
                                    <th>Médecin</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for prescription in prescriptions %}
                                <tr>
                                    <td>{{ prescription.prescribed_at|date:"d/m/Y H:i"|default:"-" }}</td>
                                    <td>
                                        <strong>{{ prescription.medication.nom|default:"-" }}</strong>
                                        {% if prescription.medication.dci %}
                                        <br><small class="text-muted">DCI: {{ prescription.medication.dci }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ prescription.dosage|default:"-" }}</td>
                                    <td>{{ prescription.quantity|default:"-" }} {{ prescription.unite_prise|default:"" }}</td>
                                    <td>
                                        <span class="badge
                                            {% if prescription.status == 'Dispensed' %}badge-success
                                            {% elif prescription.status == 'Pending' %}badge-warning
                                            {% elif prescription.status == 'Cancelled' %}badge-danger
                                            {% else %}badge-secondary{% endif %} badge-custom">
                                            {{ prescription.get_status_display|default:prescription.status|default:"-" }}
                                        </span>
                                    </td>
                                    <td>{{ prescription.doctor.get_full_name|default:prescription.doctor|default:"-" }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" data-toggle="modal" data-target="#prescriptionDetail{{ prescription.id }}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <i class="fas fa-pills fa-2x text-muted mb-3"></i>
                                        <p class="mb-0">Aucune prescription enregistrée</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB 6: Examens -->
                <div class="tab-pane fade" id="tabExamens">
                    <div class="row">

                        <div class="col-lg-6">
                            <div class="info-card">
                                <div class="card-header"><i class="fas fa-microscope mr-2"></i>Examens Laboratoire</div>
                                <div class="card-body">
                                    {% if consultation_examens %}
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Type</th>
                                                    <th>Statut</th>
                                                    <th>Résultat</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for examen in consultation_examens %}
                                                <tr>
                                                    <td>{{ examen.created_at|date:"d/m/Y"|default:"-" }}</td>
                                                    <td>{{ examen.analyses.name|default:"Examen" }}</td>
                                                    <td>
                                                        <span class="badge
                                                            {% if examen.statut == 'completed' %}badge-success
                                                            {% elif examen.statut == 'cancelled' %}badge-danger
                                                            {% elif examen.statut == 'in_progress' %}badge-primary
                                                            {% else %}badge-warning{% endif %}">
                                                            {{ examen.get_statut_display|default:examen.statut|default:"-" }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        {% if examen.resultat %}
                                                        <button class="btn btn-sm btn-outline-primary" data-toggle="popover" data-content="{{ examen.resultat }}">Voir</button>
                                                        {% elif examen.result_file %}
                                                        <a href="{{ examen.result_file.url }}" class="btn btn-sm btn-outline-info" target="_blank">
                                                            <i class="fas fa-download"></i>
                                                        </a>
                                                        {% else %}
                                                        -
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <p class="text-muted text-center py-3">Aucun examen de laboratoire</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <div class="info-card">
                                <div class="card-header"><i class="fas fa-heartbeat mr-2"></i>Examens Paracliniques</div>
                                <div class="card-body">
                                    {% if paraclinical_exams %}
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Type</th>
                                                    <th>Statut</th>
                                                    <th>Résultat</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for exam in paraclinical_exams %}
                                                <tr>
                                                    <td>{{ exam.prescribed_at|date:"d/m/Y"|default:"-" }}</td>
                                                    <td>{{ exam.get_exam_type_display|default:"-" }}</td>
                                                    <td>
                                                        <span class="badge
                                                            {% if exam.status == 'Completed' %}badge-success
                                                            {% elif exam.status == 'Cancelled' %}badge-danger
                                                            {% else %}badge-warning{% endif %}">
                                                            {{ exam.get_status_display|default:exam.status|default:"-" }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        {% if exam.result_value %}
                                                        {{ exam.result_value }} {{ exam.unit|default:"" }}
                                                        {% elif exam.result_text %}
                                                        <button class="btn btn-sm btn-outline-primary" data-toggle="popover" data-content="{{ exam.result_text }}">Voir</button>
                                                        {% else %}
                                                        -
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <p class="text-muted text-center py-3">Aucun examen paraclinique</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- TAB 7: Bilans -->
                <div class="tab-pane fade" id="tabBilans">
                    {% if bilans %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="thead-primary">
                                <tr>
                                    <th>Date</th>
                                    <th>Type d'examen</th>
                                    <th>Résultat</th>
                                    <th>Valeur référence</th>
                                    <th>Médecin</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bilan in bilans %}
                                <tr>
                                    <td>{{ bilan.created_at|date:"d/m/Y"|default:"-" }}</td>
                                    <td>
                                        {{ bilan.examen.nom|default:"Examen" }}
                                        {% if bilan.examen.type_examen %}
                                        <br><small class="text-muted">{{ bilan.examen.type_examen.nom }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if bilan.result %}
                                        {{ bilan.result }} {{ bilan.unit|default:"" }}
                                        {% elif bilan.report_file %}
                                        <a href="{{ bilan.report_file.url }}" target="_blank" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-file-pdf"></i> Rapport
                                        </a>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>{{ bilan.reference_range|default:"-" }}</td>
                                    <td>{{ bilan.doctor.get_full_name|default:bilan.doctor|default:"-" }}</td>
                                    <td>
                                        <span class="badge
                                            {% if bilan.status == 'completed' %}badge-success
                                            {% elif bilan.status == 'cancelled' %}badge-danger
                                            {% else %}badge-warning{% endif %}">
                                            {{ bilan.get_status_display|default:bilan.status|default:"-" }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center">
                        <i class="fas fa-chart-bar fa-2x mb-3"></i>
                        <h5>Aucun bilan enregistré</h5>
                        <p class="mb-0">Ce patient n'a pas encore de bilan médical.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- TAB 8: Imagerie -->
                <div class="tab-pane fade" id="tabImagerie">
                    {% if imageries %}
                    <div class="row">
                        {% for imagerie in imageries %}
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="info-card h-100">
                                <div class="card-header">
                                    <i class="fas fa-x-ray mr-2"></i>{{ imagerie.type_imagerie.nom|default:"Imagerie" }}
                                </div>
                                <div class="card-body">
                                    {% if imagerie.image_file %}
                                    <div class="text-center mb-3">
                                        <img src="{{ imagerie.image_file.url }}" alt="Image médicale" class="img-fluid rounded" style="max-height: 150px;">
                                    </div>
                                    {% endif %}

                                    <div class="mb-2"><strong>Date:</strong> {{ imagerie.date_examen|date:"d/m/Y"|default:"-" }}</div>

                                    {% if imagerie.interpretation %}
                                    <div class="mb-2">
                                        <strong>Interprétation:</strong>
                                        <p class="mb-0">{{ imagerie.interpretation|truncatechars:100 }}</p>
                                    </div>
                                    {% endif %}

                                    <div class="mb-2">
                                        <strong>Statut:</strong>
                                        <span class="badge
                                            {% if imagerie.status == 'completed' %}badge-success
                                            {% elif imagerie.status == 'in_progress' %}badge-primary
                                            {% elif imagerie.status == 'cancelled' %}badge-danger
                                            {% else %}badge-warning{% endif %}">
                                            {{ imagerie.get_status_display|default:imagerie.status|default:"-" }}
                                        </span>
                                    </div>

                                    <div class="mt-3">
                                        {% if imagerie.rapport_file %}
                                        <a href="{{ imagerie.rapport_file.url }}" target="_blank" class="btn btn-sm btn-outline-primary btn-block">
                                            <i class="fas fa-download mr-1"></i> Télécharger rapport
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center">
                        <i class="fas fa-x-ray fa-2x mb-3"></i>
                        <h5>Aucune imagerie médicale</h5>
                        <p class="mb-0">Aucun examen d'imagerie pour ce patient.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- TAB 9: Constantes -->
                <div class="tab-pane fade" id="tabConstantes">
                    {% if constantes %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="info-card">
                                <div class="card-header"><i class="fas fa-chart-line mr-2"></i>Évolution des Constantes</div>
                                <div class="card-body"><canvas id="constantesChart" height="300"></canvas></div>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date/Heure</th>
                                    <th>TA (mmHg)</th>
                                    <th>FC (bpm)</th>
                                    <th>Temp (°C)</th>
                                    <th>SpO2 (%)</th>
                                    <th>Poids (kg)</th>
                                    <th>IMC</th>
                                    <th>Enregistré par</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for constante in constantes|slice:":50" %}
                                <tr>
                                    <td>{{ constante.created_at|date:"d/m/Y H:i"|default:"-" }}</td>
                                    <td>
                                        {% if constante.tension_systolique and constante.tension_diastolique %}
                                        <span class="font-weight-bold {% if constante.alerte %}text-danger{% endif %}">
                                            {{ constante.tension_systolique }}/{{ constante.tension_diastolique }}
                                        </span>
                                        {% else %}-{% endif %}
                                    </td>
                                    <td>{{ constante.frequence_cardiaque|default:"-" }}</td>
                                    <td>{{ constante.temperature|default:"-" }}</td>
                                    <td>{{ constante.saturation_oxygene|default:"-" }}</td>
                                    <td>{{ constante.poids|default:"-" }}</td>
                                    <td>
                                        {% if constante.imc %}
                                        <span class="badge
                                            {% if constante.imc < 18.5 %}badge-warning
                                            {% elif constante.imc >= 18.5 and constante.imc <= 24.9 %}badge-success
                                            {% elif constante.imc >= 25 and constante.imc <= 29.9 %}badge-warning
                                            {% else %}badge-danger{% endif %}">
                                            {{ constante.imc }}
                                        </span>
                                        {% else %}-{% endif %}
                                    </td>
                                    <td>{{ constante.created_by.get_full_name|default:constante.created_by|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center">
                        <i class="fas fa-heartbeat fa-2x mb-3"></i>
                        <h5>Aucune constante enregistrée</h5>
                        <p class="mb-0">Aucune donnée de constante pour ce patient.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- TAB 10: Tests VIH -->
                <div class="tab-pane fade" id="tabTestsVIH">
                    {% if tests_vih %}
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="info-card">
                                <div class="card-header"><i class="fas fa-virus mr-2"></i>Historique des Tests VIH</div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Date Test</th>
                                                    <th>Type Test</th>
                                                    <th>Résultat</th>
                                                    <th>Viral Load</th>
                                                    <th>CD4 Count</th>
                                                    <th>Lieu Test</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for test in tests_vih %}
                                                <tr>
                                                    <td>{{ test.date_test|date:"d/m/Y"|default:"-" }}</td>
                                                    <td>{{ test.type_test|default:"-" }}</td>
                                                    <td>
                                                        <span class="badge
                                                            {% if test.resultat == 'Positif' %}badge-danger
                                                            {% elif test.resultat == 'Négatif' %}badge-success
                                                            {% else %}badge-warning{% endif %} badge-custom">
                                                            {{ test.resultat|default:"-" }}
                                                        </span>
                                                    </td>
                                                    <td>{% if test.viral_load %}{{ test.viral_load }} copies/mL{% else %}-{% endif %}</td>
                                                    <td>{% if test.cd4_count %}{{ test.cd4_count }} cellules/μL{% else %}-{% endif %}</td>
                                                    <td>{{ test.lieu_test|default:"-" }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="info-card">
                                <div class="card-header"><i class="fas fa-chart-pie mr-2"></i>Statistiques Tests</div>
                                <div class="card-body"><canvas id="vihChart" height="250"></canvas></div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center">
                        <i class="fas fa-shield-virus fa-2x mb-3"></i>
                        <h5>Aucun test VIH enregistré</h5>
                        <p class="mb-0">Aucun test VIH pour ce patient.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- TAB 11: Suivis -->
                <div class="tab-pane fade" id="tabSuivis">
                    {% if suivis %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="thead-primary">
                                <tr>
                                    <th>Date début</th>
                                    <th>Date fin</th>
                                    <th>Activité</th>
                                    <th>Service</th>
                                    <th>Statut</th>
                                    <th>Observations</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for suivi in suivis %}
                                <tr>
                                    <td>{{ suivi.date_debut|date:"d/m/Y"|default:"-" }}</td>
                                    <td>
                                        {% if suivi.date_fin %}
                                            {{ suivi.date_fin|date:"d/m/Y" }}
                                        {% else %}
                                            <span class="badge badge-warning">En cours</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ suivi.activite.nom|default:"-" }}</td>
                                    <td>
                                        {% if suivi.services %}
                                            <span class="badge badge-info">{{ suivi.services.nom|default:"-" }}</span>
                                        {% else %}-{% endif %}
                                    </td>
                                    <td>
                                        <span class="badge
                                            {% if suivi.status == 'completed' %}badge-success
                                            {% elif suivi.status == 'in_progress' %}badge-primary
                                            {% elif suivi.status == 'pending' %}badge-warning
                                            {% else %}badge-secondary{% endif %} badge-custom">
                                            {{ suivi|safe_get:"status"|default:"-" }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if suivi.observation %}
                                        <button class="btn btn-sm btn-outline-primary"
                                                data-toggle="popover"
                                                title="Observations"
                                                data-content="{{ suivi.observation }}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% else %}-{% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center">
                        <i class="fas fa-user-check fa-2x mb-3"></i>
                        <h5>Aucun suivi médical</h5>
                        <p class="mb-0">Aucun suivi médical enregistré pour ce patient.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- TAB 12: Cas Contacts -->
                <div class="tab-pane fade" id="tabCasContacts">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h5 class="text-primary"><i class="fas fa-users mr-2"></i>Cas Contacts</h5>
                        </div>
                        <div class="col-md-4 text-right">
                            <button class="btn btn-primary" data-toggle="modal" data-target="#modalDefault">
                                <i class="fas fa-user-plus mr-1"></i> Ajouter un Contact
                            </button>
                        </div>
                    </div>

                    {% if case_contacts %}
                    <div class="row">
                        {% for contact in case_contacts %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="info-card h-100">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">{{ contact.contact_person|default:"-" }}</h6>
                                    <div class="mb-2"><i class="fas fa-phone text-secondary mr-2"></i>{{ contact.phone_number|default:"-" }}</div>
                                    <div class="mb-2"><i class="fas fa-handshake text-secondary mr-2"></i>{{ contact.get_relationship_display|default:"-" }}</div>
                                    <div class="mb-2"><i class="fas fa-history text-secondary mr-2"></i>{{ contact.get_contact_frequency_display|default:"-" }}</div>
                                    {% if contact.date_contact %}
                                    <div class="mb-2"><i class="far fa-calendar text-secondary mr-2"></i>Dernier contact: {{ contact.date_contact|date:"d/m/Y" }}</div>
                                    {% endif %}
                                    {% if contact.smsdepistage %}
                                    <div class="mb-2">
                                        <span class="badge badge-success"><i class="fas fa-sms mr-1"></i> SMS envoyé</span>
                                    </div>
                                    {% endif %}
                                    {% if contact.details %}
                                    <div class="mt-3"><small class="text-muted">{{ contact.details|truncatechars:60 }}</small></div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center">
                        <i class="fas fa-users fa-2x mb-3"></i>
                        <h5>Aucun cas contact</h5>
                        <p class="mb-0">Aucun cas contact enregistré pour ce patient.</p>
                    </div>
                    {% endif %}
                </div>

            </div>
        </div>
    </div>
</div>

<!-- MODAL: Add Contact -->
<div class="modal fade" tabindex="-1" id="modalDefault">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary">
                    <i class="fas fa-user-plus mr-2"></i>Ajouter un Cas Contact
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="casContactForm" method="post" action="{% url 'add_cas_contact' patient_id=patientsdetail.id %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="id_contact_person" class="form-label">Personne Contact *</label>
                        {{ cascontactsForm.contact_person }}
                    </div>
                    <div class="form-group">
                        <label for="id_phone_number" class="form-label">Téléphone *</label>
                        {{ cascontactsForm.phone_number }}
                    </div>
                    <div class="form-group">
                        <label for="id_relationship" class="form-label">Relation *</label>
                        {{ cascontactsForm.relationship }}
                    </div>
                    <div class="form-group">
                        <label for="id_contact_frequency" class="form-label">Fréquence de Contact</label>
                        {{ cascontactsForm.contact_frequency }}
                    </div>
                    <div class="form-group">
                        <label for="id_date_contact" class="form-label">Date du Dernier Contact</label>
                        {{ cascontactsForm.date_contact }}
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            {{ cascontactsForm.smsdepistage }}
                            <label class="custom-control-label" for="id_smsdepistage">SMS de Sensibilisation</label>
                        </div>
                    </div>
                    <div class="form-group text-right">
                        <button type="button" class="btn btn-outline-secondary mr-2" data-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-1"></i> Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODALS: Prescription details -->
{% for prescription in prescriptions %}
<div class="modal fade" tabindex="-1" id="prescriptionDetail{{ prescription.id }}">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary">
                    <i class="fas fa-pills mr-2"></i>Détail Prescription #{{ prescription.id }}
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 h-100">
                            <div class="font-weight-bold mb-2">Informations</div>
                            <div class="info-item"><span class="info-label">Date</span><span class="info-value">{{ prescription.prescribed_at|date:"d/m/Y H:i"|default:"-" }}</span></div>
                            <div class="info-item"><span class="info-label">Médicament</span><span class="info-value">{{ prescription.medication.nom|default:"-" }}</span></div>
                            <div class="info-item"><span class="info-label">DCI</span><span class="info-value">{{ prescription.medication.dci|default:"-" }}</span></div>
                            <div class="info-item"><span class="info-label">Posologie</span><span class="info-value">{{ prescription.dosage|default:"-" }}</span></div>
                            <div class="info-item"><span class="info-label">Quantité</span><span class="info-value">{{ prescription.quantity|default:"-" }} {{ prescription.unite_prise|default:"" }}</span></div>
                            <div class="info-item"><span class="info-label">Statut</span><span class="info-value">{{ prescription.get_status_display|default:prescription.status|default:"-" }}</span></div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 h-100">
                            <div class="font-weight-bold mb-2">Traçabilité</div>
                            <div class="info-item"><span class="info-label">Médecin</span><span class="info-value">{{ prescription.doctor.get_full_name|default:prescription.doctor|default:"-" }}</span></div>
                            <div class="info-item"><span class="info-label">Créé par</span><span class="info-value">{{ prescription.created_by.get_full_name|default:prescription.created_by|default:"-" }}</span></div>
                            <div class="info-item"><span class="info-label">Exécuté par</span><span class="info-value">{{ prescription.executed_by.get_full_name|default:prescription.executed_by|default:"-" }}</span></div>
                            <div class="info-item"><span class="info-label">Annulé par</span><span class="info-value">{{ prescription.cancellation_by.get_full_name|default:prescription.cancellation_by|default:"-" }}</span></div>
                            <div class="info-item"><span class="info-label">Hospitalisation</span><span class="info-value">{{ prescription.hospitalisation|default:"-" }}</span></div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="border rounded p-3">
                            <div class="font-weight-bold mb-2">Exécutions</div>
                            {% if prescription.executions.all %}
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <thead>
                                            <tr>
                                                <th>Date/Heure</th>
                                                <th>Statut</th>
                                                <th>Note</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for ex in prescription.executions.all %}
                                            <tr>
                                                <td>{{ ex.scheduled_at|date:"d/m/Y H:i"|default:ex.created_at|date:"d/m/Y H:i"|default:"-" }}</td>
                                                <td>{{ ex.get_status_display|default:ex.status|default:"-" }}</td>
                                                <td>{{ ex.note|default:"-" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-muted">Aucune exécution enregistrée.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    $('[data-toggle="tooltip"]').tooltip();
    $('[data-toggle="popover"]').popover({ trigger: 'hover', placement: 'top' });

    $('.print-btn').click(function() { window.print(); });

    $('.back-btn').hover(
        function() { $(this).find('em').addClass('animate__animated animate__shakeX'); },
        function() { $(this).find('em').removeClass('animate__animated animate__shakeX'); }
    );

    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        const target = $(e.target).attr("href");
        $(target).addClass('animate__animated animate__fadeIn');
        localStorage.setItem('activePatientTab', target);
    });

    const activeTab = localStorage.getItem('activePatientTab');
    if (activeTab && $(activeTab).length) {
        $('.nav-tabs a[href="' + activeTab + '"]').tab('show');
    }

    // Search consultations (page courante)
    $('#searchConsultations').on('keyup', function() {
        const value = $(this).val().toLowerCase();
        $('.consultation-item').filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
        });
    });

    // Charts
    if (typeof Chart !== 'undefined') {
        const appointmentsCtx = document.getElementById('appointmentsChart');
        if (appointmentsCtx) {
            new Chart(appointmentsCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Confirmés', 'En attente', 'Annulés'],
                    datasets: [{
                        data: [
                            {{ appointments|filter_by_status:"confirmed"|length }},
                            {{ appointments|filter_by_status:"pending"|length }},
                            {{ appointments|filter_by_status:"cancelled"|length }}
                        ],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        const constantesCtx = document.getElementById('constantesChart');
        if (constantesCtx && {{ constantes|length }} > 0) {
            const dates = [];
            const taValues = [];
            const fcValues = [];
            const tempValues = [];

            {% for constante in constantes|slice:"::-1"|slice:":10" %}
                dates.push('{{ constante.created_at|date:"d/m" }}');
                {% if constante.tension_systolique %} taValues.push({{ constante.tension_systolique }}); {% else %} taValues.push(null); {% endif %}
                {% if constante.frequence_cardiaque %} fcValues.push({{ constante.frequence_cardiaque }}); {% else %} fcValues.push(null); {% endif %}
                {% if constante.temperature %} tempValues.push({{ constante.temperature }}); {% else %} tempValues.push(null); {% endif %}
            {% endfor %}

            new Chart(constantesCtx, {
                type: 'line',
                data: {
                    labels: dates.reverse(),
                    datasets: [
                        { label: 'TA Systolique', data: taValues.reverse(), borderColor: 'rgb(74, 108, 247)', backgroundColor: 'rgba(74, 108, 247, 0.1)', tension: 0.4, fill: true },
                        { label: 'FC', data: fcValues.reverse(), borderColor: 'rgb(40, 167, 69)', backgroundColor: 'rgba(40, 167, 69, 0.1)', tension: 0.4, fill: false },
                        { label: 'Température', data: tempValues.reverse(), borderColor: 'rgb(255, 193, 7)', backgroundColor: 'rgba(255, 193, 7, 0.1)', tension: 0.4, fill: false }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: false } } }
            });
        }

        const vihCtx = document.getElementById('vihChart');
        if (vihCtx && {{ tests_vih|length }} > 0) {
            const positif = {{ tests_vih|filter_by_result:"Positif"|length }};
            const negatif = {{ tests_vih|filter_by_result:"Négatif"|length }};
            const indetermine = {{ tests_vih|length }} - positif - negatif;

            new Chart(vihCtx, {
                type: 'pie',
                data: {
                    labels: ['Positifs', 'Négatifs', 'Indéterminés'],
                    datasets: [{
                        data: [positif, negatif, indetermine],
                        backgroundColor: [
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(108, 117, 125, 0.8)'
                        ]
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }
    }

    // Cas contact AJAX
    $('#casContactForm').on('submit', function(e) {
        e.preventDefault();
        const form = $(this);
        const submitBtn = form.find('button[type="submit"]');
        const originalText = submitBtn.html();

        submitBtn.html('<span class="loading-spinner mr-2"></span> Enregistrement...');
        submitBtn.prop('disabled', true);

        $.ajax({
            type: form.attr('method'),
            url: form.attr('action'),
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    submitBtn.html('<i class="fas fa-check mr-1"></i> Enregistré!');
                    submitBtn.removeClass('btn-primary').addClass('btn-success');
                    setTimeout(function() {
                        $('#modalDefault').modal('hide');
                        location.reload();
                    }, 1200);
                } else {
                    submitBtn.html(originalText);
                    submitBtn.prop('disabled', false);
                    alert('Erreur: ' + (response.message || 'Impossible d’enregistrer'));
                }
            },
            error: function(xhr, status, error) {
                submitBtn.html(originalText);
                submitBtn.prop('disabled', false);
                alert('Une erreur est survenue: ' + error);
            }
        });
    });

    $('#modalDefault').on('hidden.bs.modal', function () {
        $('#casContactForm')[0].reset();
        const submitBtn = $('#casContactForm button[type="submit"]');
        submitBtn.html('<i class="fas fa-save mr-1"></i> Enregistrer');
        submitBtn.prop('disabled', false);
        submitBtn.removeClass('btn-success').addClass('btn-primary');
    });
});
</script>
{% endblock %}