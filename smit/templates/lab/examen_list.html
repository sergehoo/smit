{% extends 'layout/base.html' %}
{% load static %}
{% load humanize %}
{% block content %}

<div class="nk-content nk-content-fluid">
  <div class="container-xl wide-lg">
    <div class="nk-content-body">
      <div class="nk-block-head nk-block-head-sm">
        <div class="nk-block-between">
          <div class="nk-block-head-content">
            <h3 class="nk-block-title page-title">Demande d'analyse</h3>
            <div class="nk-block-des text-soft">
              <p>Liste des demandes d'Analyses</p>
            </div>
          </div>
          <div class="nk-block-head-content">
            {% include 'layout/toggleoption.html' %}
          </div>
        </div>
      </div>

      <div class="nk-block">
        <div class="card card-bordered card-stretch">
          <div class="card-inner-group">

            <!-- En-tête avec bouton d'enregistrement multiple -->
            <div class="card-inner">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="text-muted small">
                  Sélectionnez une ou plusieurs lignes puis cliquez sur <strong>Enregistrer la sélection</strong>.
                </div>
                <button type="button" id="bulkSaveBtn" class="btn btn-primary btn-sm">
                  <i class="fas fa-save mr-1"></i> Enregistrer la sélection
                </button>
              </div>
            </div>

            <!-- Filtres -->
            <form method="get" action="{% url 'examen_list' %}" class="mb-4">
              <div class="row p-2">
                <div class="col-md-3">{{ filter.form.type_examen.label_tag }} {{ filter.form.type_examen }}</div>
                <div class="col-md-3">{{ filter.form.doctor.label_tag }} {{ filter.form.doctor }}</div>
                <div class="col-md-3">{{ filter.form.patient.label_tag }} {{ filter.form.patient }}</div>
                <div class="col-md-3 d-flex align-items-end">
                  <button type="submit" class="btn btn-primary w-100">Filtrer</button>
                  <a href="{% url 'examen_list' %}" class="btn btn-danger ml-3 w-100">Reset</a>
                </div>
              </div>
            </form>

            <!-- Accordion types (lazy load HTMX) -->
            <div class="accordion" id="examensAccordion">
              {% for t in types_meta %}
                <div class="accordion-item pl-3 pr-3">
                  <h2 class="accordion-header" id="heading-{{ t.slug }}">
                    <button
                      class="accordion-button collapsed btn btn-outline-secondary uniform-btn w-100"
                      type="button"
                      data-toggle="collapse"
                      data-target="#collapse-{{ t.slug }}"
                      aria-expanded="false"
                      aria-controls="collapse-{{ t.slug }}">
                      {{ t.name }}
                      <strong class="ml-2 float-right">({{ t.count }})</strong>
                    </button>
                  </h2>

                  <div id="collapse-{{ t.slug }}"
                       class="accordion-collapse collapse"
                       aria-labelledby="heading-{{ t.slug }}"
                       data-parent="#examensAccordion">
                    <div class="accordion-body">
                      <!-- Panel qui charge le partiel au premier affichage -->
                      <div id="panel-{{ t.slug }}"
                           hx-get="{% url 'examen_type_partial' t.slug %}{{ query_prefix }}page=1"
                           hx-trigger="revealed"
                           hx-swap="innerHTML">
                        <div class="text-center text-muted py-3">Chargement…</div>
                      </div>
                    </div>
                  </div>
                </div>
              {% empty %}
                <div class="alert alert-warning text-center">Aucun examen trouvé.</div>
              {% endfor %}
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Toast container -->
<div aria-live="polite" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 1060;">
  <div id="toast-stack"></div>
</div>

<style>
  .toast { min-width: 300px; margin-bottom: 10px; }
  .toast-header .badge-dot { width:10px; height:10px; border-radius:50%; margin-right:8px; display:inline-block; }
  .toast-success .badge-dot { background:#28a745; }
  .toast-error .badge-dot { background:#dc3545; }
  .toast-info .badge-dot { background:#17a2b8; }
  .toast-warning .badge-dot { background:#ffc107; }
  .table-primary { background-color:#e3f2fd!important; }
  .is-valid { border-color:#198754!important; background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e"); background-repeat:no-repeat; background-position:right calc(0.375em + 0.1875rem) center; background-size:calc(0.75em + 0.375rem) calc(0.75em + 0.375rem); }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  console.log("✅ DOM prêt");

  // ---- CSRF helpers
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
  }
  function getCSRFToken() {
    // 1) input caché si présent (form actuel)
    const fromInput = document.querySelector("[name=csrfmiddlewaretoken]");
    if (fromInput && fromInput.value) return fromInput.value;
    // 2) cookie (pour fetch JSON/bulk)
    return getCookie("csrftoken");
  }

  // ---- Toast (reprend ta fonction)
  function notify(type, message, subtitle = '') {
    const $stack = document.getElementById('toast-stack');
    if (!$stack) { alert(message); return; }
    const id = 't_' + Date.now() + '_' + Math.floor(Math.random()*9999);
    const cls = 'toast-' + (type || 'info');
    const title = {success:'Succès', error:'Erreur', info:'Information', warning:'Attention'}[type] || 'Information';
    const el = document.createElement('div');
    el.id = id;
    el.className = `toast ${cls}`;
    el.setAttribute('role', 'alert');
    el.setAttribute('aria-live', 'assertive');
    el.setAttribute('aria-atomic', 'true');
    el.innerHTML = `
      <div class="toast-header">
        <span class="badge-dot"></span>
        <strong class="me-auto">${title}</strong>
        ${subtitle ? `<small class="text-muted">${subtitle}</small>` : ''}
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">${message}</div>
    `;
    $stack.appendChild(el);
    const toast = new bootstrap.Toast(el, { delay: 5000 });
    toast.show();
    el.addEventListener('hidden.bs.toast', () => el.remove());
  }

  // ---- Sélection par type (checkbox master)
  document.addEventListener('change', function (e) {
    if (!e.target.classList.contains('select-all-type')) return;
    const type = e.target.getAttribute('data-type');
    const checked = e.target.checked;
    document.querySelectorAll(`.row-check[data-type="${type}"]`).forEach(cb => {
      cb.checked = checked;
      const row = cb.closest('tr');
      if (row) row.classList.toggle('table-primary', checked);
    });
  });

  // ---- Coloration lignes (row-check)
  document.addEventListener('change', function (e) {
    if (!e.target.classList.contains('row-check')) return;
    const row = e.target.closest('tr');
    if (row) row.classList.toggle('table-primary', e.target.checked);
  });

  // ---- Enregistrement unitaire (délégation)
  document.addEventListener('click', async function (e) {
    const btn = e.target.closest('.save-btn');
    if (!btn) return;
    e.preventDefault();

    // Empêche double-clic
    if (btn.disabled) return;

    const examenId = btn.getAttribute('data-id');
    const postUrl  = btn.getAttribute('data-url');   // URL déjà rendue côté serveur

    if (!examenId || !postUrl) {
      notify('error', "Paramètres manquants pour l'enregistrement.");
      return;
    }

    const resultInput     = document.querySelector(`.result-input[data-id="${examenId}"]`);
    const resultDateInput = document.querySelector(`.result-date[data-id="${examenId}"]`);
    const commentInput    = document.querySelector(`.result-comment[data-id="${examenId}"]`);

    if (!resultInput)  { notify('error', "Champ 'résultat' introuvable."); return; }
    if (!resultInput.value.trim()) {
      notify('error', 'Le résultat est requis.');
      resultInput.focus();
      return;
    }

    const formData = new FormData();
    formData.append("csrfmiddlewaretoken", getCSRFToken() || '');
    formData.append("result", resultInput.value.trim());
    formData.append("result_date", (resultDateInput?.value || '').trim());
    formData.append("comment", (commentInput?.value || '').trim());

    try {
      btn.disabled = true;
      btn.dataset.prevText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Enregistrement...';

      const resp = await fetch(postUrl, {
        method: "POST",
        body: formData,
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });

      if (!resp.ok) {
        const txt = await resp.text();
        throw new Error(`HTTP ${resp.status} — ${txt.slice(0, 200)}`);
      }
      const data = await resp.json();
      if (data.success) {
        notify('success', 'Résultat enregistré avec succès !');
        resultInput.classList.add('is-valid');
        setTimeout(() => window.location.reload(), 800);
      } else {
        notify('error', data.errors || 'Erreur inconnue.');
      }
    } catch (err) {
      console.error('❌ Unitaire:', err);
      notify('error', "Erreur lors de l'enregistrement.");
    } finally {
      btn.disabled = false;
      if (btn.dataset.prevText) btn.innerHTML = btn.dataset.prevText;
    }
  });

  // ---- Enregistrement en masse
  const bulkBtn = document.getElementById('bulkSaveBtn');
  if (bulkBtn) {
    bulkBtn.setAttribute('type', 'button'); // sécurité
    bulkBtn.addEventListener('click', async function () {
      const selected = Array.from(document.querySelectorAll('.row-check:checked'));
      if (!selected.length) { notify('warning', 'Sélectionnez au moins une ligne.'); return; }

      const items = selected.map(cb => {
        const id = cb.getAttribute('data-id');
        return {
          id: parseInt(id, 10),
          result: (document.querySelector(`.result-input[data-id="${id}"]`)?.value || '').trim(),
          result_date: (document.querySelector(`.result-date[data-id="${id}"]`)?.value || '').trim(),
          comment: (document.querySelector(`.result-comment[data-id="${id}"]`)?.value || '').trim(),
        };
      });

      // validation
      const invalid = items.filter(x => !x.result);
      if (invalid.length) {
        notify('error', `${invalid.length} ligne(s) sans résultat.`);
        return;
      }

      try {
        bulkBtn.disabled = true;
        const prev = bulkBtn.innerHTML;
        bulkBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Traitement...';

        const resp = await fetch("{% url 'update_examen_results_bulk' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken() || '',
            "X-Requested-With": "XMLHttpRequest",
          },
          body: JSON.stringify({ items }),
        });

        if (!resp.ok) {
          const txt = await resp.text();
          throw new Error(`HTTP ${resp.status} — ${txt.slice(0, 200)}`);
        }
        const data = await resp.json();
        if (data.success) {
          notify('success', `${data.updated} résultat(s) enregistré(s)`);
          // feedback
          selected.forEach(cb => {
            const id = cb.getAttribute('data-id');
            const row = document.getElementById(`exam-${id}`);
            const res = document.querySelector(`.result-input[data-id="${id}"]`);
            if (row) row.classList.add('table-success');
            if (res) res.classList.add('is-valid');
            cb.checked = false;
            if (row) row.classList.remove('table-primary');
          });
          setTimeout(() => window.location.reload(), 1200);
        } else {
          notify('error', data.message || "Erreur bulk");
          if (data.errors?.length) console.warn('Détails:', data.errors);
        }

        bulkBtn.innerHTML = prev;
      } catch (err) {
        console.error('❌ Bulk:', err);
        notify('error', "Erreur réseau lors de l'enregistrement multiple.");
      } finally {
        bulkBtn.disabled = false;
      }
    });
  }

  // ---- Enter = save unitaire sur le champ résultat
  document.addEventListener('keydown', function (e) {
    if (e.key !== 'Enter') return;
    const t = e.target;
    if (!t.classList.contains('result-input')) return;
    e.preventDefault();
    const id = t.getAttribute('data-id');
    const btn = document.querySelector(`.save-btn[data-id="${id}"]`);
    if (btn) btn.click();
  });
});
</script>

{% endblock %}