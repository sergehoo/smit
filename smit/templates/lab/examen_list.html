{% extends 'layout/base.html' %}
{% load static %}
{% load humanize %}
{% block content %}

<div class="nk-content nk-content-fluid">
  <div class="container-xl wide-lg">
    <div class="nk-content-body">
      <div class="nk-block-head nk-block-head-sm">
        <div class="nk-block-between">
          <div class="nk-block-head-content">
            <h3 class="nk-block-title page-title">Demande d'analyse</h3>
            <div class="nk-block-des text-soft">
              <p>Liste des demandes d'Analyses</p>
            </div>
          </div>
          <div class="nk-block-head-content">
            {% include 'layout/toggleoption.html' %}
          </div>
        </div>
      </div>

      <div class="nk-block">
        <div class="card card-bordered card-stretch">
          <div class="card-inner-group">

            <!-- En-tête avec bouton d'enregistrement multiple -->
            <div class="card-inner">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="text-muted small">
                  Sélectionnez une ou plusieurs lignes puis cliquez sur <strong>Enregistrer la sélection</strong>.
                </div>
                <button type="button" id="bulkSaveBtn" class="btn btn-primary btn-sm">
                  <i class="fas fa-save mr-1"></i> Enregistrer la sélection
                </button>
              </div>
            </div>

            <!-- Filtres -->
            <form method="get" action="{% url 'examen_list' %}" class="mb-4">
              <div class="row p-2">
                <div class="col-md-3">{{ filter.form.type_examen.label_tag }} {{ filter.form.type_examen }}</div>
                <div class="col-md-3">{{ filter.form.doctor.label_tag }} {{ filter.form.doctor }}</div>
                <div class="col-md-3">{{ filter.form.patient.label_tag }} {{ filter.form.patient }}</div>
                <div class="col-md-3 d-flex align-items-end">
                  <button type="submit" class="btn btn-primary w-100">Filtrer</button>
                  <a href="{% url 'examen_list' %}" class="btn btn-danger ml-3 w-100">Reset</a>
                </div>
              </div>
            </form>

            <!-- Accordion types (lazy load HTMX) -->
            <div class="accordion" id="examensAccordion">
              {% for t in types_meta %}
                <div class="accordion-item pl-3 pr-3">
                  <h2 class="accordion-header" id="heading-{{ t.slug }}">
                    <button
                      class="accordion-button collapsed btn btn-outline-secondary uniform-btn w-100"
                      type="button"
                      data-toggle="collapse"
                      data-target="#collapse-{{ t.slug }}"
                      aria-expanded="false"
                      aria-controls="collapse-{{ t.slug }}">
                      {{ t.name }}
                      <strong class="ml-2 float-right">({{ t.count }})</strong>
                    </button>
                  </h2>

                  <div id="collapse-{{ t.slug }}"
                       class="accordion-collapse collapse"
                       aria-labelledby="heading-{{ t.slug }}"
                       data-parent="#examensAccordion">
                    <div class="accordion-body">
                      <!-- Panel qui charge le partiel au premier affichage -->
                      <div id="panel-{{ t.slug }}"
                           hx-get="{% url 'examen_type_partial' t.slug %}{{ query_prefix }}page=1"
                           hx-trigger="revealed"
                           hx-swap="innerHTML">
                        <div class="text-center text-muted py-3">Chargement…</div>
                      </div>
                    </div>
                  </div>
                </div>
              {% empty %}
                <div class="alert alert-warning text-center">Aucun examen trouvé.</div>
              {% endfor %}
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Toast container -->
<div aria-live="polite" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 1060;">
  <div id="toast-stack"></div>
</div>

<style>
  .toast { min-width: 300px; margin-bottom: 10px; }
  .toast-header .badge-dot { width:10px; height:10px; border-radius:50%; margin-right:8px; display:inline-block; }
  .toast-success .badge-dot { background:#28a745; }
  .toast-error .badge-dot { background:#dc3545; }
  .toast-info .badge-dot { background:#17a2b8; }
  .toast-warning .badge-dot { background:#ffc107; }
  .table-primary { background-color:#e3f2fd!important; }
  .is-valid { border-color:#198754!important; background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e"); background-repeat:no-repeat; background-position:right calc(0.375em + 0.1875rem) center; background-size:calc(0.75em + 0.375rem) calc(0.75em + 0.375rem); }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const csrfToken = (document.querySelector("[name=csrfmiddlewaretoken]") || {}).value;

  function notify(type, message, subtitle='') {
    const $stack = document.getElementById('toast-stack');
    if (!$stack) { alert(message); return; }

    const id = 't_' + Date.now() + '_' + Math.floor(Math.random()*9999);
    const cls = 'toast-' + (type || 'info');
    const title = {success:'Succès', error:'Erreur', info:'Information', warning:'Attention'}[type] || 'Information';

    const toastEl = document.createElement('div');
    toastEl.id = id;
    toastEl.className = `toast ${cls}`;
    toastEl.setAttribute('role','alert'); toastEl.setAttribute('aria-live','assertive'); toastEl.setAttribute('aria-atomic','true');
    toastEl.innerHTML = `
      <div class="toast-header">
        <span class="badge-dot"></span>
        <strong class="me-auto">${title}</strong>
        ${subtitle ? `<small class="text-muted">${subtitle}</small>` : ''}
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">${message}</div>
    `;
    $stack.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
    toast.show();
    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
  }

  // Sélection "tout le type" (déléguée, car contenu chargé en HTMX)
  document.addEventListener('change', function(e){
    if (e.target.classList.contains('select-all-type')) {
      const type = e.target.getAttribute('data-type');
      const isChecked = e.target.checked;
      document.querySelectorAll(`.row-check[data-type="${type}"]`).forEach(cb => {
        cb.checked = isChecked;
        const row = cb.closest('tr');
        if (row) row.classList.toggle('table-primary', isChecked);
      });
    }
    if (e.target.classList.contains('row-check')) {
      const row = e.target.closest('tr');
      if (row) row.classList.toggle('table-primary', e.target.checked);
    }
  });

  // Click "Enregistrer" (délégué)
  document.addEventListener("click", function(e){
    const btn = e.target.closest(".save-btn");
    if (!btn) return;

    e.preventDefault();
    const id = btn.getAttribute("data-id"); // ID du BilanParaclinique
    if (!id) { notify('error', "ID manquant"); return; }

    const resultInput = document.querySelector(`.result-input[data-id="${id}"]`);
    const resultDateInput = document.querySelector(`.result-date[data-id="${id}"]`);
    const commentInput = document.querySelector(`.result-comment[data-id="${id}"]`);

    if (!resultInput || !resultDateInput || !commentInput) {
      notify('error', "Champs introuvables"); return;
    }
    if (!resultInput.value.trim()) {
      notify('error', "Le résultat est requis."); resultInput.focus(); return;
    }

    const updateUrl = "{% url 'update_examen_result' 0 %}".replace("0", id);
    const formData = new FormData();
    if (csrfToken) formData.append("csrfmiddlewaretoken", csrfToken);
    formData.append("result", resultInput.value);
    formData.append("result_date", resultDateInput.value);
    formData.append("comment", commentInput.value);

    fetch(updateUrl, { method: "POST", body: formData })
      .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
      .then(data => {
        if (data.success) {
          notify('success', "Résultat enregistré");
          resultInput.classList.add('is-valid');
        } else {
          notify('error', "Erreur : " + (data.message || JSON.stringify(data.errors || {})));
        }
      })
      .catch(() => notify('error', "Erreur réseau"));
  });

  // Enregistrement en masse (délégué sur tout le document)
  const bulkSaveBtn = document.getElementById('bulkSaveBtn');
  if (bulkSaveBtn) {
    bulkSaveBtn.addEventListener('click', function(){
      const selected = Array.from(document.querySelectorAll('.row-check:checked'));
      if (!selected.length) { notify('warning', 'Sélectionnez au moins une ligne.'); return; }

      const items = selected.map(cb => {
        const id = cb.getAttribute('data-id');
        return {
          id: parseInt(id, 10),
          result: (document.querySelector(`.result-input[data-id="${id}"]`)?.value || "").trim(),
          result_date: (document.querySelector(`.result-date[data-id="${id}"]`)?.value || "").trim(),
          comment: (document.querySelector(`.result-comment[data-id="${id}"]`)?.value || "").trim(),
        };
      });

      const invalid = items.filter(it => !it.result);
      if (invalid.length) { notify('error', `${invalid.length} ligne(s) sans résultat.`); return; }

      bulkSaveBtn.disabled = true;
      bulkSaveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Traitement...';

      fetch("{% url 'update_examen_results_bulk' %}", {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken, "Content-Type": "application/json" },
        body: JSON.stringify({ items })
      })
      .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
      .then(data => {
        if (data.success) {
          notify('success', `${data.updated} résultat(s) enregistré(s).`);
          // petit feedback visuel
          selected.forEach(cb => {
            const id = cb.getAttribute('data-id');
            const row = document.getElementById(`exam-${id}`);
            const input = document.querySelector(`.result-input[data-id="${id}"]`);
            if (row) row.classList.add('table-success');
            if (input) input.classList.add('is-valid');
            cb.checked = false;
            if (row) row.classList.remove('table-primary');
          });
          // On peut recharger la/les sections si nécessaire
          setTimeout(() => location.reload(), 1500);
        } else {
          notify('error', data.message || "Erreur lors de l'enregistrement multiple");
        }
      })
      .catch(() => notify('error', "Erreur réseau"))
      .finally(() => {
        bulkSaveBtn.disabled = false;
        bulkSaveBtn.innerHTML = '<i class="fas fa-save mr-1"></i> Enregistrer la sélection';
      });
    });
  }

  // Auto-save sur Enter
  document.addEventListener('keydown', function(e){
    if (e.key === 'Enter' && e.target.classList.contains('result-input')) {
      e.preventDefault();
      const id = e.target.getAttribute('data-id');
      const saveBtn = document.querySelector(`.save-btn[data-id="${id}"]`);
      if (saveBtn) saveBtn.click();
    }
  });
});
</script>

{% endblock %}