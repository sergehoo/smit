{% extends 'layout/base.html' %}
{% load static %}
{% block content %}
<div class="nk-content nk-content-fluid">
  <div class="container-xl wide-lg">
    <div class="nk-content-body">

      <!-- En-tête avec bannière améliorée -->
      <div class="nk-block-head nk-block-head-sm">
        <div class="row rounded position-relative overflow-hidden"
             style="height: 220px; background-image: url('{% static 'images/patient_add_banner1.png' %}'); background-size: cover; background-position: center;">
          <div class="position-absolute w-100 h-100"
               style="background: linear-gradient(135deg, rgba(220,53,69,0.85) 0%, rgba(108,117,125,0.8) 100%); top: 0; left: 0;"></div>
          <div class="nk-block-between position-relative z-index-1">
            <div class="nk-block-head-content text-center w-100 py-5">
              <h1 class="nk-block-title page-title text-white mb-3">ADMISSION EN URGENCE</h1>
              <div class="nk-block-des">
                <p class="text-white-80 lead">Processus d'admission en deux étapes</p>
              </div>
              <div class="mt-3">
                <span class="badge badge-pill badge-warning p-2">Priorité absolue</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Indicateur de progression -->
      <div class="nk-block mt-4">
        <div class="progress-indicator mb-4">
          <div class="d-flex justify-content-between position-relative">
            <div class="step active" id="step1-indicator">
              <div class="step-circle">1</div>
              <div class="step-label small mt-2">Informations<br>du patient</div>
            </div>
            <div class="step" id="step2-indicator">
              <div class="step-circle">2</div>
              <div class="step-label small mt-2">Détails<br>d'hospitalisation</div>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Formulaire en 2 étapes -->
      <div class="nk-block">
        <div class="card card-bordered card-stretch shadow-sm">

          <!-- Étape 1: Informations du patient -->
          <div id="step1" class="form-step">
            <div class="card-header border-bottom bg-light">
              <h5 class="card-title mb-0">
                <i class="fas fa-user-injured text-danger mr-2"></i>
                Informations du patient - Étape 1/2
              </h5>
              <p class="text-muted small mb-0">Renseignez les informations de base du patient</p>
            </div>

            <form method="post" id="patient-form" novalidate>
              {% csrf_token %}
              {{ form.media }}
              <div class="card-inner-group">
                <div class="card-inner p-4">
                  <div class="alert alert-info border-info">
                    <div class="d-flex">
                      <div class="mr-3">
                        <i class="fas fa-info-circle fa-2x text-info"></i>
                      </div>
                      <div>
                        <p class="mb-1"><strong>Information :</strong> Cette étape permet d'enregistrer le patient en urgence.</p>
                        <p class="mb-0">Les informations d'hospitalisation seront saisies à l'étape suivante.</p>
                      </div>
                    </div>
                  </div>

                  <div class="row g-4">
                    <!-- Informations personnelles -->
                    <div class="col-12">
                      <h6 class="text-primary mb-3 border-bottom pb-2">
                        <i class="fas fa-id-card mr-2"></i>Informations personnelles
                      </h6>
                    </div>

                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ form.nom.id_for_label }}" class="form-label required-label">
                          {{ form.nom.label }} <span class="text-danger">*</span>
                        </label>
                        {{ form.nom }}
                        {% for error in form.nom.errors %}
                          <div class="text-danger small mt-1"><i class="fas fa-exclamation-circle mr-1"></i>{{ error }}</div>
                        {% endfor %}
                      </div>
                    </div>

                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ form.prenoms.id_for_label }}" class="form-label required-label">
                          {{ form.prenoms.label }} <span class="text-danger">*</span>
                        </label>
                        {{ form.prenoms }}
                        {% for error in form.prenoms.errors %}
                          <div class="text-danger small mt-1"><i class="fas fa-exclamation-circle mr-1"></i>{{ error }}</div>
                        {% endfor %}
                      </div>
                    </div>

                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ form.contact.id_for_label }}" class="form-label required-label">
                          {{ form.contact.label }} <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                          {{ form.contact }}
                          <span class="input-group-text"><i class="fas fa-phone"></i></span>
                        </div>
                        {% for error in form.contact.errors %}
                          <div class="text-danger small mt-1"><i class="fas fa-exclamation-circle mr-1"></i>{{ error }}</div>
                        {% endfor %}
                      </div>
                    </div>

                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ form.genre.id_for_label }}" class="form-label required-label">
                          {{ form.genre.label }} <span class="text-danger">*</span>
                        </label>
                        {{ form.genre }}
                        {% for error in form.genre.errors %}
                          <div class="text-danger small mt-1"><i class="fas fa-exclamation-circle mr-1"></i>{{ error }}</div>
                        {% endfor %}
                      </div>
                    </div>

                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ form.date_naissance.id_for_label }}" class="form-label required-label">
                          {{ form.date_naissance.label }} <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                          {{ form.date_naissance }}
                          <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                        </div>
                        {% for error in form.date_naissance.errors %}
                          <div class="text-danger small mt-1"><i class="fas fa-exclamation-circle mr-1"></i>{{ error }}</div>
                        {% endfor %}
                      </div>
                    </div>

                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ form.lieu_naissance.id_for_label }}" class="form-label">
                          {{ form.lieu_naissance.label }}
                        </label>
                        {{ form.lieu_naissance }}
                      </div>
                    </div>

                    <!-- Informations médicales -->
                    <div class="col-12 mt-4">
                      <h6 class="text-primary mb-3 border-bottom pb-2">
                        <i class="fas fa-heartbeat mr-2"></i>Informations médicales
                      </h6>
                    </div>

                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ form.groupe_sanguin.id_for_label }}" class="form-label">
                          {{ form.groupe_sanguin.label }}
                        </label>
                        {{ form.groupe_sanguin }}
                      </div>
                    </div>

                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ form.nationalite.id_for_label }}" class="form-label">
                          {{ form.nationalite.label }}
                        </label>
                        {{ form.nationalite }}
                      </div>
                    </div>

                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ form.ethnie.id_for_label }}" class="form-label">
                          {{ form.ethnie.label }}
                        </label>
                        {{ form.ethnie }}
                      </div>
                    </div>

                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ form.profession.id_for_label }}" class="form-label">
                          {{ form.profession.label }}
                        </label>
                        {{ form.profession }}
                      </div>
                    </div>

                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ form.niveau_etude.id_for_label }}" class="form-label">
                          {{ form.niveau_etude.label }}
                        </label>
                        {{ form.niveau_etude }}
                      </div>
                    </div>

                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ form.commune.id_for_label }}" class="form-label">
                          {{ form.commune.label }}
                        </label>
                        {{ form.commune }}
                      </div>
                    </div>

                    <!-- Nouvelle commune (cachée par défaut) -->
                    <div class="col-12 col-md-6" id="new_commune_group" style="display:none;">
                      <div class="form-group">
                        <label for="{{ form.nouvelle_commune.id_for_label }}" class="form-label">
                          Nouvelle commune <span class="text-danger">*</span>
                        </label>
                        {{ form.nouvelle_commune }}
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Actions étape 1 -->
                <div class="card-inner bg-light p-4 border-top">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <a href="{% url 'urgences_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left mr-2"></i> Retour à la liste
                      </a>
                    </div>
                    <div class="d-flex">
                      <button type="reset" class="btn btn-outline-danger mr-3">
                        <i class="fas fa-undo mr-2"></i> Réinitialiser
                      </button>
                      <button type="button" id="next-step-btn" class="btn btn-primary">
                        Suivant <i class="fas fa-arrow-right ml-2"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>

          <!-- Étape 2: Hospitalisation -->
          <div id="step2" class="form-step" style="display:none;">
            <div class="card-header border-bottom bg-light">
              <h5 class="card-title mb-0">
                <i class="fas fa-procedures text-primary mr-2"></i>
                Détails d'hospitalisation - Étape 2/2
              </h5>
              <p class="text-muted small mb-0">Renseignez les informations d'admission</p>
            </div>

            <div class="card-inner-group">
              <div class="card-inner p-4">
                <div class="alert alert-warning border-warning">
                  <div class="d-flex">
                    <div class="mr-3">
                      <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                    </div>
                    <div>
                      <p class="mb-1"><strong>Attention :</strong> Cette étape finalise l'admission du patient.</p>
                      <p class="mb-0">Vérifiez attentivement toutes les informations avant validation.</p>
                    </div>
                  </div>
                </div>

                <!-- Récapitulatif patient -->
                <div class="card card-bordered mb-4">
                  <div class="card-header bg-light-primary">
                    <h6 class="card-title mb-0">
                      <i class="fas fa-user-check text-primary mr-2"></i>
                      Récapitulatif du patient
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="row" id="patient-summary">
                      <!-- Rempli dynamiquement par JavaScript -->
                    </div>
                  </div>
                </div>

                <!-- Formulaire d'hospitalisation aligné sur la ModelForm -->
                <form id="hospitalization-form" novalidate>
                  {% csrf_token %}
                  <div class="row g-4">

                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ step2_form.reason_for_admission.id_for_label }}" class="form-label required-label">
                          {{ step2_form.reason_for_admission.label }} <span class="text-danger">*</span>
                        </label>
                        {{ step2_form.reason_for_admission }}
                        {% for error in step2_form.reason_for_admission.errors %}
                          <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                      </div>
                    </div>




                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ step2_form.bed.id_for_label }}" class="form-label required-label">
                          {{ step2_form.bed.label }} <span class="text-danger">*</span>
                        </label>
                        {{ step2_form.bed }}
                        {% for error in step2_form.bed.errors %}
                          <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                      </div>
                    </div>

                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ step2_form.admission_date.id_for_label }}" class="form-label required-label">
                          {{ step2_form.admission_date.label }} <span class="text-danger">*</span>
                        </label>
                        {{ step2_form.admission_date }}
                        {% for error in step2_form.admission_date.errors %}
                          <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                      </div>
                    </div>

                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ step2_form.activite.id_for_label }}" class="form-label">
                          {{ step2_form.activite.label }}
                        </label>
                        {{ step2_form.activite }}
                        {% for error in step2_form.activite.errors %}
                          <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                      </div>
                    </div>

                    {% if step2_form.status %}
                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        <label for="{{ step2_form.status.id_for_label }}" class="form-label">
                          {{ step2_form.status.label }}
                        </label>
                        {{ step2_form.status }}
                        {% for error in step2_form.status.errors %}
                          <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                      </div>
                    </div>
                    {% endif %}

                  </div>
                </form>
              </div>

              <!-- Actions étape 2 -->
              <div class="card-inner bg-light p-4 border-top">
                <div class="d-flex justify-content-between align-items-center">
                  <button type="button" id="prev-step-btn" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left mr-2"></i> Retour
                  </button>
                  <div class="d-flex">
                    <button type="button" id="save-patient-btn" class="btn btn-outline-primary mr-3">
                      <i class="fas fa-save mr-2"></i> Sauvegarder patient
                    </button>
                    <button type="button" id="submit-all-btn" class="btn btn-success">
                      <i class="fas fa-check-circle mr-2"></i> Finaliser l'admission
                    </button>
                  </div>
                </div>
              </div>
            </div> <!-- /card-inner-group -->
          </div> <!-- /step2 -->

        </div> <!-- /card -->
      </div> <!-- /nk-block -->

    </div>
  </div>
</div>

<style>
  .progress-indicator{max-width:600px;margin:0 auto}
  .step{text-align:center;z-index:2}
  .step-circle{width:40px;height:40px;border-radius:50%;background:#e9ecef;color:#6c757d;display:flex;align-items:center;justify-content:center;margin:0 auto;font-weight:700;border:3px solid #e9ecef;transition:.3s}
  .step.active .step-circle{background:#007bff;color:#fff;border-color:#007bff}
  .step.completed .step-circle{background:#28a745;color:#fff;border-color:#28a745}
  .step-label{color:#6c757d;font-weight:500}
  .step.active .step-label{color:#007bff}
  .step.completed .step-label{color:#28a745}
  .progress-bar-container{position:absolute;top:20px;left:20px;right:20px;height:4px;background:#e9ecef;z-index:1}
  .progress-bar{height:100%;background:#007bff;transition:width .3s}
  .form-control{border-radius:.375rem;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out}
  .form-control:focus{box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}
  .required-label:after{content:" *";color:#dc3545}
  .form-step{transition:opacity .3s ease}
  .patient-summary-item{padding:8px 0;border-bottom:1px solid #f1f1f1}
  .patient-summary-item:last-child{border-bottom:none}
</style>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // éléments
  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');
  const patientForm = document.getElementById('patient-form');
  const hospitalizationForm = document.getElementById('hospitalization-form');
  const savePatientBtn = document.getElementById('save-patient-btn');
  const submitAllBtn = document.getElementById('submit-all-btn');
  const nextStepBtn = document.getElementById('next-step-btn');
  const prevStepBtn = document.getElementById('prev-step-btn');
  const progressBar = document.getElementById('progress-bar');
  const patientSummary = document.getElementById('patient-summary');

  let patientId = null;  // ID créé à l’étape 1

  // IDs sûrs depuis le form Django
  const communeId = "{{ form.commune.auto_id|default_if_none:'' }}";
  const nouvelleCommuneId = "{{ form.nouvelle_commune.auto_id|default_if_none:'' }}";
  const communeSelect = communeId ? document.getElementById(communeId) : null;
  const newCommuneGroup = document.getElementById('new_commune_group');
  const newCommuneInput = nouvelleCommuneId ? document.getElementById(nouvelleCommuneId) : null;

  // CSRF
  function getCSRFToken() {
    const name = 'csrftoken';
    const cookies = document.cookie.split(';');
    for (let c of cookies) {
      c = c.trim();
      if (c.startsWith(name + '=')) return c.substring(name.length + 1);
    }
    const input = document.querySelector('input[name=csrfmiddlewaretoken]');
    return input ? input.value : '';
  }
  const CSRF = getCSRFToken();

  // Helpers
  function lock(btn, loadingText='Traitement...') {
    if (!btn) return () => {};
    const original = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>${loadingText}`;
    return () => { btn.disabled = false; btn.innerHTML = original; };
  }

  function showAlert(message, type='info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
    `;
    (document.querySelector('.nk-content-body') || document.body)
      .insertBefore(alertDiv, document.querySelector('.nk-block') || null);
    setTimeout(() => alertDiv.remove(), 6000);
  }

  function applyFieldErrors(formEl, errors) {
    // nettoie
    formEl.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    formEl.querySelectorAll('.invalid-feedback.dynamic').forEach(e => e.remove());
    // applique
    Object.entries(errors || {}).forEach(([name, msgs]) => {
      const field = formEl.querySelector(`[name="${name}"]`);
      if (field) {
        field.classList.add('is-invalid');
        const fb = document.createElement('div');
        fb.className = 'invalid-feedback dynamic d-block';
        fb.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i>${(Array.isArray(msgs)?msgs.join('<br>'):msgs)}`;
        field.closest('.form-group')?.appendChild(fb);
      }
    });
  }

  function validateRequired(formEl) {
    const required = formEl.querySelectorAll('[required]');
    let ok = true;
    required.forEach(f => {
      if (!f.value || !f.value.trim()) {
        f.classList.add('is-invalid'); ok = false;
      } else {
        f.classList.remove('is-invalid'); f.classList.add('is-valid');
      }
    });
    return ok;
  }

  function updatePatientSummary() {
    const fd = new FormData(patientForm);
    const bloc = `
      <div class="row">
        <div class="col-12 col-md-6">
          <div class="patient-summary-item"><strong>Nom complet:</strong><br>${fd.get('nom') || ''} ${fd.get('prenoms') || ''}</div>
          <div class="patient-summary-item"><strong>Contact:</strong><br>${fd.get('contact') || ''}</div>
          <div class="patient-summary-item"><strong>Genre:</strong><br>${fd.get('genre') || ''}</div>
        </div>
        <div class="col-12 col-md-6">
          <div class="patient-summary-item"><strong>Date de naissance:</strong><br>${fd.get('date_naissance') || ''}</div>
          <div class="patient-summary-item"><strong>Groupe sanguin:</strong><br>${fd.get('groupe_sanguin') || 'Non renseigné'}</div>
          <div class="patient-summary-item"><strong>Nationalité:</strong><br>${fd.get('nationalite') || 'Non renseigné'}</div>
        </div>
      </div>
    `;
    patientSummary.innerHTML = bloc;
  }

  function toggleNewCommune() {
    if (!communeSelect || !newCommuneGroup) return;
    const show = (communeSelect.value === '' || communeSelect.value === 'autre');
    newCommuneGroup.style.display = show ? 'block' : 'none';
    if (!show && newCommuneInput) newCommuneInput.value = '';
  }
  if (communeSelect) {
    toggleNewCommune();
    communeSelect.addEventListener('change', toggleNewCommune);
  }

  // -------- fetch JSON helper (anti-HTML) ----------
  async function fetchJSON(url, { method='GET', body=null } = {}) {
    const resp = await fetch(url, {
      method,
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
        ...(method !== 'GET' ? {'X-CSRFToken': CSRF} : {}),
      },
      body,
      credentials: 'same-origin',
      redirect: 'follow',
    });

    const ct = resp.headers.get('content-type') || '';
    const isJSON = ct.includes('application/json');

    if (resp.status === 401) {
      showAlert("Votre session a expiré. Veuillez vous reconnecter.", 'warning');
      return null;
    }
    if (resp.status === 403) {
      showAlert("Requête refusée (CSRF ou autorisations). Rechargez la page et réessayez.", 'danger');
      return null;
    }

    if (isJSON) {
      try {
        return await resp.json();
      } catch (e) {
        console.error("Parse JSON failed:", e);
        showAlert("Réponse JSON invalide du serveur.", 'danger');
        return null;
      }
    } else {
      const text = await resp.text();
      console.error("Réponse non-JSON:", resp.status, ct, text.slice(0, 800));
      showAlert("Réponse inattendue du serveur. Contactez l’admin si le problème persiste.", 'danger');
      return null;
    }
  }

  // Étape 1 → API
  async function submitStep1() {
    if (!validateRequired(patientForm)) {
      showAlert("Veuillez remplir tous les champs obligatoires du patient.", 'danger');
      const firstInvalid = patientForm.querySelector('.is-invalid'); if (firstInvalid) firstInvalid.scrollIntoView({behavior:'smooth', block:'center'});
      return null;
    }
    const unlock = lock(nextStepBtn, 'Enregistrement du patient...');
    try {
      const formData = new FormData(patientForm);
      const data = await fetchJSON("{% url 'urgence_patient_api' %}", {
        method: 'POST',
        body: formData,
      });
      if (!data) return null;
      if (!data.ok) {
        applyFieldErrors(patientForm, data.errors);
        showAlert("Erreur lors de l’enregistrement du patient.", 'danger');
        return null;
      }
      showAlert(data.detail || "Patient enregistré.", 'success');
      return data.patient_id;
    } catch (e) {
      console.error(e);
      showAlert("Une erreur réseau est survenue.", 'danger');
      return null;
    } finally {
      unlock();
    }
  }

  // Étape 2 → API
  async function submitStep2(pid) {
    if (!validateRequired(hospitalizationForm)) {
      showAlert("Veuillez remplir tous les champs obligatoires de l’hospitalisation.", 'danger');
      return false;
    }
    const unlock = lock(submitAllBtn, "Finalisation de l'admission...");
    try {
      const fd = new FormData(hospitalizationForm);
      const url = "{% url 'urgence_hosp_api' 999999 %}".replace('999999', String(pid));
      const data = await fetchJSON(url, { method: 'POST', body: fd });
      if (!data) return false;
      if (!data.ok) {
        applyFieldErrors(hospitalizationForm, data.errors);
        showAlert("Erreur lors de la création de l’hospitalisation.", 'danger');
        return false;
      }
      showAlert(data.detail || "Admission créée.", 'success');
      setTimeout(() => { window.location.href = data.redirect; }, 1200);
      return true;
    } catch (e) {
      console.error(e);
      showAlert("Une erreur réseau est survenue.", 'danger');
      return false;
    } finally {
      unlock();
    }
  }

  // Bouton “Suivant”
  nextStepBtn.addEventListener('click', async () => {
    if (!patientId) {
      const pid = await submitStep1();
      if (!pid) return;
      patientId = pid;
    }
    // bascule UI → étape 2
    step1.style.display = 'none';
    step2.style.display = 'block';
    document.getElementById('step1-indicator').classList.remove('active');
    document.getElementById('step1-indicator').classList.add('completed');
    document.getElementById('step2-indicator').classList.add('active');
    progressBar.style.width = '100%';
    updatePatientSummary();
  });

  // “Sauvegarder patient”
  savePatientBtn.addEventListener('click', async () => {
    if (!patientId) {
      const pid = await submitStep1();
      if (pid) patientId = pid;
    } else {
      showAlert("Patient déjà enregistré.", 'info');
    }
  });

  // “Finaliser l’admission”
  submitAllBtn.addEventListener('click', async () => {
    if (!patientId) {
      const pid = await submitStep1();
      if (!pid) return;
      patientId = pid;
    }
    await submitStep2(patientId);
  });

  // Retour étape 1
  prevStepBtn.addEventListener('click', () => {
    step2.style.display = 'none';
    step1.style.display = 'block';
    document.getElementById('step2-indicator').classList.remove('active');
    const s1 = document.getElementById('step1-indicator');
    s1.classList.add('active'); s1.classList.remove('completed');
    progressBar.style.width = '0%';
  });

  // Initialiser la date/heure courante sur le champ admission_date s'il existe
  const admissionInputId = "{{ step2_form.admission_date.auto_id|default_if_none:'' }}";
  const admissionDateInput = admissionInputId ? document.getElementById(admissionInputId) : null;
  if (admissionDateInput && !admissionDateInput.value) {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth()+1).padStart(2,'0');
    const day = String(now.getDate()).padStart(2,'0');
    const hours = String(now.getHours()).padStart(2,'0');
    const minutes = String(now.getMinutes()).padStart(2,'0');
    admissionDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
  }

  // Optionnel: catcher les promesses non gérées
  window.addEventListener('unhandledrejection', (e) => {
    console.error('Unhandled promise rejection:', e.reason);
  });
});
</script>
{#<script>#}
{#document.addEventListener('DOMContentLoaded', function () {#}
{#  // éléments#}
{#  const step1 = document.getElementById('step1');#}
{#  const step2 = document.getElementById('step2');#}
{#  const patientForm = document.getElementById('patient-form');#}
{#  const hospitalizationForm = document.getElementById('hospitalization-form');#}
{#  const savePatientBtn = document.getElementById('save-patient-btn');#}
{#  const submitAllBtn = document.getElementById('submit-all-btn');#}
{#  const nextStepBtn = document.getElementById('next-step-btn');#}
{#  const prevStepBtn = document.getElementById('prev-step-btn');#}
{#  const progressBar = document.getElementById('progress-bar');#}
{#  const patientSummary = document.getElementById('patient-summary');#}
{##}
{#  let patientId = null;  // ID créé à l’étape 1#}
{##}
{#  // IDs sûrs depuis le form Django#}
{#  const communeId = "{{ form.commune.auto_id|default_if_none:'' }}";#}
{#  const nouvelleCommuneId = "{{ form.nouvelle_commune.auto_id|default_if_none:'' }}";#}
{#  const communeSelect = communeId ? document.getElementById(communeId) : null;#}
{#  const newCommuneGroup = document.getElementById('new_commune_group');#}
{#  const newCommuneInput = nouvelleCommuneId ? document.getElementById(nouvelleCommuneId) : null;#}
{##}
{#  // CSRF#}
{#  function getCSRFToken() {#}
{#    const name = 'csrftoken';#}
{#    const cookies = document.cookie.split(';');#}
{#    for (let c of cookies) {#}
{#      c = c.trim();#}
{#      if (c.startsWith(name + '=')) return c.substring(name.length + 1);#}
{#    }#}
{#    const input = document.querySelector('input[name=csrfmiddlewaretoken]');#}
{#    return input ? input.value : '';#}
{#  }#}
{#  const CSRF = getCSRFToken();#}
{##}
{#  // Helpers#}
{#  function lock(btn, loadingText='Traitement...') {#}
{#    if (!btn) return () => {};#}
{#    const original = btn.innerHTML;#}
{#    btn.disabled = true;#}
{#    btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>${loadingText}`;#}
{#    return () => { btn.disabled = false; btn.innerHTML = original; };#}
{#  }#}
{##}
{#  function showAlert(message, type='info') {#}
{#    const alertDiv = document.createElement('div');#}
{#    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;#}
{#    alertDiv.innerHTML = `#}
{#      ${message}#}
{#      <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>#}
{#    `;#}
{#    document.querySelector('.nk-content-body').insertBefore(alertDiv, document.querySelector('.nk-block'));#}
{#    setTimeout(() => alertDiv.remove(), 6000);#}
{#  }#}
{##}
{#  function applyFieldErrors(formEl, errors) {#}
{#    // nettoie#}
{#    formEl.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));#}
{#    formEl.querySelectorAll('.invalid-feedback.dynamic').forEach(e => e.remove());#}
{#    // applique#}
{#    Object.entries(errors || {}).forEach(([name, msgs]) => {#}
{#      const field = formEl.querySelector(`[name="${name}"]`);#}
{#      if (field) {#}
{#        field.classList.add('is-invalid');#}
{#        const fb = document.createElement('div');#}
{#        fb.className = 'invalid-feedback dynamic d-block';#}
{#        fb.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i>${(Array.isArray(msgs)?msgs.join('<br>'):msgs)}`;#}
{#        field.closest('.form-group')?.appendChild(fb);#}
{#      }#}
{#    });#}
{#  }#}
{##}
{#  function validateRequired(formEl) {#}
{#    const required = formEl.querySelectorAll('[required]');#}
{#    let ok = true;#}
{#    required.forEach(f => {#}
{#      if (!f.value || !f.value.trim()) {#}
{#        f.classList.add('is-invalid'); ok = false;#}
{#      } else {#}
{#        f.classList.remove('is-invalid'); f.classList.add('is-valid');#}
{#      }#}
{#    });#}
{#    return ok;#}
{#  }#}
{##}
{#  function updatePatientSummary() {#}
{#    const fd = new FormData(patientForm);#}
{#    const bloc = `#}
{#      <div class="col-12 col-md-6">#}
{#        <div class="patient-summary-item"><strong>Nom complet:</strong><br>${fd.get('nom') || ''} ${fd.get('prenoms') || ''}</div>#}
{#        <div class="patient-summary-item"><strong>Contact:</strong><br>${fd.get('contact') || ''}</div>#}
{#        <div class="patient-summary-item"><strong>Genre:</strong><br>${fd.get('genre') || ''}</div>#}
{#      </div>#}
{#      <div class="col-12 col-md-6">#}
{#        <div class="patient-summary-item"><strong>Date de naissance:</strong><br>${fd.get('date_naissance') || ''}</div>#}
{#        <div class="patient-summary-item"><strong>Groupe sanguin:</strong><br>${fd.get('groupe_sanguin') || 'Non renseigné'}</div>#}
{#        <div class="patient-summary-item"><strong>Nationalité:</strong><br>${fd.get('nationalite') || 'Non renseigné'}</div>#}
{#      </div>#}
{#    `;#}
{#    patientSummary.innerHTML = bloc;#}
{#  }#}
{##}
{#  function toggleNewCommune() {#}
{#    if (!communeSelect || !newCommuneGroup) return;#}
{#    const show = (communeSelect.value === '' || communeSelect.value === 'autre');#}
{#    newCommuneGroup.style.display = show ? 'block' : 'none';#}
{#    if (!show && newCommuneInput) newCommuneInput.value = '';#}
{#  }#}
{#  if (communeSelect) {#}
{#    toggleNewCommune();#}
{#    communeSelect.addEventListener('change', toggleNewCommune);#}
{#  }#}
{##}
{#  // Étape 1 → API#}
{#  async function submitStep1() {#}
{#    if (!validateRequired(patientForm)) {#}
{#      showAlert("Veuillez remplir tous les champs obligatoires du patient.", 'danger');#}
{#      const firstInvalid = patientForm.querySelector('.is-invalid'); if (firstInvalid) firstInvalid.scrollIntoView({behavior:'smooth', block:'center'});#}
{#      return null;#}
{#    }#}
{#    const unlock = lock(nextStepBtn, 'Enregistrement du patient...');#}
{#    try {#}
{#      const formData = new FormData(patientForm);#}
{#      const resp = await fetch("{% url 'urgence_patient_api' %}", {#}
{#        method: 'POST',#}
{#        headers: {'X-CSRFToken': CSRF},#}
{#        body: formData,#}
{#      });#}
{#      const data = await resp.json();#}
{#      if (!resp.ok || !data.ok) {#}
{#        applyFieldErrors(patientForm, data.errors);#}
{#        showAlert("Erreur lors de l’enregistrement du patient.", 'danger');#}
{#        return null;#}
{#      }#}
{#      showAlert(data.detail || "Patient enregistré.", 'success');#}
{#      return data.patient_id;#}
{#    } catch (e) {#}
{#      console.error(e);#}
{#      showAlert("Une erreur réseau est survenue.", 'danger');#}
{#      return null;#}
{#    } finally {#}
{#      unlock();#}
{#    }#}
{#  }#}
{##}
{#  // Étape 2 → API#}
{#  async function submitStep2(pid) {#}
{#    if (!validateRequired(hospitalizationForm)) {#}
{#      showAlert("Veuillez remplir tous les champs obligatoires de l’hospitalisation.", 'danger');#}
{#      return false;#}
{#    }#}
{#    const unlock = lock(submitAllBtn, "Finalisation de l'admission...");#}
{#    try {#}
{#      const fd = new FormData(hospitalizationForm);#}
{#      const url = "{% url 'urgence_hosp_api' 999999 %}".replace('999999', String(pid));#}
{#      const resp = await fetch(url, {#}
{#        method: 'POST',#}
{#        headers: {'X-CSRFToken': CSRF},#}
{#        body: fd,#}
{#      });#}
{#      const data = await resp.json();#}
{#      if (!resp.ok || !data.ok) {#}
{#        applyFieldErrors(hospitalizationForm, data.errors);#}
{#        showAlert("Erreur lors de la création de l’hospitalisation.", 'danger');#}
{#        return false;#}
{#      }#}
{#      showAlert(data.detail || "Admission créée.", 'success');#}
{#      setTimeout(() => { window.location.href = data.redirect; }, 1200);#}
{#      return true;#}
{#    } catch (e) {#}
{#      console.error(e);#}
{#      showAlert("Une erreur réseau est survenue.", 'danger');#}
{#      return false;#}
{#    } finally {#}
{#      unlock();#}
{#    }#}
{#  }#}
{##}
{#  // Bouton “Suivant”#}
{#  nextStepBtn.addEventListener('click', async () => {#}
{#    if (!patientId) {#}
{#      const pid = await submitStep1();#}
{#      if (!pid) return;#}
{#      patientId = pid;#}
{#    }#}
{#    // bascule UI → étape 2#}
{#    step1.style.display = 'none';#}
{#    step2.style.display = 'block';#}
{#    document.getElementById('step1-indicator').classList.remove('active');#}
{#    document.getElementById('step1-indicator').classList.add('completed');#}
{#    document.getElementById('step2-indicator').classList.add('active');#}
{#    progressBar.style.width = '100%';#}
{#    updatePatientSummary();#}
{#  });#}
{##}
{#  // “Sauvegarder patient”#}
{#  savePatientBtn.addEventListener('click', async () => {#}
{#    if (!patientId) {#}
{#      const pid = await submitStep1();#}
{#      if (pid) patientId = pid;#}
{#    } else {#}
{#      showAlert("Patient déjà enregistré.", 'info');#}
{#    }#}
{#  });#}
{##}
{#  // “Finaliser l’admission”#}
{#  submitAllBtn.addEventListener('click', async () => {#}
{#    if (!patientId) {#}
{#      const pid = await submitStep1();#}
{#      if (!pid) return;#}
{#      patientId = pid;#}
{#    }#}
{#    await submitStep2(patientId);#}
{#  });#}
{##}
{#  // Retour étape 1#}
{#  prevStepBtn.addEventListener('click', () => {#}
{#    step2.style.display = 'none';#}
{#    step1.style.display = 'block';#}
{#    document.getElementById('step2-indicator').classList.remove('active');#}
{#    const s1 = document.getElementById('step1-indicator');#}
{#    s1.classList.add('active'); s1.classList.remove('completed');#}
{#    progressBar.style.width = '0%';#}
{#  });#}
{##}
{#  // Initialiser la date/heure courante sur le champ admission_date s'il existe#}
{#  const admissionInputId = "{{ step2_form.admission_date.auto_id|default_if_none:'' }}";#}
{#  const admissionDateInput = admissionInputId ? document.getElementById(admissionInputId) : null;#}
{#  if (admissionDateInput && !admissionDateInput.value) {#}
{#    const now = new Date();#}
{#    const year = now.getFullYear();#}
{#    const month = String(now.getMonth()+1).padStart(2,'0');#}
{#    const day = String(now.getDate()).padStart(2,'0');#}
{#    const hours = String(now.getHours()).padStart(2,'0');#}
{#    const minutes = String(now.getMinutes()).padStart(2,'0');#}
{#    admissionDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;#}
{#  }#}
{#});#}
{#</script>#}
{% endblock %}