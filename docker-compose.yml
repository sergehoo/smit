networks:
  smitci_network:
    driver: bridge
  proxy:
    external: true

volumes:
  pgdata:
  static_volume:
  media_volume:
  # redis_data:   # décommente si tu veux persister Redis

x-logging-rotated: &logging_rotated
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-deploy-limits: &deploy_limits
  resources:
    limits:
      cpus: "1.5"
      memory: 1024M
    reservations:
      cpus: "0.5"
      memory: 512M

services:
  smitDB:
    image: postgis/postgis:16-3.4
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DATABASE_NAME}
      POSTGRES_USER: ${DATABASE_USER}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      # PGDATA: /var/lib/postgresql/data   # emplacement par défaut
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks: [smitci_network]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB -h 127.0.0.1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
    logging: *logging_rotated
    deploy: *deploy_limits

  redis:
    image: redis:7
    restart: unless-stopped
    command: ["redis-server","--appendonly","yes","--appendfsync","everysec","--save","900 1"]
    networks: [smitci_network]
    # volumes:
    #   - redis_data:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -h 127.0.0.1 ping | grep PONG >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
    logging: *logging_rotated
    deploy: *deploy_limits

  smitweb:
    build:
      context: .
      dockerfile: Dockerfile
    # sobres en RAM : 1 worker / 4 threads, tmp en mémoire
    command: >
      gunicorn smitci.wsgi:application
      --bind 0.0.0.0:8000
      --workers 1 --threads 4
      --worker-tmp-dir /dev/shm
      --max-requests 800 --max-requests-jitter 200
      --timeout 180 --graceful-timeout 60
      --keep-alive 5
      --log-level info
      --error-logfile - --access-logfile -
      --capture-output
    env_file: [.env]
    environment:
      RUN_MIGRATIONS: "0"
      RUN_COLLECTSTATIC: "0"
      DJANGO_SETTINGS_MODULE: smitci.settings
      PYTHONUNBUFFERED: "1"
      WHITENOISE_MAX_AGE: "2592000"   # 30 jours
      WHITENOISE_USE_FINDERS: "False"
    volumes:
      - static_volume:/smitci-app/static
      - media_volume:/smitci-app/media
    depends_on:
      smitDB:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks: [smitci_network, proxy]
    init: true
    # ⚠️ PAS de healthcheck ici => plus de requêtes /healthz qui polluent les logs
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy

      # Router public HTTPS
      - traefik.http.routers.smitci.rule=Host(`${SMITCI_HOST}`)
      - traefik.http.routers.smitci.entrypoints=websecure
      - traefik.http.routers.smitci.tls=true
      - traefik.http.routers.smitci.tls.certresolver=lets
      - traefik.http.routers.smitci.service=smitci-svc

      # Service amont HTTP:8000
      - traefik.http.services.smitci-svc.loadbalancer.server.port=8000
      - traefik.http.services.smitci-svc.loadbalancer.server.scheme=http

      # Healthcheck Traefik (interne, silencieux pour Gunicorn)
#      - traefik.http.services.smitci-svc.loadbalancer.healthcheck.path=/healthz
#      - traefik.http.services.smitci-svc.loadbalancer.healthcheck.interval=30s
#      - traefik.http.services.smitci-svc.loadbalancer.healthcheck.timeout=5s
#      - traefik.http.services.smitci-svc.loadbalancer.healthcheck.headers.Host=${SMITCI_HOST}

      # Middlewares (headers, compression, rate-limit)
      - traefik.http.routers.smitci.middlewares=smitci-sec-headers@docker,smitci-compress@docker,smitci-rl@docker
      - traefik.http.middlewares.smitci-sec-headers.headers.stsSeconds=31536000
      - traefik.http.middlewares.smitci-sec-headers.headers.stsIncludeSubdomains=true
      - traefik.http.middlewares.smitci-sec-headers.headers.stsPreload=true
      - traefik.http.middlewares.smitci-sec-headers.headers.contentTypeNosniff=true
      - traefik.http.middlewares.smitci-sec-headers.headers.frameDeny=true
      - traefik.http.middlewares.smitci-sec-headers.headers.referrerPolicy=strict-origin-when-cross-origin
      - traefik.http.middlewares.smitci-compress.compress=true
      - traefik.http.middlewares.smitci-rl.ratelimit.average=150
      - traefik.http.middlewares.smitci-rl.ratelimit.burst=250
    logging: *logging_rotated
    deploy: *deploy_limits

  celeryworker:
    build:
      context: .
      dockerfile: Dockerfile
    command: >
      celery -A smitci worker
      --loglevel=warning
      --concurrency=2
      --prefetch-multiplier=1 -Ofair
      --max-tasks-per-child=200
      --without-gossip --without-mingle
    env_file: [.env]
    depends_on:
      smitDB:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks: [smitci_network]
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -h redis ping | grep PONG >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
    logging: *logging_rotated
    deploy: *deploy_limits

  celerybeat:
    build:
      context: .
      dockerfile: Dockerfile
    command: >
      celery -A smitci beat
      --loglevel=warning
      --scheduler django_celery_beat.schedulers:DatabaseScheduler
      --pidfile=/tmp/celerybeat.pid
    env_file: [.env]
    depends_on:
      smitDB:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks: [smitci_network]
    logging: *logging_rotated
    deploy: *deploy_limits

  smitadminer:
    profiles: ["admin"]
    image: adminer
    restart: unless-stopped
    environment:
      ADMINER_DEFAULT_SERVER: smitDB
    depends_on:
      smitDB:
        condition: service_healthy
    networks: [smitci_network, proxy]
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.smitadminer.rule=Host(`adminer.${SMITCI_HOST}`)
      - traefik.http.routers.smitadminer.entrypoints=websecure
      - traefik.http.routers.smitadminer.tls=true
      - traefik.http.routers.smitadminer.tls.certresolver=lets
      - traefik.http.services.smitadminer.loadbalancer.server.port=8080
      - traefik.http.services.smitadminer.loadbalancer.server.scheme=http
    logging: *logging_rotated
    deploy: *deploy_limits
#networks:
#  smitci_network:
#    driver: bridge
#  proxy:
#    external: true   # réseau Traefik (uniquement pour smitweb/adminer)
#
#volumes:
#  pgdata:
#  static_volume:
#  media_volume:
#  torch_cache:
#
#services:
#  smitDB:
#    image: postgis/postgis:16-3.4
#    restart: unless-stopped
#    environment:
#      POSTGRES_DB: ${DATABASE_NAME}
#      POSTGRES_USER: ${DATABASE_USER}
#      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
#      PG_DATA: /data
#    volumes:
#      - pgdata:/var/lib/postgresql/data
#    networks: [smitci_network]
#    healthcheck:
#      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB || exit 1"]
#      interval: 10s
#      timeout: 5s
#      retries: 10
#
#  redis:
#    image: redis:7
#    restart: unless-stopped
#    command: ["redis-server", "--appendonly", "yes", "--appendfsync", "everysec", "--save", "900 1"]
#    networks: [smitci_network]
#    healthcheck:
#      test: ["CMD-SHELL", "redis-cli -h 127.0.0.1 ping | grep PONG >/dev/null 2>&1 || exit 1"]
#      interval: 10s
#      timeout: 5s
#      retries: 10
#
#  smitweb:
#    build:
#      context: .
#      dockerfile: Dockerfile
#    command: >
#      gunicorn smitci.wsgi:application
#      --bind 0.0.0.0:8000
#      --workers 2 --threads 2
#      --timeout 60
#      --log-level warning
#    env_file: [.env]
#    environment:
#      RUN_MIGRATIONS: "1"
#      RUN_COLLECTSTATIC: "1"
#    volumes:
#      - .:/smitci-app
#      - static_volume:/smitci-app/static
#      - media_volume:/smitci-app/media
#      - torch_cache:/root/.cache/torch
#    depends_on:
#      smitDB:
#        condition: service_healthy
#      redis:
#        condition: service_healthy
#    restart: unless-stopped
#    networks: [smitci_network, proxy]
#    # Healthcheck SANS curl (python inline)
#    healthcheck:
#      test:
#        [
#          "CMD-SHELL",
#          "python -c \"import urllib.request,sys; sys.exit(0) if urllib.request.urlopen('http://127.0.0.1:8000/healthz', timeout=2).status==200 else sys.exit(1)\""
#        ]
#      interval: 10s
#      timeout: 3s
#      retries: 12
#      start_period: 40s
#    labels:
#      - traefik.enable=true
#      - traefik.docker.network=proxy
#
#      # Router public HTTPS (host dans .env : SMITCI_HOST=smitci.com)
#      - traefik.http.routers.smitci.rule=Host(`${SMITCI_HOST}`)
#      - traefik.http.routers.smitci.entrypoints=websecure
#      - traefik.http.routers.smitci.tls=true
#      - traefik.http.routers.smitci.tls.certresolver=lets
#      - traefik.http.routers.smitci.service=smitci-svc
#
#      # Service amont HTTP:8000
#      - traefik.http.services.smitci-svc.loadbalancer.server.port=8000
#      - traefik.http.services.smitci-svc.loadbalancer.server.scheme=http
#
#      # Middlewares (optionnels si déjà globalement définis)
#      - traefik.http.routers.smitci.middlewares=smitci-sec-headers@docker,smitci-compress@docker,smitci-rl@docker
#      - traefik.http.middlewares.smitci-sec-headers.headers.stsSeconds=31536000
#      - traefik.http.middlewares.smitci-sec-headers.headers.stsIncludeSubdomains=true
#      - traefik.http.middlewares.smitci-sec-headers.headers.stsPreload=true
#      - traefik.http.middlewares.smitci-sec-headers.headers.contentTypeNosniff=true
#      - traefik.http.middlewares.smitci-sec-headers.headers.frameDeny=true
#      - traefik.http.middlewares.smitci-sec-headers.headers.referrerPolicy=strict-origin-when-cross-origin
#      - traefik.http.middlewares.smitci-compress.compress=true
#      - traefik.http.middlewares.smitci-rl.ratelimit.average=150
#      - traefik.http.middlewares.smitci-rl.ratelimit.burst=250
#
#  celeryworker:
#    build:
#      context: .
#      dockerfile: Dockerfile
#    command: >
#      celery -A smitci worker
#      --loglevel=warning
#      --concurrency=1 --autoscale=2,1
#      --prefetch-multiplier=1 -Ofair
#      --max-tasks-per-child=100
#      --without-gossip --without-mingle
#    env_file: [.env]
#    volumes:
#      - .:/smitci-app
#    depends_on:
#      smitDB:
#        condition: service_healthy
#      redis:
#        condition: service_healthy
#    restart: unless-stopped
#    networks: [smitci_network]
#
#  celerybeat:
#    build:
#      context: .
#      dockerfile: Dockerfile
#    command: >
#      celery -A smitci beat
#      --loglevel=warning
#      --scheduler django_celery_beat.schedulers:DatabaseScheduler
#    env_file: [.env]
#    volumes:
#      - .:/smitci-app
#    depends_on:
#      smitDB:
#        condition: service_healthy
#      redis:
#        condition: service_healthy
#    restart: unless-stopped
#    networks: [smitci_network]
#
#  smitadminer:
#    profiles: ["admin"]
#    image: adminer
#    restart: unless-stopped
#    environment:
#      ADMINER_DEFAULT_SERVER: smitDB
#    depends_on:
#      smitDB:
#        condition: service_healthy
#    networks: [smitci_network, proxy]
#    labels:
#      - traefik.enable=false
#      - traefik.docker.network=proxy
#      - traefik.http.routers.smitadminer.rule=Host(`adminer.smitci.com`)
#      - traefik.http.routers.smitadminer.entrypoints=websecure
#      - traefik.http.routers.smitadminer.tls.certresolver=lets
#      - traefik.http.services.smitadminer.loadbalancer.server.port=8080
#      - traefik.http.services.smitadminer.loadbalancer.server.scheme=http
#      - traefik.http.routers.smitadminer.middlewares=traefik-auth@docker,sec-headers@docker,compress@docker,ratelimit@docker
